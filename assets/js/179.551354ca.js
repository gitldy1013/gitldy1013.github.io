(window.webpackJsonp=window.webpackJsonp||[]).push([[179],{874:function(s,e,a){"use strict";a.r(e);var n=a(5),r=Object(n.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"eureka集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#eureka集群"}},[s._v("#")]),s._v(" Eureka集群")]),s._v(" "),a("p",[s._v("没有集群带来的高可用，会带来单点故障")]),s._v(" "),a("h2",{attrs:{id:"eureka工作原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#eureka工作原理"}},[s._v("#")]),s._v(" Eureka工作原理")]),s._v(" "),a("ul",[a("li",[s._v("服务注册：将服务信息注册进注册中心")]),s._v(" "),a("li",[s._v("服务发现：从注册中心上获取服务信息")]),s._v(" "),a("li",[s._v("实质：存key服务命名，取value调用地址")])]),s._v(" "),a("ol",[a("li",[s._v("先启动eureka注册中心")]),s._v(" "),a("li",[s._v("启动服务提供者payment支付服务")]),s._v(" "),a("li",[s._v("支付服务启动后，会把自身信息（比如 服务地址以别名方式注册进eureka）")]),s._v(" "),a("li",[s._v("消费者order服务在调用接口时候使用服务别名去注册中心获取实际的RPC远程调用地址")]),s._v(" "),a("li",[s._v("消费者获得调用地址后，底层实际是利用HttpClient技术实现远程调用")]),s._v(" "),a("li",[s._v("消费者获取服务地址后会缓存在本地JVM内存中，默认每隔30秒更新一次服务调用地址")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20200407214336639.png",alt:"image-20200407214336639"}})]),s._v(" "),a("p",[s._v("微服务RPC远程调用最核心的就是：高可用")]),s._v(" "),a("p",[s._v("因为假设注册中心只有一个，如果出现了故障，那么将会导致整个微服务不可用，所以需要搭建Eureka注册中心集群，实现负载均衡 + 故障容错")]),s._v(" "),a("h2",{attrs:{id:"eureka集群原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#eureka集群原理"}},[s._v("#")]),s._v(" Eureka集群原理")]),s._v(" "),a("p",[s._v("互相注册，相互守望")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20200407214903319.png",alt:"image-20200407214903319"}})]),s._v(" "),a("h2",{attrs:{id:"搭建集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#搭建集群"}},[s._v("#")]),s._v(" 搭建集群")]),s._v(" "),a("p",[s._v("原来单机版本时，我们的注册中心的配置文件为")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server:\n  port: 7001\neureka:\n  instance:\n    hostname: localhost #eureka服务端实例名称\n  client:\n    register-with-eureka: false #表示不向注册中心注册自己\n    fetch-registry: false #false表示自己就是注册中心，我的职责就是维护服务实例,并不区检索服务\n    service-url:\n      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("但是如果使用了集群后，我们的eureka就需要相互注册了，也就是 7001的需要注册到7002, 而7002注册7001")]),s._v(" "),a("p",[s._v("同时 hostname也不能重复，需要有两个主机的ip")]),s._v(" "),a("p",[s._v("eureka 7001")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server:\n  port: 7001\neureka:\n  instance:\n    hostname: eureka7001.com #eureka服务端实例名称\n  client:\n    register-with-eureka: false #表示不向注册中心注册自己\n    fetch-registry: false #false表示自己就是注册中心，我的职责就是维护服务实例,并不区检索服务\n    service-url:\n      # 向另外一个eureka服务注册\n      defaultZone: http://eureka7002.com:7002/eureka/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("eureka 7002:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server:\n  port: 7002\neureka:\n  instance:\n    hostname: eureka7002.com #eureka服务端实例名称\n  client:\n    register-with-eureka: false #表示不向注册中心注册自己\n    fetch-registry: false #false表示自己就是注册中心，我的职责就是维护服务实例,并不区检索服务\n    service-url:\n      # 向另外一个eureka服务注册\n      defaultZone: http://eureka7001.com:7001/eureka/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("启动后，我们能发现，在eureka7001上，能看到7002注册上去了")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20200407215956351.png",alt:"image-20200407215956351"}})]),s._v(" "),a("p",[s._v("同时在eureka7002上，能看到7001，这个时候说明我们的eureka集群已经搭建完毕")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20200407220030972.png",alt:"image-20200407220030972"}})]),s._v(" "),a("h2",{attrs:{id:"服务注册eureka集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务注册eureka集群"}},[s._v("#")]),s._v(" 服务注册Eureka集群")]),s._v(" "),a("p",[s._v("我们修改服务提供者payment的yml配置，同时将两个eureka地址配置在defaultZone中")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("eureka:\n  client:\n    #表示向注册中心注册自己 默认为true\n    register-with-eureka: true\n    #是否从EurekaServer抓取已有的注册信息，默认为true,单节点无所谓,集群必须设置为true才能配合ribbon使用负载均衡\n    fetch-registry: true\n    service-url:\n      # 入驻地址\n      # defaultZone: http://localhost:7001/eureka/\n      #集群版\n      defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/\n  #服务名称\n  instance:\n    instance-id: payment8001\n    #访问路径显示IP地址\n    prefer-ip-address: true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("在上面的图中，我们能发现，payment服务已经成功注册到两台eureka集群中了")]),s._v(" "),a("h2",{attrs:{id:"服务提供者集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务提供者集群"}},[s._v("#")]),s._v(" 服务提供者集群")]),s._v(" "),a("p",[s._v("我们需要搭建多个服务提供者")]),s._v(" "),a("p",[s._v("例如：payment8001：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server:\n  port: 8001\n\nspring:\n  application:\n    name: cloud-payment-service #服务名称\n  datasource:\n    type: com.alibaba.druid.pool.DruidDataSource  #当前数据源操作类型\n    driver-class-name: com.mysql.jdbc.Driver\n    url: jdbc:mysql://localhost:3306/cloud2020?characterEncoding=utf8&useSSL=false&useUnicode=true\n    username: root\n    password: root\neureka:\n  client:\n    #表示向注册中心注册自己 默认为true\n    register-with-eureka: true\n    #是否从EurekaServer抓取已有的注册信息，默认为true,单节点无所谓,集群必须设置为true才能配合ribbon使用负载均衡\n    fetch-registry: true\n    service-url:\n      # 入驻地址\n      # defaultZone: http://localhost:7001/eureka/\n      #集群版\n      defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[s._v("和payment8002：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server:\n  port: 8002\n\nspring:\n  application:\n    name: cloud-payment-service #服务名称\n  zipkin:\n    base-url: http://localhost:9411\n  sleuth:\n    sampler:\n    # 采集率介于0到1之间，1表示全部采集\n      probability: 1\n  datasource:\n    type: com.alibaba.druid.pool.DruidDataSource  #当前数据源操作类型\n    driver-class-name: com.mysql.jdbc.Driver\n    url: jdbc:mysql://localhost:3306/cloud2020?characterEncoding=utf8&useSSL=false&useUnicode=true\n    username: root\n    password: root\neureka:\n  client:\n    #表示向注册中心注册自己 默认为true\n    register-with-eureka: true\n    #是否从EurekaServer抓取已有的注册信息，默认为true,单节点无所谓,集群必须设置为true才能配合ribbon使用负载均衡\n    fetch-registry: true\n    service-url:\n      # 入驻地址\n#       defaultZone: http://localhost:7001/eureka/\n      #集群版\n      defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/\n  #服务名称\n  instance:\n    instance-id: payment8001\n    #访问路径显示IP地址\n    prefer-ip-address: true\nmybatis:\n  mapper-locations: classpath:mapper/*.xml\n  type-aliases-package: com.atguigu.springcloud.entity  #所有entity别名所在包\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br")])]),a("p",[s._v("这里需要注意的就是，为了保证这两个服务，对外暴露的都是同一个服务提供者，我们的服务名需要保持一致")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("spring:\n  application:\n    name: cloud-payment-service #服务名称\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("启动后，我们发现CLOUD-PAYMENT_SERVICE上有两个服务提供者了，分别为：8001和8002")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20200407223634503.png",alt:"image-20200407223634503"}})]),s._v(" "),a("p",[s._v("同时我们需要服务名进行调用")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("http://CLOUD-PAYMENT_SERVICE\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("通知在RestTemplate需要设置负载均衡策略，即 @LoadBalanced注解，不然它不知道调用哪个微服务地址")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("@Configuration\npublic class ApplicationContextConfig {\n    @Bean\n    @LoadBalanced //赋予RestTemplate负载均衡的能力\n    public RestTemplate getRestTemplate() {\n        return new RestTemplate();\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("这个就是Rabbon的负载均衡功能，默认是轮询")]),s._v(" "),a("blockquote",[a("p",[s._v("Ribbon和Eureka整合后，Consumer可以直接调用服务而不再关心地址和端口号，且该服务还有负载均衡的功能")])]),s._v(" "),a("h2",{attrs:{id:"actuator微服务信息完善"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#actuator微服务信息完善"}},[s._v("#")]),s._v(" actuator微服务信息完善")]),s._v(" "),a("p",[s._v("要做图形化的展示这块，这两个依赖都需要导入")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("        \x3c!--web启动器--\x3e\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-web</artifactId>\n        </dependency>\n        \x3c!--监控--\x3e\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-actuator</artifactId>\n        </dependency>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("actuator：主要用于IP信息完善")]),s._v(" "),a("p",[s._v("actuator查看健康状态")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("http://192.168.80.1:8002/actuator/health\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"服务名称修改"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务名称修改"}},[s._v("#")]),s._v(" 服务名称修改")]),s._v(" "),a("p",[s._v("修改后，对外暴露的就是服务名称")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Erueka\n  #服务名称\n  instance:\n\t instance-id: payment8001\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"设置服务的ip显示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设置服务的ip显示"}},[s._v("#")]),s._v(" 设置服务的IP显示")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Erueka\n  #服务名称\n  instance:\n    #访问路径显示IP地址\n    prefer-ip-address: true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h2",{attrs:{id:"服务发现discovery"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务发现discovery"}},[s._v("#")]),s._v(" 服务发现Discovery")]),s._v(" "),a("p",[s._v("Eureka的新的注解标签 "),a("code",[s._v("@EurekaDiscovery")])]),s._v(" "),a("p",[s._v("对于注册进Eureka里面的微服务，可以通过服务发现来获得该服务的信息")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("@Resource\nprivate DiscoveryClient discoveryClient;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("获得服务列表")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# 获取列表\nList<String> services = discoveryClient.getServices();\n\n# 获取实例\nList<ServiceInstance> instances = discoveryClient.getInstances("CLOUD-PAYMENT-SERVICE");\n\n# 获取ServiceId\ninstances.get(0).getServiceId();\n\n# 获取主机名\ninstances.get(0).getHost();\n\n# 获取端口号\ninstances.get(0).getPort();\n\n# 获取URL\ninstances.get(0).getUrl();\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h2",{attrs:{id:"eureka自我保护机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#eureka自我保护机制"}},[s._v("#")]),s._v(" Eureka自我保护机制")]),s._v(" "),a("h3",{attrs:{id:"概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概念"}},[s._v("#")]),s._v(" 概念")]),s._v(" "),a("p",[s._v("保护模式主要用于一组客户端和Eureka Server之间存在网络分区场景下的保护，一旦进入保护模式，Eureka Server将会尝试保护其服务注册表的信息，不再删除服务注册表中的数据，也就是不会注销任何微服务。")]),s._v(" "),a("p",[s._v("如果在Eureka Server的首页看到以下这段提示，说明Eureka进入了保护模式")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20200407230432953.png",alt:"image-20200407230432953"}})]),s._v(" "),a("p",[s._v("通俗的话来说：某时刻某一个微服务不可用了，Eureka不会立刻清理，依旧会对该微服务的信息进行保存，属于CAP里面的AP分支。")]),s._v(" "),a("h3",{attrs:{id:"导致原因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#导致原因"}},[s._v("#")]),s._v(" 导致原因")]),s._v(" "),a("p",[s._v("默认情况下，如果EurekaServer在一定时间内没有接收到某个微服务实例的心跳，EurekaServer将会注销该实例，默认90秒。但是当网络分区故障发生（延时，卡顿，拥挤）时，微服务与EurekaServer之间无法正常通信，以上行为可能变得非常危险了- 因为微服务本身其实是健康的，此时不应该注销这个微服务，Eureka通过 自我保护模式 来解决这个问题，当EurekaServer节点在短时间丢失过多客户端，那么这个节点就会进入自我保护模式")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20200407230731783.png",alt:"image-20200407230731783"}})]),s._v(" "),a("p",[s._v("这是一种高可用的机制")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20200407231058929.png",alt:"image-20200407231058929"}})]),s._v(" "),a("p",[s._v("在自我保护模式下，Eureka Server会保护服务注册表中的信息，不在注销任何服务实例")]),s._v(" "),a("p",[s._v("它的设计哲学就是宁可保留错误的服务注册信息，也不盲目注销任何可能健康的服务实例")]),s._v(" "),a("p",[s._v("综上，自我保护模式是一种应对网络异常的安全保护措施，它的架构哲学是宁可保留所有微服务（健康的微服务和不健康的微服务都会保留）也不盲目注销任何健康的微服务。使用自我保护模式，可以让Eureka集群更加健壮，稳定。")]),s._v(" "),a("h3",{attrs:{id:"禁止自我保护"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#禁止自我保护"}},[s._v("#")]),s._v(" 禁止自我保护")]),s._v(" "),a("p",[s._v("Eureka默认开启自我保护")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("eureka:\n  server:\n    enable-self-preservation: true\n    peer-node-read-timeout-ms: 3000\n    peer-node-connect-timeout-ms: 3000\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("同时在客户端进行设置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("eureka:\n  instance:\n    # Eureka客户端向服务端发送心跳的时间间隔，单位为秒，默认30\n    lease-renewal-interval-in-seconds: 1\n    # Eureka服务端在收到最后一次心跳后等待时间上限，单位为秒，默认为90秒，超时将剔除服务\n    lease-expiration-duration-in-seconds: 2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("设置完成后，只要服务宕机，会马上从服务注册列表中清除")]),s._v(" "),a("h2",{attrs:{id:"关于eureka停更"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于eureka停更"}},[s._v("#")]),s._v(" 关于Eureka停更")]),s._v(" "),a("p",[s._v("Eureka停更后，出现了其它的替代者")]),s._v(" "),a("ul",[a("li",[s._v("Zookeeper")]),s._v(" "),a("li",[s._v("Consul")]),s._v(" "),a("li",[s._v("Nacos")])])])}),[],!1,null,null,null);e.default=r.exports}}]);