(window.webpackJsonp=window.webpackJsonp||[]).push([[131],{828:function(s,t,a){"use strict";a.r(t);var n=a(5),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"使用二进制方式搭建k8s集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用二进制方式搭建k8s集群"}},[s._v("#")]),s._v(" 使用二进制方式搭建K8S集群")]),s._v(" "),a("h2",{attrs:{id:"注意"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意"}},[s._v("#")]),s._v(" 注意")]),s._v(" "),a("p",[a("strong",[s._v("【暂时没有使用二进制方式搭建K8S集群，因此本章节内容不完整... 欢迎小伙伴能补充~】")])]),s._v(" "),a("h2",{attrs:{id:"准备工作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[s._v("#")]),s._v(" 准备工作")]),s._v(" "),a("p",[s._v("在开始之前，部署Kubernetes集群机器需要满足以下几个条件")]),s._v(" "),a("ul",[a("li",[s._v("一台或多台机器，操作系统CentOS 7.x")]),s._v(" "),a("li",[s._v("硬件配置：2GB ，2个CPU，硬盘30GB")]),s._v(" "),a("li",[s._v("集群中所有机器之间网络互通")]),s._v(" "),a("li",[s._v("可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像导入节点")]),s._v(" "),a("li",[s._v("禁止swap分区")])]),s._v(" "),a("h2",{attrs:{id:"步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#步骤"}},[s._v("#")]),s._v(" 步骤")]),s._v(" "),a("ul",[a("li",[s._v("创建多台虚拟机，安装Linux系统")]),s._v(" "),a("li",[s._v("操作系统的初始化")]),s._v(" "),a("li",[s._v("为etcd 和 apiserver 自签证书")]),s._v(" "),a("li",[s._v("部署etcd集群")]),s._v(" "),a("li",[s._v("部署master组件【安装docker、kube-apiserver、kube-controller-manager、kube-scheduler、etcd】")]),s._v(" "),a("li",[s._v("部署node组件【安装kubelet、kube-proxy、docker、etcd】")]),s._v(" "),a("li",[s._v("部署集群网络")])]),s._v(" "),a("h2",{attrs:{id:"准备虚拟机"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备虚拟机"}},[s._v("#")]),s._v(" 准备虚拟机")]),s._v(" "),a("p",[s._v("首先我们准备了两台虚拟机，来进行安装测试")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("主机名")]),s._v(" "),a("th",[s._v("ip")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("k8s_2_master")]),s._v(" "),a("td",[s._v("192.168.177.140")])]),s._v(" "),a("tr",[a("td",[s._v("k8s_2_node")]),s._v(" "),a("td",[s._v("192.168.177.141")])])])]),s._v(" "),a("h2",{attrs:{id:"操作系统的初始化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#操作系统的初始化"}},[s._v("#")]),s._v(" 操作系统的初始化")]),s._v(" "),a("p",[s._v("然后我们需要进行一些系列的初始化操作")]),s._v(" "),a("div",{staticClass:"language-shell script line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭防火墙")]),s._v("\nsystemctl stop firewalld\nsystemctl disable firewalld\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭selinux")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 永久关闭")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/enforcing/disabled/'")]),s._v(" /etc/selinux/config  \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 临时关闭")]),s._v("\nsetenforce "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭swap")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 临时")]),s._v("\nswapoff -a \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 永久关闭")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -ri "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/.*swap.*/#&/'")]),s._v(" /etc/fstab\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 根据规划设置主机名【master节点上操作】")]),s._v("\nhostnamectl set-hostname k8s_2_master\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 根据规划设置主机名【node1节点操作】")]),s._v("\nhostnamectl set-hostname k8s_2_node1\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在master添加hosts")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n192.168.177.140 k8s_2_master\n192.168.177.141 k8s_2_node1\nEOF")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将桥接的IPv4流量传递到iptables的链")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/sysctl.d/k8s.conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nEOF")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生效")]),s._v("\nsysctl --system  \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 时间同步")]),s._v("\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" ntpdate -y\nntpdate time.windows.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br")])]),a("h2",{attrs:{id:"部署etcd集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署etcd集群"}},[s._v("#")]),s._v(" 部署Etcd集群")]),s._v(" "),a("p",[s._v("Etcd是一个分布式键值存储系统，Kubernetes使用Etcd进行数据存储，所以先准备一个Etcd数据库，为了解决Etcd单点故障，应采用集群方式部署，这里使用3台组建集群，可容忍一台机器故障，当然也可以使用5台组件集群，可以容忍2台机器故障")]),s._v(" "),a("h3",{attrs:{id:"自签证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自签证书"}},[s._v("#")]),s._v(" 自签证书")]),s._v(" "),a("p",[s._v("提到证书，我们想到的就是下面这个情况")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20201113213116353.png",alt:"image-20201113213116353"}})]),s._v(" "),a("p",[s._v("这个https证书，其实就是服务器颁发给网站的，代表这是一个安全可信任的网站。")]),s._v(" "),a("p",[s._v("而在我们K8S集群的内部，其实也是有证书的，如果不带证书，那么访问就会受限")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20201113213353267.png",alt:"image-20201113213353267"}})]),s._v(" "),a("p",[s._v("同时在集群内部 和 外部的访问，我们也需要签发证书")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20201113213416013.png",alt:"image-20201113213416013"}})]),s._v(" "),a("p",[s._v("如果我们使用二进制的方式，那么就需要自己手动签发证书。")]),s._v(" "),a("p",[s._v("自签证书：我们可以想象成在一家公司上班，然后会颁发一个门禁卡，同时一般门禁卡有两种，一个是内部员工的门禁卡，和外部访客门禁卡。这两种门禁卡的权限可能不同，员工的门禁卡可以进入公司的任何地方，而访客的门禁卡是受限的，这个门禁卡其实就是自签证书")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/image-20201113214234194.png",alt:"image-20201113214234194"}})]),s._v(" "),a("h3",{attrs:{id:"准备cfssl证书生成工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备cfssl证书生成工具"}},[s._v("#")]),s._v(" 准备cfssl证书生成工具")]),s._v(" "),a("p",[s._v("cfssl是一个开源的证书管理工具，使用json文件生成证书，相比openssl 更方便使用。找任意一台服务器操作，这里用Master节点。")]),s._v(" "),a("div",{staticClass:"language-shell script line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://pkg.cfssl.org/R1.2/cfssl_linux-amd64\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" cfssl_linux-amd64 /usr/local/bin/cfssl\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" cfssljson_linux-amd64 /usr/local/bin/cfssljson\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);