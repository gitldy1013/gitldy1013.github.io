(window.webpackJsonp=window.webpackJsonp||[]).push([[464],{1160:function(s,a,e){"use strict";e.r(a);var n=e(5),l=Object(n.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"dockerfile-多阶段构建"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile-多阶段构建"}},[s._v("#")]),s._v(" Dockerfile 多阶段构建")]),s._v(" "),e("h2",{attrs:{id:"之前的做法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#之前的做法"}},[s._v("#")]),s._v(" 之前的做法")]),s._v(" "),e("p",[s._v("在 Docker 17.05 版本之前，我们构建 Docker 镜像时，通常会采用两种方式：")]),s._v(" "),e("h3",{attrs:{id:"全部放入一个-dockerfile"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#全部放入一个-dockerfile"}},[s._v("#")]),s._v(" 全部放入一个 Dockerfile")]),s._v(" "),e("p",[s._v("一种方式是将所有的构建过程编包含在一个 "),e("code",[s._v("Dockerfile")]),s._v(" 中，包括项目及其依赖库的编译、测试、打包等流程，这里可能会带来的一些问题：")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("Dockerfile")]),s._v(" 特别长，可维护性降低")]),s._v(" "),e("li",[s._v("镜像层次多，镜像体积较大，部署时间变长")]),s._v(" "),e("li",[s._v("源代码存在泄露的风险")])]),s._v(" "),e("p",[s._v("例如")]),s._v(" "),e("p",[s._v("编写 "),e("code",[s._v("app.go")]),s._v(" 文件，该程序输出 "),e("code",[s._v("Hello World!")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('    package main  \n    \n    import "fmt"  \n    \n    func main(){  \n        fmt.Printf("Hello World!");\n    }\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("编写 "),e("code",[s._v("Dockerfile.one")]),s._v(" 文件")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('    FROM golang:1.9-alpine\n    \n    RUN apk --no-cache add git ca-certificates\n    \n    WORKDIR /go/src/github.com/go/helloworld/\n    \n    COPY app.go .\n    \n    RUN go get -d -v github.com/go-sql-driver/mysql \\\n      && CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app . \\\n      && cp /go/src/github.com/go/helloworld/app /root\n    \n    WORKDIR /root/\n    \n    CMD ["./app"]\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[s._v("构建镜像")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    $ docker build -t go/helloworld:1 -f Dockerfile.one .\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"分散到多个-dockerfile"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#分散到多个-dockerfile"}},[s._v("#")]),s._v(" 分散到多个 Dockerfile")]),s._v(" "),e("p",[s._v("另一种方式，就是我们事先在一个 "),e("code",[s._v("Dockerfile")]),s._v(" 将项目及其依赖库编译测试打包好后，再将其拷贝到运行环境中，这种方式需要我们编写两个 "),e("code",[s._v("Dockerfile")]),s._v(" 和一些编译脚本才能将其两个阶段自动整合起来，这种方式虽然可以很好地规避第一种方式存在的风险，但明显部署过程较复杂。")]),s._v(" "),e("p",[s._v("例如")]),s._v(" "),e("p",[s._v("编写 "),e("code",[s._v("Dockerfile.build")]),s._v(" 文件")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    FROM golang:1.9-alpine\n    \n    RUN apk --no-cache add git\n    \n    WORKDIR /go/src/github.com/go/helloworld\n    \n    COPY app.go .\n    \n    RUN go get -d -v github.com/go-sql-driver/mysql \\\n      && CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("编写 "),e("code",[s._v("Dockerfile.copy")]),s._v(" 文件")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('    FROM alpine:latest\n    \n    RUN apk --no-cache add ca-certificates\n    \n    WORKDIR /root/\n    \n    COPY app .\n    \n    CMD ["./app"]\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("新建 "),e("code",[s._v("build.sh")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    #!/bin/sh\n    echo Building go/helloworld:build\n    \n    docker build -t go/helloworld:build . -f Dockerfile.build\n    \n    docker create --name extract go/helloworld:build\n    docker cp extract:/go/src/github.com/go/helloworld/app ./app\n    docker rm -f extract\n    \n    echo Building go/helloworld:2\n    \n    docker build --no-cache -t go/helloworld:2 . -f Dockerfile.copy\n    rm ./app\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("现在运行脚本即可构建镜像")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    $ chmod +x build.sh\n    \n    $ ./build.sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("对比两种方式生成的镜像大小")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    $ docker image ls\n    \n    REPOSITORY      TAG    IMAGE ID        CREATED         SIZE\n    go/helloworld   2      f7cf3465432c    22 seconds ago  6.47MB\n    go/helloworld   1      f55d3e16affc    2 minutes ago   295MB\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h2",{attrs:{id:"使用多阶段构建"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用多阶段构建"}},[s._v("#")]),s._v(" 使用多阶段构建")]),s._v(" "),e("p",[s._v("为解决以上问题，Docker v17.05 开始支持多阶段构建 ("),e("code",[s._v("multistage builds")]),s._v(")。使用多阶段构建我们就可以很容易解决前面提到的问题，并且只需要编写一个 "),e("code",[s._v("Dockerfile")]),s._v("：")]),s._v(" "),e("p",[s._v("例如")]),s._v(" "),e("p",[s._v("编写 "),e("code",[s._v("Dockerfile")]),s._v(" 文件")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('    FROM golang:1.9-alpine as builder\n    \n    RUN apk --no-cache add git\n    \n    WORKDIR /go/src/github.com/go/helloworld/\n    \n    RUN go get -d -v github.com/go-sql-driver/mysql\n    \n    COPY app.go .\n    \n    RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .\n    \n    FROM alpine:latest as prod\n    \n    RUN apk --no-cache add ca-certificates\n    \n    WORKDIR /root/\n    \n    COPY --from=0 /go/src/github.com/go/helloworld/app .\n    \n    CMD ["./app"]  \n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br")])]),e("p",[s._v("构建镜像")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    $ docker build -t go/helloworld:3 .\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("对比三个镜像大小")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    $ docker image ls\n    \n    REPOSITORY        TAG   IMAGE ID         CREATED            SIZE\n    go/helloworld     3     d6911ed9c846     7 seconds ago      6.47MB\n    go/helloworld     2     f7cf3465432c     22 seconds ago     6.47MB\n    go/helloworld     1     f55d3e16affc     2 minutes ago      295MB\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("很明显使用多阶段构建的镜像体积小，同时也完美解决了上边提到的问题。")]),s._v(" "),e("h3",{attrs:{id:"只构建某一阶段的镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#只构建某一阶段的镜像"}},[s._v("#")]),s._v(" 只构建某一阶段的镜像")]),s._v(" "),e("p",[s._v("我们可以使用 "),e("code",[s._v("as")]),s._v(" 来为某一阶段命名，例如")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    FROM golang:1.9-alpine as builder\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("例如当我们只想构建 "),e("code",[s._v("builder")]),s._v(" 阶段的镜像时，我们可以在使用 "),e("code",[s._v("docker build")]),s._v(" 命令时加上 "),e("code",[s._v("--target")]),s._v(" 参数即可")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    $ docker build --target builder -t username/imagename:tag .\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"构建时从其他镜像复制文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#构建时从其他镜像复制文件"}},[s._v("#")]),s._v(" 构建时从其他镜像复制文件")]),s._v(" "),e("p",[s._v("上面例子中我们使用 "),e("code",[s._v("COPY --from=0 /go/src/github.com/go/helloworld/app .")]),s._v(" 从上一阶段的镜像中复制文件，我们也可以复制任意镜像中的文件。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    $ COPY --from=nginx:latest /etc/nginx/nginx.conf /nginx.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])}),[],!1,null,null,null);a.default=l.exports}}]);