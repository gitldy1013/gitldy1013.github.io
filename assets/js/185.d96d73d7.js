(window.webpackJsonp=window.webpackJsonp||[]).push([[185],{880:function(s,a,n){"use strict";n.r(a);var t=n(5),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"分布式配置中心springcloudconfig"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分布式配置中心springcloudconfig"}},[s._v("#")]),s._v(" 分布式配置中心SpringCloudConfig")]),s._v(" "),n("h2",{attrs:{id:"概述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),n("h3",{attrs:{id:"面临的问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#面临的问题"}},[s._v("#")]),s._v(" 面临的问题")]),s._v(" "),n("p",[s._v("微服务意味着要将单体应用中的业务拆分成一个个子服务，每个服务的粒度相对较小，因此系统中会出现大量的服务，由于每个服务都需要必要的配置信息才能运行，所以一套集中式，动态的配置管理设施是必不可少的。")]),s._v(" "),n("p",[s._v("SpringCloud提供了ConfigServer来解决这个问题，原来四个微服务，需要配置四个application.yml，但需要四十个微服务，那么就需要配置40份配置文件，我们需要做的就是一处配置，到处生效。")]),s._v(" "),n("p",[s._v("所以这个时候就需要一个统一的配置管理")]),s._v(" "),n("h3",{attrs:{id:"是什么"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#是什么"}},[s._v("#")]),s._v(" 是什么")]),s._v(" "),n("p",[s._v("SpringCloud Config为微服务架构中的微服务提供集中化的外部配置支持，配置服务器为各个不同微服务应用提供了一个中心化的外部配置。")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200411220940452.png",alt:"image-20200411220940452"}})]),s._v(" "),n("h3",{attrs:{id:"怎么玩"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#怎么玩"}},[s._v("#")]),s._v(" 怎么玩")]),s._v(" "),n("p",[s._v("服务端也称为分布式配置中心，它是一个独立的微服务应用，用来连接配置服务器并为客户端提供获取配置信息，加密/解密信息等访问接口。")]),s._v(" "),n("p",[s._v("客户端则是通过指定的配置中心来管理应用资源，以及与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息，配置服务器默认采用git来存储配置信息，这样有助于对环境配置进行版本管理，并且可以通过git客户端工具来方便的管理和访问配置内容。")]),s._v(" "),n("h3",{attrs:{id:"能做什么"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#能做什么"}},[s._v("#")]),s._v(" 能做什么")]),s._v(" "),n("ul",[n("li",[s._v("集中管理配置文件")]),s._v(" "),n("li",[s._v("不同环境不同配置，动态化的配置更新，分布式部署，比如 dev/test/prod/beta/release")]),s._v(" "),n("li",[s._v("运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，服务会向配置中心统一拉取自己的信息")]),s._v(" "),n("li",[s._v("当配置发生变动时，服务不需要重启即可感知配置的变化并应用新的配置")]),s._v(" "),n("li",[s._v("将配置信息以REST接口的形式暴露：post，curl命令刷新")])]),s._v(" "),n("h3",{attrs:{id:"与github整合部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#与github整合部署"}},[s._v("#")]),s._v(" 与Github整合部署")]),s._v(" "),n("p",[s._v("由于SpringCloud Config默认使用Git来存储配置文件（也有其他方式，比如支持SVN和本地文件），但最推荐的还是Git，而且使用的是Http/https访问的形式")]),s._v(" "),n("h2",{attrs:{id:"config服务端配置与测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#config服务端配置与测试"}},[s._v("#")]),s._v(" Config服务端配置与测试")]),s._v(" "),n("h3",{attrs:{id:"引入依赖"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#引入依赖"}},[s._v("#")]),s._v(" 引入依赖")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\x3c!--添加消息总线Rabbitmq支持--\x3e\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-bus-amqp</artifactId>\n</dependency>\n\n\x3c!--config--\x3e\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-config-server</artifactId>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("h3",{attrs:{id:"修改yml"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改yml"}},[s._v("#")]),s._v(" 修改YML")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server:\n  port: 3344\nspring:\n  application:\n    name: cloud-config-center\n  cloud:\n    config:\n      server:\n        git:\n          uri: https://github.com/boytian/springcloud-config.git\n          search-paths:\n            - springcloud-config\n      label: master\n  rabbitmq: #mq相关配置\n    host: localhost\n    port: 5672\n    username: guest\n    password: guest\neureka:\n  client:\n    register-with-eureka: true\n    fetch-registry: true\n    service-url:\n      defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka\n# rabbitmq相关配置，暴露bus刷新点\nmanagement:\n  endpoints: #暴露bus刷新配置的端点\n    web:\n      exposure:\n        include: 'bus-refresh'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("h3",{attrs:{id:"配置读取规则"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置读取规则"}},[s._v("#")]),s._v(" 配置读取规则")]),s._v(" "),n("ul",[n("li",[s._v("/{label}/{application}-{profile}.yml\n"),n("ul",[n("li",[s._v("http://config-3344.com:3344/master/config-dev.yml")])])]),s._v(" "),n("li",[s._v("/{application}-{profile}.yml\n"),n("ul",[n("li",[s._v("http://config-3344.com:3344/config-dev.yml：如果不写的话，默认就是从master分支上找")])])])]),s._v(" "),n("h3",{attrs:{id:"参数总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参数总结"}},[s._v("#")]),s._v(" 参数总结")]),s._v(" "),n("p",[s._v("label：分支，branch")]),s._v(" "),n("p",[s._v("name：服务名")]),s._v(" "),n("p",[s._v("profiles：环境(dev/test/prod)")]),s._v(" "),n("h2",{attrs:{id:"config客户端配置与测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#config客户端配置与测试"}},[s._v("#")]),s._v(" Config客户端配置与测试")]),s._v(" "),n("h3",{attrs:{id:"引入依赖-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#引入依赖-2"}},[s._v("#")]),s._v(" 引入依赖")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\x3c!--添加消息总线Rabbitmq支持--\x3e\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-bus-amqp</artifactId>\n</dependency>\n\n\x3c!--config--\x3e\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-config</artifactId>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("h3",{attrs:{id:"bootstrap-yml"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#bootstrap-yml"}},[s._v("#")]),s._v(" bootstrap.yml")]),s._v(" "),n("p",[s._v("application.yml：是用户级的资源配置项")]),s._v(" "),n("p",[s._v("bootstrap.yml：是系统级别的，优先级更加高")]),s._v(" "),n("p",[s._v("Spring Cloud会创建一个Bootstrap Context，作为Spring应用的Application Context的父上下文。初始化的时候，Bootstrap Context负责从外部源加载配置属性并解析配置。这两个上下文共享一个从外部获取的Environment。")]),s._v(" "),n("p",[s._v("Bootstrap属性有高优先级，默认情况下，他们不会被本地配置覆盖，Bootstrap context 和 Application Context有着不同的约定，所以新增了一个bootstrap.yml文件，保证Bootstrap Context 和 Application Context配置的分离。")]),s._v(" "),n("p",[s._v("要将客户端Client模块下的Application.yml文件改成bootstrap.yml这是很关键的，因为bootstrap.yml是比application.yml先加载的，bootstrap.yml优先级高于application.yml")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('server:\n  port: 3355\nspring:\n  application:\n    name: config-client\n  cloud:\n    config:\n      label: master #分支名称\n      name: config #配置文件名称\n      profile: dev #读取后缀文件名，即 master分支config-dev.yml\n      uri: http://localhost:3344 #配置中心地址\n\neureka:\n  client:\n    register-with-eureka: true\n    fetch-registry: true\n    service-url:\n      defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka\n#暴露监控端点\nmanagement:\n  endpoints:\n    web:\n      exposure:\n        include: "*"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("h2",{attrs:{id:"存在的问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#存在的问题"}},[s._v("#")]),s._v(" 存在的问题")]),s._v(" "),n("p",[s._v("分布式配置的动态刷新问题？")]),s._v(" "),n("ul",[n("li",[s._v("Linux运维修改Github上的配置文件内容做调整")]),s._v(" "),n("li",[s._v("刷新3344，发现ConfigServer配置中心立刻响应")]),s._v(" "),n("li",[s._v("刷新3355，发现ConfigClient客户端没有任何响应")]),s._v(" "),n("li",[s._v("3355没有变化除非自己重启或者重启加载")]),s._v(" "),n("li",[s._v("难道每次运维修改后，都需要重启？")])]),s._v(" "),n("p",[s._v("相当于直接修改Github上的配置文件，配置不会改变，这个时候就存在了分布式配置的动态刷新问题")]),s._v(" "),n("h2",{attrs:{id:"config客户端之动态刷新"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#config客户端之动态刷新"}},[s._v("#")]),s._v(" Config客户端之动态刷新")]),s._v(" "),n("p",[s._v("为了避免每次更新配置都要重启客户端微服务3355")]),s._v(" "),n("h3",{attrs:{id:"引入了动态刷新"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#引入了动态刷新"}},[s._v("#")]),s._v(" 引入了动态刷新")]),s._v(" "),n("p",[s._v("引入actuator监控依赖")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\x3c!--web启动器--\x3e\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-web</artifactId>\n</dependency>\n\x3c!--监控--\x3e\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-actuator</artifactId>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("然后修改bootstrap.yml，暴露监控端点")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('#暴露监控端点\nmanagement:\n  endpoints:\n    web:\n      exposure:\n        include: "*"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("在业务类中，添加 "),n("code",[s._v("@RefreshScope")]),s._v("标签")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@RestController\n//实现刷新功能\n@RefreshScope\npublic class ConfigClientController {\n\n    @Value("${config.info}")\n    private String configInfo;\n\n    @GetMapping("/configInfo")\n    public String getConfigInfo(){\n        return configInfo;\n    }\n\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("然后让运维人员发送一个post请求")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('curl -X POST "http://localhost:3355/actuator/refresh"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("然后就能够生效了，成功刷新了配置，避免了服务重启")]),s._v(" "),n("p",[s._v("这个方案存在问题：")]),s._v(" "),n("ul",[n("li",[s._v("假设有多个微服务客户端 3355/ 3366 / 3377")]),s._v(" "),n("li",[s._v("每个微服务都要执行一次post请求，手动刷新？")]),s._v(" "),n("li",[s._v("可否广播，一次通知，处处生效？")]),s._v(" "),n("li",[s._v("....")])]),s._v(" "),n("p",[s._v("目前来说，暂时做不到这个，所以才用了下面的内容，即Spring Cloud Bus 消息总线")])])}),[],!1,null,null,null);a.default=e.exports}}]);