(window.webpackJsonp=window.webpackJsonp||[]).push([[177],{873:function(s,a,n){"use strict";n.r(a);var e=n(5),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"springcloudalibabaseata处理分布式事务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#springcloudalibabaseata处理分布式事务"}},[s._v("#")]),s._v(" SpringCloudAlibabaSeata处理分布式事务")]),s._v(" "),n("p",[s._v("基于分布式的事务管理")]),s._v(" "),n("h2",{attrs:{id:"分布式事务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务"}},[s._v("#")]),s._v(" 分布式事务")]),s._v(" "),n("p",[s._v("分布式之前，单机单库没有这个问题，从 1:1 -> 1:N -> N:N")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417081113603.png",alt:"image-20200417081113603"}})]),s._v(" "),n("p",[s._v("跨数据库，多数据源的统一调度，就会遇到分布式事务问题")]),s._v(" "),n("p",[s._v("如下图，单体应用被拆分成微服务应用，原来的三个模板被拆分成三个独立的应用，分别使用三个独立的数据源，业务操作需要调用三个服务来完成。此时每个服务内部的数据一致性由本地事务来保证，但是全局的数据一致性问题没法保证。")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417081239933.png",alt:"image-20200417081239933"}})]),s._v(" "),n("h2",{attrs:{id:"seata简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#seata简介"}},[s._v("#")]),s._v(" Seata简介")]),s._v(" "),n("p",[s._v("官方文档："),n("a",{attrs:{href:"https://seata.io/zh-cn/docs/overview/what-is-seata.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("点我传送"),n("OutboundLink")],1)]),s._v(" "),n("p",[s._v("Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。")]),s._v(" "),n("p",[s._v("分布式事务处理过程的一致性ID + 三组件模型")]),s._v(" "),n("ul",[n("li",[s._v("Transaction ID XID：全局唯一的事务ID")]),s._v(" "),n("li",[s._v("三组件的概念\n"),n("ul",[n("li",[s._v("Transaction  Coordinator（TC）：事务协调器，维护全局事务，驱动全局事务提交或者回滚")]),s._v(" "),n("li",[s._v("Transaction Manager（TM）：事务管理器，控制全局事务的范围，开始全局事务提交或回滚全局事务")]),s._v(" "),n("li",[s._v("Resource Manager（RM）：资源管理器，控制分支事务，负责分支注册分支事务和报告")])])])]),s._v(" "),n("h3",{attrs:{id:"处理过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#处理过程"}},[s._v("#")]),s._v(" 处理过程")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417121037783.png",alt:"image-20200417121037783"}})]),s._v(" "),n("ul",[n("li",[s._v("TM向TC申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的XID")]),s._v(" "),n("li",[s._v("XID在微服务调用链路的上下文中传播")]),s._v(" "),n("li",[s._v("RM向TC注册分支事务，将其纳入XID对应全局事务的管辖")]),s._v(" "),n("li",[s._v("TM向TC发起针对XID的全局提交或回滚决议")]),s._v(" "),n("li",[s._v("TM调度XID下管辖的全部分支事务完成提交或回滚请求")])]),s._v(" "),n("h3",{attrs:{id:"下载"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#下载"}},[s._v("#")]),s._v(" 下载")]),s._v(" "),n("p",[s._v("地址：https://github.com/seata/seata/releases")]),s._v(" "),n("p",[s._v("下载 1.1版本完成后，修改conf目录下的file.conf配置文件")]),s._v(" "),n("h4",{attrs:{id:"修改file-conf"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改file-conf"}},[s._v("#")]),s._v(" 修改file.conf")]),s._v(" "),n("p",[s._v("首先我们需要备份原始的file.conf文件")]),s._v(" "),n("p",[s._v("主要修改，自定义事务组名称 + 事务日志存储模式为db + 数据库连接信息，也就是修改存储的数据库")]),s._v(" "),n("h4",{attrs:{id:"修改service模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改service模块"}},[s._v("#")]),s._v(" 修改service模块")]),s._v(" "),n("p",[s._v("修改服务模块中的分组")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417133537054.png",alt:"image-20200417133537054"}})]),s._v(" "),n("h4",{attrs:{id:"修改store模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改store模块"}},[s._v("#")]),s._v(" 修改store模块")]),s._v(" "),n("p",[s._v("修改存储模块")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417134353031.png",alt:"image-20200417134353031"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417133715606.png",alt:"image-20200417133715606"}})]),s._v(" "),n("h4",{attrs:{id:"创建一个seata数据库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建一个seata数据库"}},[s._v("#")]),s._v(" 创建一个seata数据库")]),s._v(" "),n("p",[s._v("在seata数据库中建表，建表语句在 seata/conf目录下的 db_store.sql")]),s._v(" "),n("h4",{attrs:{id:"修改seata-server的registry-conf配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改seata-server的registry-conf配置文件"}},[s._v("#")]),s._v(" 修改seata-server的registry.conf配置文件")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417134800315.png",alt:"image-20200417134800315"}})]),s._v(" "),n("p",[s._v("目的是：指明注册中心为nacos，及修改nacos连接信息")]),s._v(" "),n("p",[s._v("然后启动nacos 和 seata-server")]),s._v(" "),n("h3",{attrs:{id:"怎么玩"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#怎么玩"}},[s._v("#")]),s._v(" 怎么玩")]),s._v(" "),n("ul",[n("li",[s._v("本地：@Transaction")]),s._v(" "),n("li",[s._v("全局：@GlobalTransaction")])]),s._v(" "),n("p",[s._v("Spring自带的是 @Transaction 控制本地事务")]),s._v(" "),n("p",[s._v("而 @GlobalTransaction控制的是全局事务")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417133041311.png",alt:"image-20200417133041311"}})]),s._v(" "),n("p",[s._v("我们只需要在需要支持分布式事务的业务类上，使用该注解即可")]),s._v(" "),n("h2",{attrs:{id:"订单-库存-账户业务微服务准备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#订单-库存-账户业务微服务准备"}},[s._v("#")]),s._v(" 订单/库存/账户业务微服务准备")]),s._v(" "),n("p",[s._v("在这之前首先需要先启动Nacos，然后启动Seata，保证两个都OK")]),s._v(" "),n("h3",{attrs:{id:"分布式事务的业务说明"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务的业务说明"}},[s._v("#")]),s._v(" 分布式事务的业务说明")]),s._v(" "),n("p",[s._v("这里我们会创建三个微服务，一个订单服务，一个库存服务，一个账户服务。")]),s._v(" "),n("p",[s._v("当用户下单时，会在订单服务中创建一个订单，然后通过远程调用库存服务来扣减下单商品的库存，在通过远程调用账户服务来扣减用户账户里面的金额，最后在订单服务修改订单状态为已完成")]),s._v(" "),n("p",[s._v("该操作跨越了三个数据库，有两次远程调用，很明显会有分布式事务的问题。")]),s._v(" "),n("p",[s._v("一句话：下订单 -> 扣库存 -> 减余额")]),s._v(" "),n("h3",{attrs:{id:"创建数据库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建数据库"}},[s._v("#")]),s._v(" 创建数据库")]),s._v(" "),n("ul",[n("li",[s._v("seata_order：存储订单的数据库")]),s._v(" "),n("li",[s._v("seata_storage：存储库存的数据库")]),s._v(" "),n("li",[s._v("seata_account：存储账户信息的数据库")])]),s._v(" "),n("p",[s._v("建库SQL")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("create database seata_order;\ncreate database seata_storage;\ncreate database seata_account;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h3",{attrs:{id:"建立业务表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#建立业务表"}},[s._v("#")]),s._v(" 建立业务表")]),s._v(" "),n("ul",[n("li",[s._v("seata_order库下建立t_order表")]),s._v(" "),n("li",[s._v("seata_storage库下建t_storage表")]),s._v(" "),n("li",[s._v("seata_account库下建t_account表")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("DROP TABLE IF EXISTS `t_order`;\nCREATE TABLE `t_order`  (\n  `int` bigint(11) NOT NULL AUTO_INCREMENT,\n  `user_id` bigint(20) DEFAULT NULL COMMENT '用户id',\n  `product_id` bigint(11) DEFAULT NULL COMMENT '产品id',\n  `count` int(11) DEFAULT NULL COMMENT '数量',\n  `money` decimal(11, 0) DEFAULT NULL COMMENT '金额',\n  `status` int(1) DEFAULT NULL COMMENT '订单状态:  0:创建中 1:已完结',\n  PRIMARY KEY (`int`) USING BTREE\n) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '订单表' ROW_FORMAT = Dynamic;\n\nDROP TABLE IF EXISTS `t_storage`;\nCREATE TABLE `t_storage`  (\n  `int` bigint(11) NOT NULL AUTO_INCREMENT,\n  `product_id` bigint(11) DEFAULT NULL COMMENT '产品id',\n  `total` int(11) DEFAULT NULL COMMENT '总库存',\n  `used` int(11) DEFAULT NULL COMMENT '已用库存',\n  `residue` int(11) DEFAULT NULL COMMENT '剩余库存',\n  PRIMARY KEY (`int`) USING BTREE\n) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '库存' ROW_FORMAT = Dynamic;\nINSERT INTO `t_storage` VALUES (1, 1, 100, 0, 100);\n\nCREATE TABLE `t_account`  (\n  `id` bigint(11) NOT NULL COMMENT 'id',\n  `user_id` bigint(11) DEFAULT NULL COMMENT '用户id',\n  `total` decimal(10, 0) DEFAULT NULL COMMENT '总额度',\n  `used` decimal(10, 0) DEFAULT NULL COMMENT '已用余额',\n  `residue` decimal(10, 0) DEFAULT NULL COMMENT '剩余可用额度',\n  PRIMARY KEY (`id`) USING BTREE\n) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '账户表' ROW_FORMAT = Dynamic;\n \nINSERT INTO `t_account` VALUES (1, 1, 1000, 0, 1000);\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("h3",{attrs:{id:"创建回滚日志表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建回滚日志表"}},[s._v("#")]),s._v(" 创建回滚日志表")]),s._v(" "),n("p",[s._v("订单 - 库存 - 账户 3个库都需要建各自的回滚日志表，目录在 db_undo_log.sql")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("-- the table to store seata xid data\n-- 0.7.0+ add context\n-- you must to init this sql for you business databese. the seata server not need it.\n-- 此脚本必须初始化在你当前的业务数据库中，用于AT 模式XID记录。与server端无关（注：业务数据库）\n-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log\nDROP TABLE `undo_log`;\nCREATE TABLE `undo_log` (\n  `id` BIGINT(20) NOT NULL AUTO_INCREMENT,\n  `branch_id` BIGINT(20) NOT NULL,\n  `xid` VARCHAR(100) NOT NULL,\n  `context` VARCHAR(128) NOT NULL,\n  `rollback_info` LONGBLOB NOT NULL,\n  `log_status` INT(11) NOT NULL,\n  `log_created` DATETIME NOT NULL,\n  `log_modified` DATETIME NOT NULL,\n  `ext` VARCHAR(100) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)\n) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("h2",{attrs:{id:"订单-库存-账户业务微服务准备-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#订单-库存-账户业务微服务准备-2"}},[s._v("#")]),s._v(" 订单/库存/账户业务微服务准备")]),s._v(" "),n("h3",{attrs:{id:"业务需求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#业务需求"}},[s._v("#")]),s._v(" 业务需求")]),s._v(" "),n("p",[s._v("下订单 -> 减库存 -> 扣余额 -> 改（订单）状态")]),s._v(" "),n("h3",{attrs:{id:"新建order-module表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#新建order-module表"}},[s._v("#")]),s._v(" 新建Order-Module表")]),s._v(" "),n("h4",{attrs:{id:"约定"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#约定"}},[s._v("#")]),s._v(" 约定")]),s._v(" "),n("p",[s._v("entity，domain：相当于实体类层")]),s._v(" "),n("p",[s._v("vo：view object，value object")]),s._v(" "),n("p",[s._v("dto：前台传到后台的数据传输类")]),s._v(" "),n("h4",{attrs:{id:"新建module2001"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#新建module2001"}},[s._v("#")]),s._v(" 新建module2001")]),s._v(" "),n("h4",{attrs:{id:"引入pom"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#引入pom"}},[s._v("#")]),s._v(" 引入POM")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\t\t\x3c!--seata--\x3e\n        <dependency>\n            <groupId>com.alibaba.cloud</groupId>\n            <artifactId>spring-cloud-starter-alibaba-seata</artifactId>\n            <exclusions>\n                <exclusion>\n                    <artifactId>seata-all</artifactId>\n                    <groupId>io.seata</groupId>\n                </exclusion>\n            </exclusions>\n        </dependency>\n        <dependency>\n            <groupId>io.seata</groupId>\n            <artifactId>seata-all</artifactId>\n            <version>0.9.0</version>\n        </dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h4",{attrs:{id:"修改yml"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改yml"}},[s._v("#")]),s._v(" 修改yml")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server:\n  port: 2001\n\nspring:\n  application:\n    name: seata-order-service\n  cloud:\n    alibaba:\n      seata:\n        #自定义事务组名称需要与seata-server中的对应\n        tx-service-group: fsp_tx_group\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n  datasource:\n    driver-class-name: com.mysql.jdbc.Driver\n    url: jdbc:mysql://localhost:3306/seata_order\n    username: root\n    password: 123456\n\nfeign:\n  hystrix:\n    enabled: false\n\nlogging:\n  level:\n    io:\n      seata: info\n\nmybatis:\n  mapperLocations: classpath:mapper/*.xml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br")])]),n("h4",{attrs:{id:"增加file-conf"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#增加file-conf"}},[s._v("#")]),s._v(" 增加file.conf")]),s._v(" "),n("p",[s._v("在resources目录下，创建file.conf文件")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('transport {\n  # tcp udt unix-domain-socket\n  type = "TCP"\n  #NIO NATIVE\n  server = "NIO"\n  #enable heartbeat\n  heartbeat = true\n  #thread factory for netty\n  thread-factory {\n    boss-thread-prefix = "NettyBoss"\n    worker-thread-prefix = "NettyServerNIOWorker"\n    server-executor-thread-prefix = "NettyServerBizHandler"\n    share-boss-worker = false\n    client-selector-thread-prefix = "NettyClientSelector"\n    client-selector-thread-size = 1\n    client-worker-thread-prefix = "NettyClientWorkerThread"\n    # netty boss thread size,will not be used for UDT\n    boss-thread-size = 1\n    #auto default pin or 8\n    worker-thread-size = 8\n  }\n  shutdown {\n    # when destroy server, wait seconds\n    wait = 3\n  }\n  serialization = "seata"\n  compressor = "none"\n}\n\nservice {\n\n  vgroup_mapping.fsp_tx_group = "default" #修改自定义事务组名称\n\n  default.grouplist = "127.0.0.1:8091"\n  enableDegrade = false\n  disable = false\n  max.commit.retry.timeout = "-1"\n  max.rollback.retry.timeout = "-1"\n  disableGlobalTransaction = false\n}\n\n\nclient {\n  async.commit.buffer.limit = 10000\n  lock {\n    retry.internal = 10\n    retry.times = 30\n  }\n  report.retry.count = 5\n  tm.commit.retry.count = 1\n  tm.rollback.retry.count = 1\n}\n\n## transaction log store\nstore {\n  ## store mode: file、db\n  mode = "db"\n\n  ## file store\n  file {\n    dir = "sessionStore"\n\n    # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions\n    max-branch-session-size = 16384\n    # globe session size , if exceeded throws exceptions\n    max-global-session-size = 512\n    # file buffer size , if exceeded allocate new buffer\n    file-write-buffer-cache-size = 16384\n    # when recover batch read size\n    session.reload.read_size = 100\n    # async, sync\n    flush-disk-mode = async\n  }\n\n  ## database store\n  db {\n    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.\n    datasource = "dbcp"\n    ## mysql/oracle/h2/oceanbase etc.\n    db-type = "mysql"\n    driver-class-name = "com.mysql.jdbc.Driver"\n    url = "jdbc:mysql://127.0.0.1:3306/seata"\n    user = "root"\n    password = "123456"\n    min-conn = 1\n    max-conn = 3\n    global.table = "global_table"\n    branch.table = "branch_table"\n    lock-table = "lock_table"\n    query-limit = 100\n  }\n}\nlock {\n  ## the lock store mode: local、remote\n  mode = "remote"\n\n  local {\n    ## store locks in user\'s database\n  }\n\n  remote {\n    ## store locks in the seata\'s server\n  }\n}\nrecovery {\n  #schedule committing retry period in milliseconds\n  committing-retry-period = 1000\n  #schedule asyn committing retry period in milliseconds\n  asyn-committing-retry-period = 1000\n  #schedule rollbacking retry period in milliseconds\n  rollbacking-retry-period = 1000\n  #schedule timeout retry period in milliseconds\n  timeout-retry-period = 1000\n}\n\ntransaction {\n  undo.data.validation = true\n  undo.log.serialization = "jackson"\n  undo.log.save.days = 7\n  #schedule delete expired undo_log in milliseconds\n  undo.log.delete.period = 86400000\n  undo.log.table = "undo_log"\n}\n\n## metrics settings\nmetrics {\n  enabled = false\n  registry-type = "compact"\n  # multi exporters use comma divided\n  exporter-list = "prometheus"\n  exporter-prometheus-port = 9898\n}\n\nsupport {\n  ## spring\n  spring {\n    # auto proxy the DataSource bean\n    datasource.autoproxy = false\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br"),n("span",{staticClass:"line-number"},[s._v("108")]),n("br"),n("span",{staticClass:"line-number"},[s._v("109")]),n("br"),n("span",{staticClass:"line-number"},[s._v("110")]),n("br"),n("span",{staticClass:"line-number"},[s._v("111")]),n("br"),n("span",{staticClass:"line-number"},[s._v("112")]),n("br"),n("span",{staticClass:"line-number"},[s._v("113")]),n("br"),n("span",{staticClass:"line-number"},[s._v("114")]),n("br"),n("span",{staticClass:"line-number"},[s._v("115")]),n("br"),n("span",{staticClass:"line-number"},[s._v("116")]),n("br"),n("span",{staticClass:"line-number"},[s._v("117")]),n("br"),n("span",{staticClass:"line-number"},[s._v("118")]),n("br"),n("span",{staticClass:"line-number"},[s._v("119")]),n("br"),n("span",{staticClass:"line-number"},[s._v("120")]),n("br"),n("span",{staticClass:"line-number"},[s._v("121")]),n("br"),n("span",{staticClass:"line-number"},[s._v("122")]),n("br"),n("span",{staticClass:"line-number"},[s._v("123")]),n("br"),n("span",{staticClass:"line-number"},[s._v("124")]),n("br"),n("span",{staticClass:"line-number"},[s._v("125")]),n("br"),n("span",{staticClass:"line-number"},[s._v("126")]),n("br"),n("span",{staticClass:"line-number"},[s._v("127")]),n("br"),n("span",{staticClass:"line-number"},[s._v("128")]),n("br"),n("span",{staticClass:"line-number"},[s._v("129")]),n("br"),n("span",{staticClass:"line-number"},[s._v("130")]),n("br"),n("span",{staticClass:"line-number"},[s._v("131")]),n("br"),n("span",{staticClass:"line-number"},[s._v("132")]),n("br"),n("span",{staticClass:"line-number"},[s._v("133")]),n("br"),n("span",{staticClass:"line-number"},[s._v("134")]),n("br"),n("span",{staticClass:"line-number"},[s._v("135")]),n("br"),n("span",{staticClass:"line-number"},[s._v("136")]),n("br"),n("span",{staticClass:"line-number"},[s._v("137")]),n("br"),n("span",{staticClass:"line-number"},[s._v("138")]),n("br"),n("span",{staticClass:"line-number"},[s._v("139")]),n("br"),n("span",{staticClass:"line-number"},[s._v("140")]),n("br")])]),n("h4",{attrs:{id:"registry-conf-注册器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#registry-conf-注册器"}},[s._v("#")]),s._v(" registry.conf 注册器")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('registry {\n  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa\n  type = "nacos"\n\n  nacos {\n    serverAddr = "localhost:8848"\n    namespace = ""\n    cluster = "default"\n  }\n  eureka {\n    serviceUrl = "http://localhost:8761/eureka"\n    application = "default"\n    weight = "1"\n  }\n  redis {\n    serverAddr = "localhost:6379"\n    db = "0"\n  }\n  zk {\n    cluster = "default"\n    serverAddr = "127.0.0.1:2181"\n    session.timeout = 6000\n    connect.timeout = 2000\n  }\n  consul {\n    cluster = "default"\n    serverAddr = "127.0.0.1:8500"\n  }\n  etcd3 {\n    cluster = "default"\n    serverAddr = "http://localhost:2379"\n  }\n  sofa {\n    serverAddr = "127.0.0.1:9603"\n    application = "default"\n    region = "DEFAULT_ZONE"\n    datacenter = "DefaultDataCenter"\n    cluster = "default"\n    group = "SEATA_GROUP"\n    addressWaitTime = "3000"\n  }\n  file {\n    name = "file.conf"\n  }\n}\n\nconfig {\n  # file、nacos 、apollo、zk、consul、etcd3\n  type = "file"\n\n  nacos {\n    serverAddr = "localhost"\n    namespace = ""\n  }\n  consul {\n    serverAddr = "127.0.0.1:8500"\n  }\n  apollo {\n    app.id = "seata-server"\n    apollo.meta = "http://192.168.1.204:8801"\n  }\n  zk {\n    serverAddr = "127.0.0.1:2181"\n    session.timeout = 6000\n    connect.timeout = 2000\n  }\n  etcd3 {\n    serverAddr = "http://localhost:2379"\n  }\n  file {\n    name = "file.conf"\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br")])]),n("h4",{attrs:{id:"domain"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#domain"}},[s._v("#")]),s._v(" domain")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@Data\n@AllArgsConstructor\n@NoArgsConstructor\npublic class CommonResult<T>\n{\n    private Integer code;\n    private String  message;\n    private T       data;\n\n    public CommonResult(Integer code, String message)\n    {\n        this(code,message,null);\n    }\n}\n\n\n@Data\n@AllArgsConstructor\n@NoArgsConstructor\npublic class Order\n{\n    private Long id;\n\n    private Long userId;\n\n    private Long productId;\n\n    private Integer count;\n\n    private BigDecimal money;\n\n    private Integer status; //订单状态：0：创建中；1：已完结\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])]),n("h4",{attrs:{id:"dao接口及实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dao接口及实现"}},[s._v("#")]),s._v(" Dao接口及实现")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Mapper\npublic interface OrderDao\n{\n    //1 新建订单\n    void create(Order order);\n\n    //2 修改订单状态，从零改为1\n    void update(@Param("userId") Long userId,@Param("status") Integer status);\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<?xml version="1.0" encoding="UTF-8" ?>\n<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >\n\n<mapper namespace="com.atguigu.springcloud.alibaba.dao.OrderDao">\n\n    <resultMap id="BaseResultMap" type="com.atguigu.springcloud.alibaba.domain.Order">\n        <id column="id" property="id" jdbcType="BIGINT"/>\n        <result column="user_id" property="userId" jdbcType="BIGINT"/>\n        <result column="product_id" property="productId" jdbcType="BIGINT"/>\n        <result column="count" property="count" jdbcType="INTEGER"/>\n        <result column="money" property="money" jdbcType="DECIMAL"/>\n        <result column="status" property="status" jdbcType="INTEGER"/>\n    </resultMap>\n\n    <insert id="create">\n        insert into t_order (id,user_id,product_id,count,money,status)\n        values (null,#{userId},#{productId},#{count},#{money},0);\n    </insert>\n\n    <update id="update">\n        update t_order set status = 1\n        where user_id=#{userId} and status = #{status};\n    </update>\n\n</mapper>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br")])]),n("h4",{attrs:{id:"service实现类"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#service实现类"}},[s._v("#")]),s._v(" Service实现类")]),s._v(" "),n("p",[s._v("OrderService接口")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public interface OrderService\n{\n    void create(Order order);\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("StorageService的Feign接口，")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@FeignClient(value = "seata-storage-service")\npublic interface StorageService\n{\n    @PostMapping(value = "/storage/decrease")\n    CommonResult decrease(@RequestParam("productId") Long productId, @RequestParam("count") Integer count);\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("AccountService的Feign接口，账户接口")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@FeignClient(value = "seata-account-service")\npublic interface AccountService\n{\n    @PostMapping(value = "/account/decrease")\n    CommonResult decrease(@RequestParam("userId") Long userId, @RequestParam("money") BigDecimal money);\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("OrderServiceImpl实现类")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Service\n@Slf4j\npublic class OrderServiceImpl implements OrderService\n{\n    @Resource\n    private OrderDao orderDao;\n    @Resource\n    private StorageService storageService;\n    @Resource\n    private AccountService accountService;\n\n    /**\n     * 创建订单->调用库存服务扣减库存->调用账户服务扣减账户余额->修改订单状态\n     * 简单说：下订单->扣库存->减余额->改状态\n     */\n    @Override\n    @GlobalTransactional(name = "fsp-create-order",rollbackFor = Exception.class)\n    public void create(Order order)\n    {\n        log.info("-----\x3e开始新建订单");\n        //1 新建订单\n        orderDao.create(order);\n\n        //2 扣减库存\n        log.info("-----\x3e订单微服务开始调用库存，做扣减Count");\n        storageService.decrease(order.getProductId(),order.getCount());\n        log.info("-----\x3e订单微服务开始调用库存，做扣减end");\n\n        //3 扣减账户\n        log.info("-----\x3e订单微服务开始调用账户，做扣减Money");\n        accountService.decrease(order.getUserId(),order.getMoney());\n        log.info("-----\x3e订单微服务开始调用账户，做扣减end");\n\n        //4 修改订单状态，从零到1,1代表已经完成\n        log.info("-----\x3e修改订单状态开始");\n        orderDao.update(order.getUserId(),0);\n        log.info("-----\x3e修改订单状态结束");\n\n        log.info("-----\x3e下订单结束了，O(∩_∩)O哈哈~");\n\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br")])]),n("h4",{attrs:{id:"业务类"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#业务类"}},[s._v("#")]),s._v(" 业务类")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@RestController\npublic class OrderController\n{\n    @Resource\n    private OrderService orderService;\n\n\n    @GetMapping("/order/create")\n    public CommonResult create(Order order)\n    {\n        orderService.create(order);\n        return new CommonResult(200,"订单创建成功");\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("h4",{attrs:{id:"config配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#config配置"}},[s._v("#")]),s._v(" Config配置")]),s._v(" "),n("p",[s._v("Mybatis DataSourceProxyConfig配置，这里是使用Seata对数据源进行代理")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Configuration\npublic class DataSourceProxyConfig {\n\n    @Value("${mybatis.mapperLocations}")\n    private String mapperLocations;\n\n    @Bean\n    @ConfigurationProperties(prefix = "spring.datasource")\n    public DataSource druidDataSource(){\n        return new DruidDataSource();\n    }\n\n    @Bean\n    public DataSourceProxy dataSourceProxy(DataSource dataSource) {\n        return new DataSourceProxy(dataSource);\n    }\n\n    @Bean\n    public SqlSessionFactory sqlSessionFactoryBean(DataSourceProxy dataSourceProxy) throws Exception {\n        SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean();\n        sqlSessionFactoryBean.setDataSource(dataSourceProxy);\n        sqlSessionFactoryBean.setMapperLocations(new PathMatchingResourcePatternResolver().getResources(mapperLocations));\n        sqlSessionFactoryBean.setTransactionFactory(new SpringManagedTransactionFactory());\n        return sqlSessionFactoryBean.getObject();\n    }\n\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("p",[s._v("Mybatis配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Configuration\n@MapperScan({"com.atguigu.springcloud.alibaba.dao"})\npublic class MyBatisConfig {\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h4",{attrs:{id:"启动类"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#启动类"}},[s._v("#")]),s._v(" 启动类")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@EnableDiscoveryClient\n@EnableFeignClients\n@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)//取消数据源的自动创建\npublic class SeataOrderMainApp2001\n{\n\n    public static void main(String[] args)\n    {\n        SpringApplication.run(SeataOrderMainApp2001.class, args);\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("h3",{attrs:{id:"新建storage-module"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#新建storage-module"}},[s._v("#")]),s._v(" 新建Storage-Module")]),s._v(" "),n("p",[s._v("参考项目：seata-storage-service2002")]),s._v(" "),n("h3",{attrs:{id:"新建账户account-module"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#新建账户account-module"}},[s._v("#")]),s._v(" 新建账户Account-Module")]),s._v(" "),n("p",[s._v("参考项目：seata-account-service2003")]),s._v(" "),n("h3",{attrs:{id:"测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),n("h4",{attrs:{id:"数据库初始情况"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#数据库初始情况"}},[s._v("#")]),s._v(" 数据库初始情况")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417225230939.png",alt:"image-20200417225230939"}})]),s._v(" "),n("h4",{attrs:{id:"正常下单"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#正常下单"}},[s._v("#")]),s._v(" 正常下单")]),s._v(" "),n("p",[s._v("访问")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("http://localhost:2001/order/create?userId=1&productId=1&count=10&money=100\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[n("img",{attrs:{src:"/images/image-20200417225932063.png",alt:"image-20200417225932063"}})]),s._v(" "),n("h4",{attrs:{id:"超时异常-没加-globaltransaction"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#超时异常-没加-globaltransaction"}},[s._v("#")]),s._v(" 超时异常，没加@GlobalTransaction")]),s._v(" "),n("p",[s._v("我们在account-module模块，添加睡眠时间20秒，因为openFeign默认时间是1秒")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417230124982.png",alt:"image-20200417230124982"}})]),s._v(" "),n("p",[s._v("出现了数据不一致的问题")]),s._v(" "),n("p",[s._v("故障情况")]),s._v(" "),n("ul",[n("li",[s._v("当库存和账户金额扣减后，订单状态并没有设置成已经完成，没有从零改成1")]),s._v(" "),n("li",[s._v("而且由于Feign的重试机制，账户余额还有可能被多次扣除")])]),s._v(" "),n("h4",{attrs:{id:"超时异常-添加-globaltransaction"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#超时异常-添加-globaltransaction"}},[s._v("#")]),s._v(" 超时异常，添加@GlobalTransaction")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@GlobalTransactional(name = "fsp-create-order",rollbackFor = Exception.class)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("rollbackFor表示，什么什么错误就会回滚")]),s._v(" "),n("p",[s._v("添加这个后，发现下单后的数据库并没有改变，记录都添加不进来")]),s._v(" "),n("h2",{attrs:{id:"一部分补充"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一部分补充"}},[s._v("#")]),s._v(" 一部分补充")]),s._v(" "),n("h3",{attrs:{id:"seata"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#seata"}},[s._v("#")]),s._v(" Seata")]),s._v(" "),n("p",[s._v("2019年1月份，蚂蚁金服和阿里巴巴共同开源的分布式事务解决方案")]),s._v(" "),n("p",[s._v("Seata：Simple Extensible Autonomous Transaction Architecture，简单可扩展自治事务框架")]),s._v(" "),n("p",[s._v("2020起始，参加工作以后用1.0以后的版本。")]),s._v(" "),n("h3",{attrs:{id:"再看tc-tm-rm三大组件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#再看tc-tm-rm三大组件"}},[s._v("#")]),s._v(" 再看TC/TM/RM三大组件")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417231145550.png",alt:"image-20200417231145550"}})]),s._v(" "),n("p",[s._v("什么是TC，TM，RM")]),s._v(" "),n("p",[s._v("TC：seata服务器")]),s._v(" "),n("p",[s._v("TM：带有@GlobalTransaction注解的方法")]),s._v(" "),n("p",[s._v("RM：数据库，也就是事务参与方")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417231314748.png",alt:"image-20200417231314748"}})]),s._v(" "),n("h3",{attrs:{id:"分布式事务的执行流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务的执行流程"}},[s._v("#")]),s._v(" 分布式事务的执行流程")]),s._v(" "),n("ul",[n("li",[s._v("TM开启分布式事务（TM向TC注册全局事务记录），相当于注解 "),n("code",[s._v("@GlobelTransaction")]),s._v("注解")]),s._v(" "),n("li",[s._v("按业务场景，编排数据库，服务等事务内部资源（RM向TC汇报资源准备状态）")]),s._v(" "),n("li",[s._v("TM结束分布式事务，事务一阶段结束（TM通知TC提交、回滚分布式事务）")]),s._v(" "),n("li",[s._v("TC汇总事务信息，决定分布式事务是提交还是回滚")]),s._v(" "),n("li",[s._v("TC通知所有RM提交、回滚资源，事务二阶段结束")])]),s._v(" "),n("h3",{attrs:{id:"at模式如何做到对业务的无侵入"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#at模式如何做到对业务的无侵入"}},[s._v("#")]),s._v(" AT模式如何做到对业务的无侵入")]),s._v(" "),n("p",[s._v("默认AT模式，阿里云GTS")]),s._v(" "),n("h3",{attrs:{id:"at模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#at模式"}},[s._v("#")]),s._v(" AT模式")]),s._v(" "),n("h4",{attrs:{id:"前提"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前提"}},[s._v("#")]),s._v(" 前提")]),s._v(" "),n("ul",[n("li",[s._v("基于支持本地ACID事务的关系型数据库")]),s._v(" "),n("li",[s._v("Java应用，通过JDBC访问数据库")])]),s._v(" "),n("h4",{attrs:{id:"整体机制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#整体机制"}},[s._v("#")]),s._v(" 整体机制")]),s._v(" "),n("p",[s._v("两阶段提交协议的演变")]),s._v(" "),n("ul",[n("li",[s._v("一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源")]),s._v(" "),n("li",[s._v("二阶段\n"),n("ul",[n("li",[s._v("提交异步化，非常快速的完成")]),s._v(" "),n("li",[s._v("回滚通过一阶段的回滚日志进行反向补偿")])])])]),s._v(" "),n("h4",{attrs:{id:"一阶段加载"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一阶段加载"}},[s._v("#")]),s._v(" 一阶段加载")]),s._v(" "),n("p",[s._v("在一阶段，Seata会拦截 业务SQL")]),s._v(" "),n("ul",[n("li",[s._v("解析SQL语义，找到业务SQL，要更新的业务数据，在业务数据被更新前，将其保存成 "),n("code",[s._v("before image（前置镜像）")])]),s._v(" "),n("li",[s._v("执行业务SQL更新业务数据，在业务数据更新之后")]),s._v(" "),n("li",[s._v("将其保存成 after image，最后生成行锁")])]),s._v(" "),n("p",[s._v("以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417232316157.png",alt:"image-20200417232316157"}})]),s._v(" "),n("h4",{attrs:{id:"二阶段提交"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二阶段提交"}},[s._v("#")]),s._v(" 二阶段提交")]),s._v(" "),n("p",[s._v("二阶段如果顺利提交的话，因为业务SQL在一阶段已经提交至数据库，所以Seata框架只需将一阶段保存的快照和行锁删除掉，完成数据清理即可")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417232502282.png",alt:"image-20200417232502282"}})]),s._v(" "),n("h4",{attrs:{id:"二阶段回滚"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二阶段回滚"}},[s._v("#")]),s._v(" 二阶段回滚")]),s._v(" "),n("p",[s._v("二阶段如果回滚的话，Seata就需要回滚到一阶段已经执行的 业务SQL，还原业务数据")]),s._v(" "),n("p",[s._v("回滚方式便是用 before image 还原业务数据，但是在还原前要首先校验脏写，对比数据库当前业务数据 和after image，如果两份数据完全一致，没有脏写，可以还原业务数据，如果不一致说明有脏读，出现脏读就需要转人工处理")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417232859708.png",alt:"image-20200417232859708"}})]),s._v(" "),n("h4",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200417233926182.png",alt:"image-20200417233926182"}})])])}),[],!1,null,null,null);a.default=t.exports}}]);