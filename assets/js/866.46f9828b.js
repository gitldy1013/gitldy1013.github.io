(window.webpackJsonp=window.webpackJsonp||[]).push([[866],{1561:function(s,e,a){"use strict";a.r(e);var n=a(5),t=Object(n.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"kubernetes-高可用集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-高可用集群"}},[s._v("#")]),s._v(" Kubernetes 高可用集群")]),s._v(" "),a("h2",{attrs:{id:"概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),a("p",[s._v("在入门课程中我们部署的 Kubernetes 是 "),a("strong",[s._v("集群模式")]),s._v("，但在实际生产中我们需要部署 "),a("strong",[s._v("高可用集群")]),s._v(" ，本章内容旨在指导大家如何部署 Kubernetes 高可用集群")]),s._v(" "),a("h2",{attrs:{id:"统一环境配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#统一环境配置"}},[s._v("#")]),s._v(" 统一环境配置")]),s._v(" "),a("h3",{attrs:{id:"节点配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点配置"}},[s._v("#")]),s._v(" 节点配置")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("主机名")]),s._v(" "),a("th",[s._v("IP")]),s._v(" "),a("th",[s._v("角色")]),s._v(" "),a("th",[s._v("系统")]),s._v(" "),a("th",[s._v("CPU/内存")]),s._v(" "),a("th",[s._v("磁盘")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("kubernetes-master-01")]),s._v(" "),a("td",[s._v("192.168.141.150")]),s._v(" "),a("td",[s._v("Master")]),s._v(" "),a("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),a("td",[s._v("2核2G")]),s._v(" "),a("td",[s._v("20G")])]),s._v(" "),a("tr",[a("td",[s._v("kubernetes-master-02")]),s._v(" "),a("td",[s._v("192.168.141.151")]),s._v(" "),a("td",[s._v("Master")]),s._v(" "),a("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),a("td",[s._v("2核2G")]),s._v(" "),a("td",[s._v("20G")])]),s._v(" "),a("tr",[a("td",[s._v("kubernetes-master-03")]),s._v(" "),a("td",[s._v("192.168.141.152")]),s._v(" "),a("td",[s._v("Master")]),s._v(" "),a("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),a("td",[s._v("2核2G")]),s._v(" "),a("td",[s._v("20G")])]),s._v(" "),a("tr",[a("td",[s._v("kubernetes-node-01")]),s._v(" "),a("td",[s._v("192.168.141.160")]),s._v(" "),a("td",[s._v("Node")]),s._v(" "),a("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),a("td",[s._v("2核4G")]),s._v(" "),a("td",[s._v("20G")])]),s._v(" "),a("tr",[a("td",[s._v("kubernetes-node-02")]),s._v(" "),a("td",[s._v("192.168.141.161")]),s._v(" "),a("td",[s._v("Node")]),s._v(" "),a("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),a("td",[s._v("2核4G")]),s._v(" "),a("td",[s._v("20G")])]),s._v(" "),a("tr",[a("td",[s._v("kubernetes-node-03")]),s._v(" "),a("td",[s._v("192.168.141.162")]),s._v(" "),a("td",[s._v("Node")]),s._v(" "),a("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),a("td",[s._v("2核4G")]),s._v(" "),a("td",[s._v("20G")])]),s._v(" "),a("tr",[a("td",[s._v("Kubernetes VIP")]),s._v(" "),a("td",[s._v("192.168.141.200")]),s._v(" "),a("td",[s._v("-")]),s._v(" "),a("td",[s._v("-")]),s._v(" "),a("td",[s._v("-")]),s._v(" "),a("td",[s._v("-")])])])]),s._v(" "),a("h3",{attrs:{id:"对操作系统的配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#对操作系统的配置"}},[s._v("#")]),s._v(" 对操作系统的配置")]),s._v(" "),a("blockquote",[a("p",[s._v("特别注意：以下步骤请在制作 VMware 镜像时一并完成，避免逐台安装的痛苦")])]),s._v(" "),a("h4",{attrs:{id:"关闭交换空间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关闭交换空间"}},[s._v("#")]),s._v(" 关闭交换空间")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    swapoff -a\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"避免开机启动交换空间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#避免开机启动交换空间"}},[s._v("#")]),s._v(" 避免开机启动交换空间")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # 注释 swap 开头的行\n    vi /etc/fstab\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h4",{attrs:{id:"关闭防火墙"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关闭防火墙"}},[s._v("#")]),s._v(" 关闭防火墙")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    ufw disable\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"配置-dns"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-dns"}},[s._v("#")]),s._v(" 配置 DNS")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # 取消 DNS 行注释，并增加 DNS 配置如：114.114.114.114，修改后重启下计算机\n    vi /etc/systemd/resolved.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h4",{attrs:{id:"安装-docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-docker"}},[s._v("#")]),s._v(" 安装 Docker")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    # 更新软件源\n    sudo apt-get update\n    # 安装所需依赖\n    sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common\n    # 安装 GPG 证书\n    curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -\n    # 新增软件源信息\n    sudo add-apt-repository "deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"\n    # 再次更新软件源\n    sudo apt-get -y update\n    # 安装 Docker CE 版\n    sudo apt-get -y install docker-ce\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h4",{attrs:{id:"配置-docker-加速器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-docker-加速器"}},[s._v("#")]),s._v(" 配置 Docker 加速器")]),s._v(" "),a("blockquote",[a("p",[s._v("特别注意：国内镜像加速器可能会很卡，请替换成你自己阿里云镜像加速器，地址如："),a("code",[s._v("https://yourself.mirror.aliyuncs.com")]),s._v("，在阿里云控制台的 "),a("strong",[s._v("容器镜像服务 -> 镜像加速器")]),s._v(" 菜单中可以找到")])]),s._v(" "),a("p",[s._v("在 "),a("code",[s._v("/etc/docker/daemon.json")]),s._v(" 中写入如下内容（如果文件不存在请新建该文件）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    {\n      "registry-mirrors": [\n        "https://registry.docker-cn.com"\n      ]\n    }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"安装-kubeadm-kubelet-kubectl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-kubeadm-kubelet-kubectl"}},[s._v("#")]),s._v(" 安装 kubeadm，kubelet，kubectl")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # 安装系统工具\n    apt-get update && apt-get install -y apt-transport-https\n    \n    # 安装 GPG 证书\n    curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -\n    \n    # 写入软件源；注意：我们用系统代号为 bionic，但目前阿里云不支持，所以沿用 16.04 的 xenial\n    cat << EOF >/etc/apt/sources.list.d/kubernetes.list\n    > deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\n    > EOF\n    \n    # 安装\n    apt-get update && apt-get install -y kubelet kubeadm kubectl\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h4",{attrs:{id:"同步时间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#同步时间"}},[s._v("#")]),s._v(" 同步时间")]),s._v(" "),a("p",[a("strong",[s._v("设置时区")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    dpkg-reconfigure tzdata\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("选择 "),a("strong",[s._v("Asia（亚洲）")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/20190602220034.png",alt:""}})]),s._v(" "),a("p",[s._v("选择 "),a("strong",[s._v("Shanghai（上海）")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/20190602220202.png",alt:""}})]),s._v(" "),a("p",[a("strong",[s._v("时间同步")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # 安装 ntpdate\n    apt-get install ntpdate\n    \n    # 设置系统时间与网络时间同步（cn.pool.ntp.org 位于中国的公共 NTP 服务器）\n    ntpdate cn.pool.ntp.org\n    \n    # 将系统时间写入硬件时间\n    hwclock --systohc\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[a("strong",[s._v("确认时间")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    date\n    \n    # 输出如下（自行对照与系统时间是否一致）\n    Sun Jun  2 22:02:35 CST 2019\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"配置-ipvs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-ipvs"}},[s._v("#")]),s._v(" 配置 IPVS")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # 安装系统工具\n    apt-get install -y ipset ipvsadm\n    \n    # 配置并加载 IPVS 模块\n    mkdir -p /etc/sysconfig/modules/\n    vi /etc/sysconfig/modules/ipvs.modules\n    \n    # 输入如下内容\n    #!/bin/bash\n    modprobe -- ip_vs\n    modprobe -- ip_vs_rr\n    modprobe -- ip_vs_wrr\n    modprobe -- ip_vs_sh\n    modprobe -- nf_conntrack_ipv4\n    \n    # 执行脚本，注意：如果重启则需要重新运行该脚本\n    chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4\n    \n    # 执行脚本输出如下\n    ip_vs_sh               16384  0\n    ip_vs_wrr              16384  0\n    ip_vs_rr               16384  0\n    ip_vs                 147456  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr\n    nf_conntrack_ipv4      16384  3\n    nf_defrag_ipv4         16384  1 nf_conntrack_ipv4\n    nf_conntrack          131072  8 xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_ipv4,nf_nat,ipt_MASQUERADE,nf_nat_ipv4,nf_conntrack_netlink,ip_vs\n    libcrc32c              16384  4 nf_conntrack,nf_nat,raid456,ip_vs\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("h4",{attrs:{id:"配置内核参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置内核参数"}},[s._v("#")]),s._v(" 配置内核参数")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # 配置参数\n    vi /etc/sysctl.d/k8s.conf\n    \n    # 输入如下内容\n    net.bridge.bridge-nf-call-ip6tables = 1\n    net.bridge.bridge-nf-call-iptables = 1\n    net.ipv4.ip_nonlocal_bind = 1\n    net.ipv4.ip_forward = 1\n    vm.swappiness=0\n    \n    # 应用参数\n    sysctl --system\n    \n    # 应用参数输出如下（找到 Applying /etc/sysctl.d/k8s.conf 开头的日志）\n    * Applying /etc/sysctl.d/10-console-messages.conf ...\n    kernel.printk = 4 4 1 7\n    * Applying /etc/sysctl.d/10-ipv6-privacy.conf ...\n    * Applying /etc/sysctl.d/10-kernel-hardening.conf ...\n    kernel.kptr_restrict = 1\n    * Applying /etc/sysctl.d/10-link-restrictions.conf ...\n    fs.protected_hardlinks = 1\n    fs.protected_symlinks = 1\n    * Applying /etc/sysctl.d/10-lxd-inotify.conf ...\n    fs.inotify.max_user_instances = 1024\n    * Applying /etc/sysctl.d/10-magic-sysrq.conf ...\n    kernel.sysrq = 176\n    * Applying /etc/sysctl.d/10-network-security.conf ...\n    net.ipv4.conf.default.rp_filter = 1\n    net.ipv4.conf.all.rp_filter = 1\n    net.ipv4.tcp_syncookies = 1\n    * Applying /etc/sysctl.d/10-ptrace.conf ...\n    kernel.yama.ptrace_scope = 1\n    * Applying /etc/sysctl.d/10-zeropage.conf ...\n    vm.mmap_min_addr = 65536\n    * Applying /usr/lib/sysctl.d/50-default.conf ...\n    net.ipv4.conf.all.promote_secondaries = 1\n    net.core.default_qdisc = fq_codel\n    * Applying /etc/sysctl.d/99-sysctl.conf ...\n    * Applying /etc/sysctl.d/k8s.conf ...\n    net.bridge.bridge-nf-call-ip6tables = 1\n    net.bridge.bridge-nf-call-iptables = 1\n    net.ipv4.ip_nonlocal_bind = 1\n    net.ipv4.ip_forward = 1\n    vm.swappiness = 0\n    * Applying /etc/sysctl.conf ...\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br")])]),a("h4",{attrs:{id:"修改-cloud-cfg"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改-cloud-cfg"}},[s._v("#")]),s._v(" 修改 cloud.cfg")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    vi /etc/cloud/cloud.cfg\n    \n    # 该配置默认为 false，修改为 true 即可\n    preserve_hostname: true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"单独节点配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#单独节点配置"}},[s._v("#")]),s._v(" 单独节点配置")]),s._v(" "),a("blockquote",[a("p",[s._v("特别注意：为 Master 和 Node 节点单独配置对应的 "),a("strong",[s._v("IP")]),s._v(" 和 "),a("strong",[s._v("主机名")])])]),s._v(" "),a("h3",{attrs:{id:"配置-ip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-ip"}},[s._v("#")]),s._v(" 配置 IP")]),s._v(" "),a("p",[s._v("编辑 "),a("code",[s._v("vi /etc/netplan/50-cloud-init.yaml")]),s._v(" 配置文件，修改内容如下")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    network:\n        ethernets:\n            ens33:\n              # 我的 Master 是 150 - 152，Node 是 160 - 162\n              addresses: [192.168.141.150/24]\n              gateway4: 192.168.141.2\n              nameservers:\n                addresses: [192.168.141.2]\n        version: 2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("使用 "),a("code",[s._v("netplan apply")]),s._v(" 命令让配置生效")]),s._v(" "),a("h3",{attrs:{id:"配置主机名"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置主机名"}},[s._v("#")]),s._v(" 配置主机名")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # 修改主机名\n    hostnamectl set-hostname kubernetes-master-01\n    \n    # 配置 hosts\n    cat >> /etc/hosts << EOF\n    192.168.141.150 kubernetes-master-01\n    EOF\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h2",{attrs:{id:"安装-haproxy-keepalived"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-haproxy-keepalived"}},[s._v("#")]),s._v(" 安装 HAProxy + Keepalived")]),s._v(" "),a("h3",{attrs:{id:"概述-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概述-2"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),a("p",[s._v("Kubernetes Master 节点运行组件如下：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("kube-apiserver：")]),s._v(" 提供了资源操作的唯一入口，并提供认证、授权、访问控制、API 注册和发现等机制")]),s._v(" "),a("li",[a("strong",[s._v("kube-scheduler：")]),s._v(" 负责资源的调度，按照预定的调度策略将 Pod 调度到相应的机器上")]),s._v(" "),a("li",[a("strong",[s._v("kube-controller-manager：")]),s._v(" 负责维护集群的状态，比如故障检测、自动扩展、滚动更新等")]),s._v(" "),a("li",[a("strong",[s._v("etcd：")]),s._v(" CoreOS 基于 Raft 开发的分布式 key-value 存储，可用于服务发现、共享配置以及一致性保障（如数据库选主、分布式锁等）")])]),s._v(" "),a("p",[a("code",[s._v("kube-scheduler")]),s._v(" 和 "),a("code",[s._v("kube-controller-manager")]),s._v(" 可以以集群模式运行，通过 leader 选举产生一个工作进程，其它进程处于阻塞模式。")]),s._v(" "),a("p",[a("strong",[a("code",[s._v("kube-apiserver")]),s._v(" 可以运行多个实例，但对其它组件需要提供统一的访问地址，本章节部署 Kubernetes 高可用集群实际就是利用 HAProxy + Keepalived 配置该组件")])]),s._v(" "),a("p",[s._v("配置的思路就是利用 HAProxy + Keepalived 实现 "),a("code",[s._v("kube-apiserver")]),s._v(" 虚拟 IP 访问从而实现高可用和负载均衡，拆解如下：")]),s._v(" "),a("ul",[a("li",[s._v("Keepalived 提供 "),a("code",[s._v("kube-apiserver")]),s._v(" 对外服务的虚拟 IP（VIP）")]),s._v(" "),a("li",[s._v("HAProxy 监听 Keepalived VIP")]),s._v(" "),a("li",[s._v("运行 Keepalived 和 HAProxy 的节点称为 LB（负载均衡） 节点")]),s._v(" "),a("li",[s._v("Keepalived 是一主多备运行模式，故至少需要两个 LB 节点")]),s._v(" "),a("li",[s._v("Keepalived 在运行过程中周期检查本机的 HAProxy 进程状态，如果检测到 HAProxy 进程异常，则触发重新选主的过程，VIP 将飘移到新选出来的主节点，从而实现 VIP 的高可用")]),s._v(" "),a("li",[s._v("所有组件（如 kubeclt、apiserver、controller-manager、scheduler 等）都通过 VIP +HAProxy 监听的 6444 端口访问 "),a("code",[s._v("kube-apiserver")]),s._v(" 服务（"),a("strong",[s._v("注意："),a("code",[s._v("kube-apiserver")]),s._v(" 默认端口为 6443，为了避免冲突我们将 HAProxy 端口设置为 6444，其它组件都是通过该端口统一请求 apiserver")]),s._v("）")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/20190427104124213.png",alt:"负载均衡架构图"}})]),s._v(" "),a("h3",{attrs:{id:"创建-haproxy-启动脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建-haproxy-启动脚本"}},[s._v("#")]),s._v(" 创建 HAProxy 启动脚本")]),s._v(" "),a("blockquote",[a("p",[s._v("该步骤在 "),a("code",[s._v("kubernetes-master-01")]),s._v(" 执行")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    mkdir -p /usr/local/kubernetes/lb\n    vi /usr/local/kubernetes/lb/start-haproxy.sh\n    \n    # 输入内容如下\n    #!/bin/bash\n    # 修改为你自己的 Master 地址\n    MasterIP1=192.168.141.150\n    MasterIP2=192.168.141.151\n    MasterIP3=192.168.141.152\n    # 这是 kube-apiserver 默认端口，不用修改\n    MasterPort=6443\n    \n    # 容器将 HAProxy 的 6444 端口暴露出去\n    docker run -d --restart=always --name HAProxy-K8S -p 6444:6444 \\\n            -e MasterIP1=$MasterIP1 \\\n            -e MasterIP2=$MasterIP2 \\\n            -e MasterIP3=$MasterIP3 \\\n            -e MasterPort=$MasterPort \\\n            wise2c/haproxy-k8s\n    \n    # 设置权限\n    chmod +x start-haproxy.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h3",{attrs:{id:"创建-keepalived-启动脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建-keepalived-启动脚本"}},[s._v("#")]),s._v(" 创建 Keepalived 启动脚本")]),s._v(" "),a("blockquote",[a("p",[s._v("该步骤在 "),a("code",[s._v("kubernetes-master-01")]),s._v(" 执行")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    mkdir -p /usr/local/kubernetes/lb\n    vi /usr/local/kubernetes/lb/start-keepalived.sh\n    \n    # 输入内容如下\n    #!/bin/bash\n    # 修改为你自己的虚拟 IP 地址\n    VIRTUAL_IP=192.168.141.200\n    # 虚拟网卡设备名\n    INTERFACE=ens33\n    # 虚拟网卡的子网掩码\n    NETMASK_BIT=24\n    # HAProxy 暴露端口，内部指向 kube-apiserver 的 6443 端口\n    CHECK_PORT=6444\n    # 路由标识符\n    RID=10\n    # 虚拟路由标识符\n    VRID=160\n    # IPV4 多播地址，默认 224.0.0.18\n    MCAST_GROUP=224.0.0.18\n    \n    docker run -itd --restart=always --name=Keepalived-K8S \\\n            --net=host --cap-add=NET_ADMIN \\\n            -e VIRTUAL_IP=$VIRTUAL_IP \\\n            -e INTERFACE=$INTERFACE \\\n            -e CHECK_PORT=$CHECK_PORT \\\n            -e RID=$RID \\\n            -e VRID=$VRID \\\n            -e NETMASK_BIT=$NETMASK_BIT \\\n            -e MCAST_GROUP=$MCAST_GROUP \\\n            wise2c/keepalived-k8s\n    \n    # 设置权限\n    chmod +x start-keepalived.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br")])]),a("h3",{attrs:{id:"复制脚本到其它-master-地址"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#复制脚本到其它-master-地址"}},[s._v("#")]),s._v(" 复制脚本到其它 Master 地址")]),s._v(" "),a("p",[s._v("分别在 "),a("code",[s._v("kubernetes-master-02")]),s._v(" 和 "),a("code",[s._v("kubernetes-master-03")]),s._v(" 执行创建工作目录命令")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    mkdir -p /usr/local/kubernetes/lb\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("将 "),a("code",[s._v("kubernetes-master-01")]),s._v(" 中的脚本拷贝至其它 Master")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    scp start-haproxy.sh start-keepalived.sh 192.168.141.151:/usr/local/kubernetes/lb\n    scp start-haproxy.sh start-keepalived.sh 192.168.141.152:/usr/local/kubernetes/lb\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("分别在 3 个 Master 中启动容器（执行脚本）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    sh /usr/local/kubernetes/lb/start-haproxy.sh && sh /usr/local/kubernetes/lb/start-keepalived.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"验证是否成功"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#验证是否成功"}},[s._v("#")]),s._v(" 验证是否成功")]),s._v(" "),a("h4",{attrs:{id:"查看容器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看容器"}},[s._v("#")]),s._v(" 查看容器")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    docker ps\n    \n    # 输出如下\n    CONTAINER ID        IMAGE                   COMMAND                  CREATED             STATUS              PORTS                    NAMES\n    f50df479ecae        wise2c/keepalived-k8s   "/usr/bin/keepalived…"   About an hour ago   Up About an hour                             Keepalived-K8S\n    75066a7ed2fb        wise2c/haproxy-k8s      "/docker-entrypoint.…"   About an hour ago   Up About an hour    0.0.0.0:6444->6444/tcp   HAProxy-K8S\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h4",{attrs:{id:"查看网卡绑定的虚拟-ip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看网卡绑定的虚拟-ip"}},[s._v("#")]),s._v(" 查看网卡绑定的虚拟 IP")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    ip a | grep ens33\n    \n    # 输出如下\n    2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000\n        inet 192.168.141.151/24 brd 192.168.141.255 scope global ens33\n        inet 192.168.141.200/24 scope global secondary ens33\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("blockquote",[a("p",[s._v("特别注意：Keepalived 会对 HAProxy 监听的 6444 端口进行检测，如果检测失败即认定本机 HAProxy 进程异常，会将 VIP 漂移到其他节点，所以无论本机 Keepalived 容器异常或 HAProxy 容器异常都会导致 VIP 漂移到其他节点")])]),s._v(" "),a("h2",{attrs:{id:"部署-kubernetes-集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署-kubernetes-集群"}},[s._v("#")]),s._v(" 部署 Kubernetes 集群")]),s._v(" "),a("h3",{attrs:{id:"初始化-master"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初始化-master"}},[s._v("#")]),s._v(" 初始化 Master")]),s._v(" "),a("ul",[a("li",[s._v("创建工作目录并导出配置文件")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # 创建工作目录\n    mkdir -p /usr/local/kubernetes/cluster\n    \n    # 导出配置文件到工作目录\n    kubeadm config print init-defaults --kubeconfig ClusterConfiguration > kubeadm.yml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("ul",[a("li",[s._v("修改配置文件")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    apiVersion: kubeadm.k8s.io/v1beta1\n    bootstrapTokens:\n    - groups:\n      - system:bootstrappers:kubeadm:default-node-token\n      token: abcdef.0123456789abcdef\n      ttl: 24h0m0s\n      usages:\n      - signing\n      - authentication\n    kind: InitConfiguration\n    localAPIEndpoint:\n      # 修改为主节点 IP\n      advertiseAddress: 192.168.141.150\n      bindPort: 6443\n    nodeRegistration:\n      criSocket: /var/run/dockershim.sock\n      name: kubernetes-master\n      taints:\n      - effect: NoSchedule\n        key: node-role.kubernetes.io/master\n    ---\n    apiServer:\n      timeoutForControlPlane: 4m0s\n    apiVersion: kubeadm.k8s.io/v1beta1\n    certificatesDir: /etc/kubernetes/pki\n    clusterName: kubernetes\n    # 配置 Keepalived 地址和 HAProxy 端口\n    controlPlaneEndpoint: "192.168.141.200:6444"\n    controllerManager: {}\n    dns:\n      type: CoreDNS\n    etcd:\n      local:\n        dataDir: /var/lib/etcd\n    # 国内不能访问 Google，修改为阿里云\n    imageRepository: registry.aliyuncs.com/google_containers\n    kind: ClusterConfiguration\n    # 修改版本号\n    kubernetesVersion: v1.14.2\n    networking:\n      dnsDomain: cluster.local\n      # 配置成 Calico 的默认网段\n      podSubnet: "192.168.0.0/16"\n      serviceSubnet: 10.96.0.0/12\n    scheduler: {}\n    ---\n    # 开启 IPVS 模式\n    apiVersion: kubeproxy.config.k8s.io/v1alpha1\n    kind: KubeProxyConfiguration\n    featureGates:\n      SupportIPVSProxyMode: true\n    mode: ipvs\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br")])]),a("ul",[a("li",[s._v("kubeadm 初始化")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # kubeadm 初始化\n    kubeadm init --config=kubeadm.yml --experimental-upload-certs | tee kubeadm-init.log\n    \n    # 配置 kubectl\n    mkdir -p $HOME/.kube\n    cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n    chown $(id -u):$(id -g) $HOME/.kube/config\n    \n    # 验证是否成功\n    kubectl get node\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("ul",[a("li",[s._v("安装网络插件")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # 安装 Calico\n    kubectl apply -f https://docs.projectcalico.org/v3.7/manifests/calico.yaml\n    \n    # 验证安装是否成功\n    watch kubectl get pods --all-namespaces\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"加入-master-节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#加入-master-节点"}},[s._v("#")]),s._v(" 加入 Master 节点")]),s._v(" "),a("p",[s._v("从 "),a("code",[s._v("kubeadm-init.log")]),s._v(" 中获取命令，分别将 "),a("code",[s._v("kubernetes-master-02")]),s._v(" 和 "),a("code",[s._v("kubernetes-master-03")]),s._v(" 加入 Master")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # 以下为示例命令\n    kubeadm join 192.168.141.200:6444 --token abcdef.0123456789abcdef \\\n      --discovery-token-ca-cert-hash sha256:56d53268517c132ae81c868ce99c44be797148fb2923e59b49d73c99782ff21f \\\n      --experimental-control-plane --certificate-key c4d1525b6cce4b69c11c18919328c826f92e660e040a46f5159431d5ff0545bd\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"加入-node-节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#加入-node-节点"}},[s._v("#")]),s._v(" 加入 Node 节点")]),s._v(" "),a("p",[s._v("从 "),a("code",[s._v("kubeadm-init.log")]),s._v(" 中获取命令，分别将 "),a("code",[s._v("kubernetes-node-01")]),s._v(" 至 "),a("code",[s._v("kubernetes-node-03")]),s._v(" 加入 Node")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    # 以下为示例命令\n    kubeadm join 192.168.141.200:6444 --token abcdef.0123456789abcdef \\\n        --discovery-token-ca-cert-hash sha256:56d53268517c132ae81c868ce99c44be797148fb2923e59b49d73c99782ff21f \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"验证集群状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#验证集群状态"}},[s._v("#")]),s._v(" 验证集群状态")]),s._v(" "),a("ul",[a("li",[s._v("查看 Node")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    kubectl get nodes -o wide\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("查看 Pod")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    kubectl -n kube-system get pod -o wide\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("查看 Service")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    kubectl -n kube-system get svc\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("验证 IPVS")])]),s._v(" "),a("p",[s._v("查看 kube-proxy 日志，server_others.go:176] Using ipvs Proxier.")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    kubectl -n kube-system logs -f <kube-proxy 容器名>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("查看代理规则")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    ipvsadm -ln\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("查看生效的配置")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    kubectl -n kube-system get cm kubeadm-config -oyaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("查看 etcd 集群")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    kubectl -n kube-system exec etcd-kubernetes-master-01 -- etcdctl \\\n    \t--endpoints=https://192.168.141.150:2379 \\\n    \t--ca-file=/etc/kubernetes/pki/etcd/ca.crt \\\n    \t--cert-file=/etc/kubernetes/pki/etcd/server.crt \\\n    \t--key-file=/etc/kubernetes/pki/etcd/server.key cluster-health\n    \n    # 输出如下\n    member 1dfaf07371bb0cb6 is healthy: got healthy result from https://192.168.141.152:2379\n    member 2da85730b52fbeb2 is healthy: got healthy result from https://192.168.141.150:2379\n    member 6a3153eb4faaaffa is healthy: got healthy result from https://192.168.141.151:2379\n    cluster is healthy\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"验证高可用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#验证高可用"}},[s._v("#")]),s._v(" 验证高可用")]),s._v(" "),a("blockquote",[a("p",[s._v("特别注意：Keepalived 要求至少 2 个备用节点，故想测试高可用至少需要 1 主 2 从模式验证，否则可能出现意想不到的问题")])]),s._v(" "),a("p",[s._v("对任意一台 Master 机器执行关机操作")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    shutdown -h now\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在任意一台 Master 节点上查看 Node 状态")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    kubectl get node\n    \n    # 输出如下，除已关机那台状态为 NotReady 其余正常便表示成功\n    NAME                   STATUS   ROLES    AGE   VERSION\n    kubernetes-master-01   NotReady master   18m   v1.14.2\n    kubernetes-master-02   Ready    master   17m   v1.14.2\n    kubernetes-master-03   Ready    master   16m   v1.14.2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("查看 VIP 漂移")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    ip a |grep ens33\n    \n    # 输出如下\n    2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000\n        inet 192.168.141.151/24 brd 192.168.141.255 scope global ens33\n        inet 192.168.141.200/24 scope global secondary ens33\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])])])}),[],!1,null,null,null);e.default=t.exports}}]);