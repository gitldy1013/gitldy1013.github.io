(window.webpackJsonp=window.webpackJsonp||[]).push([[1002],{1698:function(n,s,a){"use strict";a.r(s);var e=a(5),i=Object(e.a)({},(function(){var n=this,s=n.$createElement,a=n._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h1",{attrs:{id:"服务链路追踪"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务链路追踪"}},[n._v("#")]),n._v(" 服务链路追踪")]),n._v(" "),a("h2",{attrs:{id:"概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[n._v("#")]),n._v(" 概述")]),n._v(" "),a("p",[n._v("这篇文章主要讲解服务追踪组件 ZipKin。")]),n._v(" "),a("h2",{attrs:{id:"zipkin-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zipkin-简介"}},[n._v("#")]),n._v(" ZipKin 简介")]),n._v(" "),a("p",[n._v("ZipKin 是一个开放源代码的分布式跟踪系统，由 Twitter 公司开源，它致力于收集服务的定时数据，以解决微服务架构中的延迟问题，包括数据的收集、存储、查找和展现。它的理论模型来自于 Google Dapper 论文。")]),n._v(" "),a("p",[n._v("每个服务向 ZipKin 报告计时数据，ZipKin 会根据调用关系通过 ZipKin UI 生成依赖关系图，显示了多少跟踪请求通过每个服务，该系统让开发者可通过一个 Web 前端轻松的收集和分析数据，例如用户每次请求服务的处理时间等，可方便的监测系统中存在的瓶颈。")]),n._v(" "),a("h2",{attrs:{id:"服务追踪说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务追踪说明"}},[n._v("#")]),n._v(" 服务追踪说明")]),n._v(" "),a("p",[n._v("微服务架构是通过业务来划分服务的，使用 REST 调用。对外暴露的一个接口，可能需要很多个服务协同才能完成这个接口功能，如果链路上任何一个服务出现问题或者网络超时，都会形成导致接口调用失败。随着业务的不断扩张，服务之间互相调用会越来越复杂。")]),n._v(" "),a("p",[a("img",{attrs:{src:"/img/2279594-dd72907e82f89fd6.png",alt:""}})]),n._v(" "),a("p",[n._v("随着服务的越来越多，对调用链的分析会越来越复杂。它们之间的调用关系也许如下：")]),n._v(" "),a("p",[a("img",{attrs:{src:"/img/2279594-4b7d1b6abe595390.png",alt:""}})]),n._v(" "),a("h2",{attrs:{id:"术语解释"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#术语解释"}},[n._v("#")]),n._v(" 术语解释")]),n._v(" "),a("ul",[a("li",[n._v("Span：基本工作单元，例如，在一个新建的 Span 中发送一个 RPC 等同于发送一个回应请求给 RPC，Span 通过一个 64 位 ID 唯一标识，Trace 以另一个 64 位 ID 表示。")]),n._v(" "),a("li",[n._v("Trace：一系列 Spans 组成的一个树状结构，例如，如果你正在运行一个分布式大数据工程，你可能需要创建一个 Trace。")]),n._v(" "),a("li",[n._v("Annotation：用来即使记录一个事件的存在，一些核心 Annotations 用来定义一个请求的开始和结束\n"),a("ul",[a("li",[n._v("cs：Client Sent，客户端发起一个请求，这个 Annotation 描述了这个 Span 的开始")]),n._v(" "),a("li",[n._v("sr：Server Received，服务端获得请求并准备开始处理它，"),a("strong",[n._v("如果将其 sr 减去 cs 时间戳便可得到网络延迟")])]),n._v(" "),a("li",[n._v("ss：Server Sent 表明请求处理的完成(当请求返回客户端)，"),a("strong",[n._v("如果 ss 减去 sr 时间戳便可得到服务端需要的处理请求时间")])]),n._v(" "),a("li",[n._v("cr：Client Received 表明 Span 的结束，客户端成功接收到服务端的回复，"),a("strong",[n._v("如果 cr 减去 cs 时间戳便可得到客户端从服务端获取回复的所有所需时间")])])])])]),n._v(" "),a("p",[n._v("将 Span 和 Trace 在一个系统中使用 Zipkin 注解的过程图形化：")]),n._v(" "),a("p",[a("img",{attrs:{src:"/img/2279594-4b865f2a2c271def.png",alt:""}})]),n._v(" "),a("h2",{attrs:{id:"创建-zipkin-服务端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建-zipkin-服务端"}},[n._v("#")]),n._v(" 创建 ZipKin 服务端")]),n._v(" "),a("p",[n._v("创建一个工程名为 "),a("code",[n._v("hello-spring-cloud-zipkin")]),n._v(" 的项目，"),a("code",[n._v("pom.xml")]),n._v(" 文件如下：")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('    <?xml version="1.0" encoding="UTF-8"?>\n    <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n             xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">\n        <modelVersion>4.0.0</modelVersion>\n    \n        <parent>\n            <groupId>com.cmcc</groupId>\n            <artifactId>hello-spring-cloud-dependencies</artifactId>\n            <version>1.0.0-SNAPSHOT</version>\n            <relativePath>../hello-spring-cloud-dependencies/pom.xml</relativePath>\n        </parent>\n    \n        <artifactId>hello-spring-cloud-zipkin</artifactId>\n        <packaging>jar</packaging>\n    \n        <name>hello-spring-cloud-zipkin</name>\n        <url>http://www.cmcc.com</url>\n        <inceptionYear>2018-Now</inceptionYear>\n    \n        <dependencies>\n            \x3c!-- Spring Boot Begin --\x3e\n            <dependency>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-starter-web</artifactId>\n            </dependency>\n            <dependency>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-starter-tomcat</artifactId>\n            </dependency>\n            <dependency>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-starter-actuator</artifactId>\n            </dependency>\n            <dependency>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-starter-test</artifactId>\n                <scope>test</scope>\n            </dependency>\n            \x3c!-- Spring Boot End --\x3e\n    \n            \x3c!-- Spring Cloud Begin --\x3e\n            <dependency>\n                <groupId>io.zipkin.java</groupId>\n                <artifactId>zipkin</artifactId>\n            </dependency>\n            <dependency>\n                <groupId>io.zipkin.java</groupId>\n                <artifactId>zipkin-server</artifactId>\n            </dependency>\n            <dependency>\n                <groupId>io.zipkin.java</groupId>\n                <artifactId>zipkin-autoconfigure-ui</artifactId>\n            </dependency>\n            <dependency>\n                <groupId>org.springframework.cloud</groupId>\n                <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>\n            </dependency>\n            \x3c!-- Spring Cloud End --\x3e\n        </dependencies>\n    \n        <build>\n            <plugins>\n                <plugin>\n                    <groupId>org.springframework.boot</groupId>\n                    <artifactId>spring-boot-maven-plugin</artifactId>\n                    <configuration>\n                        <mainClass>com.cmcc.hello.spring.cloud.zipkin.ZipKinApplication</mainClass>\n                    </configuration>\n                </plugin>\n            </plugins>\n        </build>\n    </project>\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br"),a("span",{staticClass:"line-number"},[n._v("70")]),a("br"),a("span",{staticClass:"line-number"},[n._v("71")]),a("br"),a("span",{staticClass:"line-number"},[n._v("72")]),a("br")])]),a("p",[n._v("主要增加了 3 个依赖，"),a("code",[n._v("io.zipkin.java:zipkin")]),n._v("、"),a("code",[n._v("io.zipkin.java:zipkin-server")]),n._v("、"),a("code",[n._v("io.zipkin.java:zipkin-autoconfigure-ui")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    <dependency>\n        <groupId>io.zipkin.java</groupId>\n        <artifactId>zipkin</artifactId>\n    </dependency>\n    <dependency>\n        <groupId>io.zipkin.java</groupId>\n        <artifactId>zipkin-server</artifactId>\n    </dependency>\n    <dependency>\n        <groupId>io.zipkin.java</groupId>\n        <artifactId>zipkin-autoconfigure-ui</artifactId>\n    </dependency>\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br")])]),a("p",[n._v("注意版本号为："),a("code",[n._v("2.10.1")]),n._v("，这里没写版本号是因为我已将版本号托管到 "),a("code",[n._v("dependencies")]),n._v(" 项目中")]),n._v(" "),a("h2",{attrs:{id:"application"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#application"}},[n._v("#")]),n._v(" Application")]),n._v(" "),a("p",[n._v("通过 "),a("code",[n._v("@EnableZipkinServer")]),n._v(" 注解开启 Zipkin Server 功能")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    package com.cmcc.hello.spring.cloud.zipkin;\n    \n    import org.springframework.boot.SpringApplication;\n    import org.springframework.boot.autoconfigure.SpringBootApplication;\n    import org.springframework.cloud.netflix.eureka.EnableEurekaClient;\n    import zipkin.server.internal.EnableZipkinServer;\n    \n    @SpringBootApplication\n    @EnableEurekaClient\n    @EnableZipkinServer\n    public class ZipKinApplication {\n        public static void main(String[] args) {\n            SpringApplication.run(ZipKinApplication.class, args);\n        }\n    }\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br")])]),a("h2",{attrs:{id:"application-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#application-yml"}},[n._v("#")]),n._v(" application.yml")]),n._v(" "),a("p",[n._v("设置端口号为："),a("code",[n._v("9411")]),n._v("，该端口号为 Zipkin Server 的默认端口号")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    spring:\n      application:\n        name: hello-spring-cloud-zipkin\n    \n    server:\n      port: 9411\n    \n    eureka:\n      client:\n        serviceUrl:\n          defaultZone: http://localhost:8761/eureka/\n          \n    management:\n      metrics:\n        web:\n          server:\n            auto-time-requests: false\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br")])]),a("h2",{attrs:{id:"追踪服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#追踪服务"}},[n._v("#")]),n._v(" 追踪服务")]),n._v(" "),a("p",[n._v("在 "),a("strong",[n._v("所有需要被追踪的项目（就当前教程而言，除了 "),a("code",[n._v("dependencies")]),n._v(" 项目外都需要被追踪，包括 Eureka Server）")]),n._v(" 中增加 "),a("code",[n._v("spring-cloud-starter-zipkin")]),n._v(" 依赖")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    <dependency>\n        <groupId>org.springframework.cloud</groupId>\n        <artifactId>spring-cloud-starter-zipkin</artifactId>\n    </dependency>\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br")])]),a("p",[n._v("在这些项目的 "),a("code",[n._v("application.yml")]),n._v(" 配置文件中增加 Zipkin Server 的地址即可")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    spring:\n      zipkin:\n        base-url: http://localhost:9411\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br")])]),a("h2",{attrs:{id:"测试追踪"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试追踪"}},[n._v("#")]),n._v(" 测试追踪")]),n._v(" "),a("p",[n._v("启动全部项目，打开浏览器访问：http://localhost:9411/ 会出现以下界面：")]),n._v(" "),a("p",[a("img",{attrs:{src:"/img/2018060105410001.png",alt:""}})]),n._v(" "),a("p",[a("strong",[n._v("刷新之前项目中的全部测试接口（刷多几次）")])]),n._v(" "),a("p",[n._v("点击 "),a("code",[n._v("Find a trace")]),n._v("，可以看到具体服务相互调用的数据")]),n._v(" "),a("p",[a("img",{attrs:{src:"/img/2018060105410002.png",alt:""}})]),n._v(" "),a("p",[n._v("点击 "),a("code",[n._v("Dependencies")]),n._v("，可以发现服务的依赖关系")]),n._v(" "),a("p",[a("img",{attrs:{src:"/img/2018060105410003.png",alt:""}})]),n._v(" "),a("p",[n._v("至此就代表 ZipKin 配置成功")])])}),[],!1,null,null,null);s.default=i.exports}}]);