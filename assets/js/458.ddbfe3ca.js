(window.webpackJsonp=window.webpackJsonp||[]).push([[458],{1154:function(e,s,n){"use strict";n.r(s);var a=n(5),t=Object(a.a)({},(function(){var e=this,s=e.$createElement,n=e._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"docker-compose-实战-django"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-实战-django"}},[e._v("#")]),e._v(" Docker Compose 实战 Django")]),e._v(" "),n("p",[e._v("本小节内容适合 "),n("code",[e._v("Python")]),e._v(" 开发人员阅读。")]),e._v(" "),n("p",[e._v("我们现在将使用 "),n("code",[e._v("Docker Compose")]),e._v(" 配置并运行一个 "),n("code",[e._v("Django/PostgreSQL")]),e._v(" 应用。")]),e._v(" "),n("p",[e._v("在一切工作开始前，需要先编辑好三个必要的文件。")]),e._v(" "),n("p",[e._v("第一步，因为应用将要运行在一个满足所有环境依赖的 Docker 容器里面，那么我们可以通过编辑 "),n("code",[e._v("Dockerfile")]),e._v(" 文件来指定 Docker 容器要安装内容。内容如下：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    FROM python:3\n    ENV PYTHONUNBUFFERED 1\n    RUN mkdir /code\n    WORKDIR /code\n    ADD requirements.txt /code/\n    RUN pip install -r requirements.txt\n    ADD . /code/\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("p",[e._v("以上内容指定应用将使用安装了 Python 以及必要依赖包的镜像。更多关于如何编写 "),n("code",[e._v("Dockerfile")]),e._v(" 文件的信息可以查看 [镜像创建](../image/create.md#利用 Dockerfile 来创建镜像) 和 "),n("RouterLink",{attrs:{to:"/zh/dockerfile/"}},[e._v("Dockerfile 使用")]),e._v("。")],1),e._v(" "),n("p",[e._v("第二步，在 "),n("code",[e._v("requirements.txt")]),e._v(" 文件里面写明需要安装的具体依赖包名。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    Django>=1.8,<2.0\n    psycopg2\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("p",[e._v("第三步，"),n("code",[e._v("docker-compose.yml")]),e._v(" 文件将把所有的东西关联起来。它描述了应用的构成（一个 web 服务和一个数据库）、使用的 Docker 镜像、镜像之间的连接、挂载到容器的卷，以及服务开放的端口。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('    version: "3"\n    services:\n    \n      db:\n        image: postgres\n    \n      web:\n        build: .\n        command: python3 manage.py runserver 0.0.0.0:8000\n        volumes:\n          - .:/code\n        ports:\n          - "8000:8000"\n        links:\n          - db\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br")])]),n("p",[e._v("现在我们就可以使用 "),n("code",[e._v("docker-compose run")]),e._v(" 命令启动一个 "),n("code",[e._v("Django")]),e._v(" 应用了。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    $ docker-compose run web django-admin.py startproject django_example .\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("Compose 会先使用 "),n("code",[e._v("Dockerfile")]),e._v(" 为 web 服务创建一个镜像，接着使用这个镜像在容器里运行 "),n("code",[e._v("django-admin.py startproject composeexample")]),e._v(" 指令。")]),e._v(" "),n("p",[e._v("这将在当前目录生成一个 "),n("code",[e._v("Django")]),e._v(" 应用。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    $ ls\n    Dockerfile       docker-compose.yml          django_example       manage.py       requirements.txt\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("p",[e._v("如果你的系统是 Linux,记得更改文件权限。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    sudo chown -R $USER:$USER .\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("首先，我们要为应用设置好数据库的连接信息。用以下内容替换 "),n("code",[e._v("django_example/settings.py")]),e._v(" 文件中 "),n("code",[e._v("DATABASES = ...")]),e._v(" 定义的节点内容。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    DATABASES = {\n        'default': {\n            'ENGINE': 'django.db.backends.postgresql',\n            'NAME': 'postgres',\n            'USER': 'postgres',\n            'HOST': 'db',\n            'PORT': 5432,\n        }\n    }\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br")])]),n("p",[e._v("这些信息是在 "),n("a",{attrs:{href:"https://store.docker.com/images/postgres/",target:"_blank",rel:"noopener noreferrer"}},[e._v("postgres"),n("OutboundLink")],1),e._v(" 镜像固定设置好的。然后，运行 "),n("code",[e._v("docker-compose up")]),e._v(" ：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('    $ docker-compose up\n    \n    django_db_1 is up-to-date\n    Creating django_web_1 ...\n    Creating django_web_1 ... done\n    Attaching to django_db_1, django_web_1\n    db_1   | The files belonging to this database system will be owned by user "postgres".\n    db_1   | This user must also own the server process.\n    db_1   |\n    db_1   | The database cluster will be initialized with locale "en_US.utf8".\n    db_1   | The default database encoding has accordingly been set to "UTF8".\n    db_1   | The default text search configuration will be set to "english".\n    \n    web_1  | Performing system checks...\n    web_1  |\n    web_1  | System check identified no issues (0 silenced).\n    web_1  |\n    web_1  | November 23, 2017 - 06:21:19\n    web_1  | Django version 1.11.7, using settings \'django_example.settings\'\n    web_1  | Starting development server at http://0.0.0.0:8000/\n    web_1  | Quit the server with CONTROL-C.\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br")])]),n("p",[e._v("这个 "),n("code",[e._v("Django")]),e._v(" 应用已经开始在你的 Docker 守护进程里监听着 "),n("code",[e._v("8000")]),e._v(" 端口了。打开 "),n("code",[e._v("127.0.0.1:8000")]),e._v(" 即可看到 "),n("code",[e._v("Django")]),e._v(" 欢迎页面。")]),e._v(" "),n("p",[e._v("你还可以在 Docker 上运行其它的管理命令，例如对于同步数据库结构这种事，在运行完 "),n("code",[e._v("docker-compose up")]),e._v(" 后，在另外一个终端进入文件夹运行以下命令即可：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    $ docker-compose run web python manage.py syncdb\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])])])}),[],!1,null,null,null);s.default=t.exports}}]);