(window.webpackJsonp=window.webpackJsonp||[]).push([[1012],{1708:function(n,s,a){"use strict";a.r(s);var r=a(5),e=Object(r.a)({},(function(){var n=this,s=n.$createElement,a=n._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h1",{attrs:{id:"there-is-no-passwordencoder-mapped"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#there-is-no-passwordencoder-mapped"}},[n._v("#")]),n._v(" There is no PasswordEncoder mapped")]),n._v(" "),a("h2",{attrs:{id:"问题描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题描述"}},[n._v("#")]),n._v(" 问题描述")]),n._v(" "),a("p",[n._v("按照 "),a("RouterLink",{attrs:{to:"/zh/spring-security-oauth2/基于内存存储令牌.html"}},[n._v("基于内存存储令牌")]),n._v(" 配置成功后，携授权码使用 POST 请求认证服务器时，服务器返回错误信息")],1),n._v(" "),a("p",[a("strong",[n._v("版本")])]),n._v(" "),a("ul",[a("li",[n._v("Spring Boot: 2.1.3.RELEASE")]),n._v(" "),a("li",[n._v("Spring Security: 5.1.4.RELEASE")])]),n._v(" "),a("p",[a("strong",[n._v("日志")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('    java.lang.IllegalArgumentException: There is no PasswordEncoder mapped for the id "null"\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("h2",{attrs:{id:"解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[n._v("#")]),n._v(" 解决方案")]),n._v(" "),a("p",[n._v("Spring Security 5.0 之前版本的 "),a("code",[n._v("PasswordEncoder")]),n._v(" 接口默认实现为 "),a("code",[n._v("NoOpPasswordEncoder")]),n._v(" 此时是可以使用明文密码的，在 5.0 之后默认实现类改为 "),a("code",[n._v("DelegatingPasswordEncoder")]),n._v(" 此时密码必须以加密形式存储。")]),n._v(" "),a("h3",{attrs:{id:"application-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#application-yml"}},[n._v("#")]),n._v(" application.yml")]),n._v(" "),a("p",[n._v("删除 "),a("code",[n._v("spring.security")]),n._v(" 相关配置，修改为")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    spring:\n      application:\n        name: oauth2-server\n    \n    server:\n      port: 8080\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br")])]),a("h3",{attrs:{id:"websecurityconfiguration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#websecurityconfiguration"}},[n._v("#")]),n._v(" WebSecurityConfiguration")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('    package com.cmcc.oauth2.server.config;\n    \n    import org.springframework.context.annotation.Bean;\n    import org.springframework.context.annotation.Configuration;\n    import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\n    import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n    import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\n    import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n    import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\n    \n    @Configuration\n    @EnableWebSecurity\n    @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true, jsr250Enabled = true)\n    public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {\n    \n        @Bean\n        public BCryptPasswordEncoder passwordEncoder() {\n            // 设置默认的加密方式\n            return new BCryptPasswordEncoder();\n        }\n    \n        @Override\n        protected void configure(AuthenticationManagerBuilder auth) throws Exception {\n    \n            auth.inMemoryAuthentication()\n                    // 在内存中创建用户并为密码加密\n                    .withUser("user").password(passwordEncoder().encode("123456")).roles("USER")\n                    .and()\n                    .withUser("admin").password(passwordEncoder().encode("123456")).roles("ADMIN");\n    \n        }\n    }\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br")])]),a("h3",{attrs:{id:"authorizationserverconfiguration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#authorizationserverconfiguration"}},[n._v("#")]),n._v(" AuthorizationServerConfiguration")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('    package com.cmcc.oauth2.server.config;\n    \n    import org.springframework.beans.factory.annotation.Autowired;\n    import org.springframework.context.annotation.Configuration;\n    import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\n    import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;\n    import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;\n    import org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;\n    \n    @Configuration\n    @EnableAuthorizationServer\n    public class AuthorizationServerConfiguration extends AuthorizationServerConfigurerAdapter {\n    \n        // 注入 WebSecurityConfiguration 中配置的 BCryptPasswordEncoder\n        @Autowired\n        private BCryptPasswordEncoder passwordEncoder;\n    \n        @Override\n        public void configure(ClientDetailsServiceConfigurer clients) throws Exception {\n            clients\n                    .inMemory()\n                    .withClient("client")\n                    // 还需要为 secret 加密\n                    .secret(passwordEncoder.encode("secret"))\n                    .authorizedGrantTypes("authorization_code")\n                    .scopes("app")\n                    .redirectUris("http://www.cmcc.com");\n    \n        }\n    }\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br")])]),a("h2",{attrs:{id:"测试访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试访问"}},[n._v("#")]),n._v(" 测试访问")]),n._v(" "),a("p",[n._v("通过 CURL 或是 Postman 请求")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('    curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d \'grant_type=authorization_code&code=1JuO6V\' "http://client:secret@localhost:8080/oauth/token"\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/img/20190402232952.png",alt:""}})]),n._v(" "),a("p",[n._v("得到响应结果如下：")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('    {\n        "access_token": "016d8d4a-dd6e-4493-b590-5f072923c413",\n        "token_type": "bearer",\n        "expires_in": 43199,\n        "scope": "app"\n    }\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br")])])])}),[],!1,null,null,null);s.default=e.exports}}]);