(window.webpackJsonp=window.webpackJsonp||[]).push([[176],{875:function(a,s,e){"use strict";e.r(s);var n=e(5),t=Object(n.a)({},(function(){var a=this,s=a.$createElement,e=a._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h1",{attrs:{id:"springcloudalibabasentinel实现熔断和限流"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#springcloudalibabasentinel实现熔断和限流"}},[a._v("#")]),a._v(" SpringCloudAlibabaSentinel实现熔断和限流")]),a._v(" "),e("h2",{attrs:{id:"sentinel"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sentinel"}},[a._v("#")]),a._v(" Sentinel")]),a._v(" "),e("h3",{attrs:{id:"官网"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#官网"}},[a._v("#")]),a._v(" 官网")]),a._v(" "),e("p",[a._v("Github：https://github.com/alibaba/Sentinel")]),a._v(" "),e("p",[a._v("Sentinel：分布式系统的流量防卫兵，相当于Hystrix")]),a._v(" "),e("p",[a._v("Hystrix存在的问题")]),a._v(" "),e("ul",[e("li",[a._v("需要我们程序员自己手工搭建监控平台")]),a._v(" "),e("li",[a._v("没有一套web界面可以给我们进行更加细粒度化的配置，流量控制，速率控制，服务熔断，服务降级。。")])]),a._v(" "),e("p",[a._v("这个时候Sentinel运营而生")]),a._v(" "),e("ul",[e("li",[a._v("单独一个组件，可以独立出来")]),a._v(" "),e("li",[a._v("直接界面化的细粒度统一配置")])]),a._v(" "),e("p",[a._v("约定 > 配置 >编码，都可以写在代码里，但是尽量使用注解和配置代替编码")]),a._v(" "),e("h3",{attrs:{id:"是什么"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#是什么"}},[a._v("#")]),a._v(" 是什么")]),a._v(" "),e("p",[a._v("随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。")]),a._v(" "),e("p",[a._v("Sentinel 具有以下特征:")]),a._v(" "),e("ul",[e("li",[e("strong",[a._v("丰富的应用场景")]),a._v("：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。")]),a._v(" "),e("li",[e("strong",[a._v("完备的实时监控")]),a._v("：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。")]),a._v(" "),e("li",[e("strong",[a._v("广泛的开源生态")]),a._v("：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。")]),a._v(" "),e("li",[e("strong",[a._v("完善的 SPI 扩展点")]),a._v("：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。")])]),a._v(" "),e("h3",{attrs:{id:"主要特征"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主要特征"}},[a._v("#")]),a._v(" 主要特征")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416073841558.png",alt:"image-20200416073841558"}})]),a._v(" "),e("h3",{attrs:{id:"生态圈"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#生态圈"}},[a._v("#")]),a._v(" 生态圈")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416073905426.png",alt:"image-20200416073905426"}})]),a._v(" "),e("h3",{attrs:{id:"下载"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#下载"}},[a._v("#")]),a._v(" 下载")]),a._v(" "),e("p",[a._v("Github：https://github.com/alibaba/Sentinel/releases")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416074923500.png",alt:"image-20200416074923500"}})]),a._v(" "),e("h2",{attrs:{id:"安装sentinel控制台"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装sentinel控制台"}},[a._v("#")]),a._v(" 安装Sentinel控制台")]),a._v(" "),e("p",[a._v("sentinel组件由两部分组成，后台和前台8080")]),a._v(" "),e("p",[a._v("Sentinel分为两部分")]),a._v(" "),e("ul",[e("li",[a._v("核心库（Java客户端）不依赖任何框架/库，能够运行在所有Java运行时环境，同时对Dubbo、SpringCloud等框架也有较好的支持。")]),a._v(" "),e("li",[a._v("控制台（Dashboard）基于SpringBoot开发，打包后可以直接运行，不需要额外的Tomcat等应用容器")])]),a._v(" "),e("p",[a._v("使用 "),e("code",[a._v("java -jar")]),a._v(" 启动，同时Sentinel默认的端口号是8080，因此不能被占用")]),a._v(" "),e("p",[a._v("注意，下载时候，由于Github经常抽风，因此可以使用Gitee进行下，首先先去Gitee下载源码")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416080109354.png",alt:"image-20200416080109354"}})]),a._v(" "),e("p",[a._v("然后执行"),e("code",[a._v("mvn package")]),a._v(" 进行构建，本博客同级目录下了，已经有个已经下载好的，欢迎自取")]),a._v(" "),e("h2",{attrs:{id:"初始化演示工程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#初始化演示工程"}},[a._v("#")]),a._v(" 初始化演示工程")]),a._v(" "),e("p",[a._v("启动Nacos8848成功")]),a._v(" "),e("h3",{attrs:{id:"引入依赖"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#引入依赖"}},[a._v("#")]),a._v(" 引入依赖")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("\x3c!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到--\x3e\n<dependency>\n    <groupId>com.alibaba.csp</groupId>\n    <artifactId>sentinel-datasource-nacos</artifactId>\n</dependency>\n\n\x3c!--SpringCloud ailibaba sentinel --\x3e\n<dependency>\n    <groupId>com.alibaba.cloud</groupId>\n    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>\n</dependency>\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br")])]),e("h3",{attrs:{id:"修改yml"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改yml"}},[a._v("#")]),a._v(" 修改YML")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("server:\n  port: 8401\n\nspring:\n  application:\n    name: cloudalibaba-sentinel-service\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848 #Nacos服务注册中心地址\n    sentinel:\n      transport:\n        dashboard: localhost:8080 #配置Sentinel dashboard地址\n        port: 8719\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br"),e("span",{staticClass:"line-number"},[a._v("14")]),e("br")])]),e("h3",{attrs:{id:"增加业务类"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#增加业务类"}},[a._v("#")]),a._v(" 增加业务类")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('@RestController\n@Slf4j\npublic class FlowLimitController\n{\n    @GetMapping("/testA")\n    public String testA()\n    {\n        return "------testA";\n    }\n\n    @GetMapping("/testB")\n    public String testB()\n    {\n        log.info(Thread.currentThread().getName()+"\\t"+"...testB");\n        return "------testB";\n    }\n}\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br"),e("span",{staticClass:"line-number"},[a._v("14")]),e("br"),e("span",{staticClass:"line-number"},[a._v("15")]),e("br"),e("span",{staticClass:"line-number"},[a._v("16")]),e("br"),e("span",{staticClass:"line-number"},[a._v("17")]),e("br")])]),e("p",[a._v("启动8401微服务，查看Sentinel控制台")]),a._v(" "),e("p",[a._v("我们会发现Sentinel里面空空如也，什么也没有，这是因为Sentinel采用的懒加载")]),a._v(" "),e("p",[a._v("执行一下访问即可："),e("code",[a._v("http://localhost:8401/testA")]),a._v(" "),e("code",[a._v("http://localhost:8401/testB")])]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416083940979.png",alt:"image-20200416083940979"}})]),a._v(" "),e("h2",{attrs:{id:"流控规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#流控规则"}},[a._v("#")]),a._v(" 流控规则")]),a._v(" "),e("h3",{attrs:{id:"基本介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基本介绍"}},[a._v("#")]),a._v(" 基本介绍")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416084144709.png",alt:"image-20200416084144709"}})]),a._v(" "),e("p",[e("strong",[a._v("字段说明")])]),a._v(" "),e("ul",[e("li",[a._v("资源名：唯一名称，默认请求路径")]),a._v(" "),e("li",[a._v("针对来源：Sentinel可以针对调用者进行限流，填写微服务名，默认default（不区分来源）")]),a._v(" "),e("li",[a._v("阈值类型 / 单机阈值\n"),e("ul",[e("li",[a._v("QPS：（每秒钟的请求数量）：但调用该API的QPS达到阈值的时候，进行限流")]),a._v(" "),e("li",[a._v("线程数：当调用该API的线程数达到阈值的时候，进行限流")])])]),a._v(" "),e("li",[a._v("是否集群：不需要集群")]),a._v(" "),e("li",[a._v("流控模式\n"),e("ul",[e("li",[a._v("直接：api都达到限流条件时，直接限流")]),a._v(" "),e("li",[a._v("关联：当关联的资源达到阈值，就限流自己")]),a._v(" "),e("li",[a._v("链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）【API级别的针对来源】")])])]),a._v(" "),e("li",[a._v("流控效果\n"),e("ul",[e("li",[a._v("快速失败：直接失败，抛异常")]),a._v(" "),e("li",[a._v("Warm UP：根据codeFactory（冷加载因子，默认3），从阈值/CodeFactor，经过预热时长，才达到设置的QPS阈值")]),a._v(" "),e("li",[a._v("排队等待：匀速排队，让请求以匀速的速度通过，阈值类型必须设置QPS，否则无效")])])])]),a._v(" "),e("h3",{attrs:{id:"流控模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#流控模式"}},[a._v("#")]),a._v(" 流控模式")]),a._v(" "),e("h4",{attrs:{id:"直接-默认"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#直接-默认"}},[a._v("#")]),a._v(" 直接（默认）")]),a._v(" "),e("p",[a._v("我们给testA增加流控")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416084934271.png",alt:"image-20200416084934271"}})]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416085039034.png",alt:"image-20200416085039034"}})]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416085226574.png",alt:"image-20200416085226574"}})]),a._v(" "),e("p",[a._v("然后我们请求 "),e("code",[a._v("http://localhost:8401/testA")]),a._v("，就会出现失败，被限流，快速失败")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416085117306.png",alt:"image-20200416085117306"}})]),a._v(" "),e("p",[a._v("思考：")]),a._v(" "),e("p",[a._v("直接调用的是默认报错信息，能否有我们的后续处理，比如更加友好的提示，类似有hystrix的fallback方法")]),a._v(" "),e("p",[a._v("线程数")]),a._v(" "),e("p",[a._v("这里的线程数表示一次只有一个线程进行业务请求，当前出现请求无法响应的时候，会直接报错，例如，在方法的内部增加一个睡眠，那么后面来的就会失败")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('    @GetMapping("/testD")\n    public String testD()\n    {\n        try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { e.printStackTrace(); }\n        return "------testD";\n    }\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br")])]),e("h4",{attrs:{id:"关联"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#关联"}},[a._v("#")]),a._v(" 关联")]),a._v(" "),e("p",[a._v("当关联的资源达到阈值时，就限流自己")]),a._v(" "),e("p",[a._v("当与A关联的资源B达到阈值后，就限流A自己，B惹事，A挂了")]),a._v(" "),e("p",[a._v("场景：支付接口达到阈值后，就限流下订单的接口")]),a._v(" "),e("p",[a._v("设置：")]),a._v(" "),e("p",[a._v("当关联资源 /testB的QPS达到阈值超过1时，就限流/testA的Rest访问地址，当关联资源达到阈值后，限制配置好的资源名")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416090827339.png",alt:"image-20200416090827339"}})]),a._v(" "),e("p",[a._v("这个使用我们利用postman模拟并发密集访问"),e("code",[a._v("testB")])]),a._v(" "),e("p",[a._v("首先我们需要使用postman，创建一个请求")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416091302584.png",alt:"image-20200416091302584"}})]),a._v(" "),e("p",[a._v("同时将请求保存在 Collection中")]),a._v(" "),e("p",[a._v("然后点击箭头，选中接口，选择run")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416091349552.png",alt:"image-20200416091349552"}})]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416091517551.png",alt:"image-20200416091517551"}})]),a._v(" "),e("p",[a._v("点击运行，大批量线程高并发访问B，导致A失效了，同时我们点击访问 "),e("code",[a._v("http://localhost:8401/testA")]),a._v("，结果发现，我们的A已经挂了")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416091801271.png",alt:"image-20200416091801271"}})]),a._v(" "),e("p",[a._v("在测试A接口")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416091815140.png",alt:"image-20200416091815140"}})]),a._v(" "),e("p",[a._v("这就是我们的关联限流")]),a._v(" "),e("h4",{attrs:{id:"链路"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#链路"}},[a._v("#")]),a._v(" 链路")]),a._v(" "),e("p",[a._v("多个请求调用了同一个微服务")]),a._v(" "),e("h3",{attrs:{id:"流控效果"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#流控效果"}},[a._v("#")]),a._v(" 流控效果")]),a._v(" "),e("h4",{attrs:{id:"直接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#直接"}},[a._v("#")]),a._v(" 直接")]),a._v(" "),e("p",[a._v("快速失败，默认的流控处理")]),a._v(" "),e("ul",[e("li",[a._v("直接失败，抛出异常：Blocked by Sentinel（Flow limiting）")])]),a._v(" "),e("h4",{attrs:{id:"预热"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#预热"}},[a._v("#")]),a._v(" 预热")]),a._v(" "),e("p",[a._v("系统最怕的就是出现，平时访问是0，然后突然一瞬间来了10W的QPS")]),a._v(" "),e("p",[a._v("公式：阈值 除以 clodFactor（默认值为3），经过预热时长后，才会达到阈值")]),a._v(" "),e("p",[a._v("Warm Up方式，即预热/冷启动方式，当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能会瞬间把系统压垮。通过冷启动，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值，给冷系统一个预热的时间，避免冷系统被压垮。通常冷启动的过程系统允许的QPS曲线如下图所示")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416093702689.png",alt:"image-20200416093702689"}})]),a._v(" "),e("p",[a._v("默认clodFactor为3，即请求QPS从threshold / 3开始，经预热时长逐渐提升至设定的QPS阈值")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416093919458.png",alt:"image-20200416093919458"}})]),a._v(" "),e("p",[a._v("假设这个系统的QPS是10，那么最开始系统能够接受的 QPS  = 10 / 3 = 3，然后从3逐渐在5秒内提升到10")]),a._v(" "),e("p",[a._v("应用场景：")]),a._v(" "),e("p",[a._v("秒杀系统在开启的瞬间，会有很多流量上来，很可能把系统打死，预热的方式就是为了保护系统，可能慢慢的把流量放进来，慢慢的把阈值增长到设置的阈值。")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416094419813.png",alt:"image-20200416094419813"}})]),a._v(" "),e("h4",{attrs:{id:"排队等待"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#排队等待"}},[a._v("#")]),a._v(" 排队等待")]),a._v(" "),e("p",[a._v("大家均速排队，让请求以均匀的速度通过，阈值类型必须设置成QPS，否则无效")]),a._v(" "),e("p",[a._v("均速排队方式必须严格控制请求通过的间隔时间，也即让请求以匀速的速度通过，对应的是漏桶算法。")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416094734543.png",alt:"image-20200416094734543"}})]),a._v(" "),e("p",[a._v("这种方式主要用于处理间隔性突发的流量，例如消息队列，想象一下这样的场景，在某一秒有大量的请求到来，而接下来的几秒处于空闲状态，我们系统系统能够接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。")]),a._v(" "),e("p",[a._v("设置含义：/testA 每秒1次请求，超过的话，就排队等待，等待时间超过20000毫秒")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416094609143.png",alt:"image-20200416094609143"}})]),a._v(" "),e("h2",{attrs:{id:"降级规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#降级规则"}},[a._v("#")]),a._v(" 降级规则")]),a._v(" "),e("h3",{attrs:{id:"名词介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#名词介绍"}},[a._v("#")]),a._v(" 名词介绍")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416095515859.png",alt:"image-20200416095515859"}})]),a._v(" "),e("ul",[e("li",[e("p",[a._v("RT（平均响应时间，秒级）")]),a._v(" "),e("ul",[e("li",[a._v("平均响应时间，超过阈值 且 时间窗口内通过的请求 >= 5，两个条件同时满足后出发降级")]),a._v(" "),e("li",[a._v("窗口期过后，关闭断路器")]),a._v(" "),e("li",[a._v("RT最大4900（更大的需要通过 -Dcsp.sentinel.staticstic.max.rt=XXXXX才能生效）")])])]),a._v(" "),e("li",[e("p",[a._v("异常比例（秒级）")]),a._v(" "),e("ul",[e("li",[a._v("QPA >= 5 且异常比例（秒级）超过阈值时，触发降级；时间窗口结束后，关闭降级")])])]),a._v(" "),e("li",[e("p",[a._v("异常数（分钟级）")]),a._v(" "),e("ul",[e("li",[a._v("异常数（分钟统计）超过阈值时，触发降级，时间窗口结束后，关闭降级")])])])]),a._v(" "),e("h3",{attrs:{id:"概念"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#概念"}},[a._v("#")]),a._v(" 概念")]),a._v(" "),e("p",[a._v("Sentinel熔断降级会在调用链路中某个资源出现不稳定状态时（例如调用超时或异常异常比例升高），对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联错误。")]),a._v(" "),e("p",[a._v("当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都进行自动熔断（默认行为是抛出DegradeException）")]),a._v(" "),e("p",[a._v("Sentinel的断路器是没有半开状态")]),a._v(" "),e("p",[a._v("半开的状态，系统自动去检测是否请求有异常，没有异常就关闭断路器恢复使用，有异常则继续打开断路器不可用，具体可以参考hystrix")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416100340083.png",alt:"image-20200416100340083"}})]),a._v(" "),e("h3",{attrs:{id:"降级策略实战"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#降级策略实战"}},[a._v("#")]),a._v(" 降级策略实战")]),a._v(" "),e("h4",{attrs:{id:"rt"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#rt"}},[a._v("#")]),a._v(" RT")]),a._v(" "),e("p",[a._v("平均响应时间 ("),e("code",[a._v("DEGRADE_GRADE_RT")]),a._v(")：当 1s 内持续进入 N 个请求，对应时刻的平均响应时间（秒级）均超过阈值（"),e("code",[a._v("count")]),a._v("，以 ms 为单位），那么在接下的时间窗口（"),e("code",[a._v("DegradeRule")]),a._v(" 中的 "),e("code",[a._v("timeWindow")]),a._v("，以 s 为单位）之内，对这个方法的调用都会自动地熔断（抛出 "),e("code",[a._v("DegradeException")]),a._v("）。注意 Sentinel 默认统计的 RT 上限是 4900 ms，"),e("strong",[a._v("超出此阈值的都会算作 4900 ms")]),a._v("，若需要变更此上限可以通过启动配置项 "),e("code",[a._v("-Dcsp.sentinel.statistic.max.rt=xxx")]),a._v(" 来配置。")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416102754797.png",alt:"image-20200416102754797"}})]),a._v(" "),e("p",[a._v("代码测试")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('    @GetMapping("/testD")\n    public String testD()\n    {\n        try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { e.printStackTrace(); }\n        log.info("testD 异常比例");\n        return "------testD";\n    }\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br")])]),e("p",[a._v("然后使用Jmeter压力测试工具进行测试")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416103619799.png",alt:"image-20200416103619799"}})]),a._v(" "),e("p",[a._v("按照上述操作，永远1秒种打进来10个线程，大于5个了，调用tesetD，我们希望200毫秒内处理完本次任务，如果200毫秒没有处理完，在未来的1秒的时间窗口内，断路器打开（保险丝跳闸）微服务不可用，保险丝跳闸断电")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("Blocked by Sentinel (flow limiting)\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"/images/image-20200416103959047.png",alt:"image-20200416103959047"}})]),a._v(" "),e("p",[a._v("后续我们停止使用jmeter，没有那么大的访问量了，断路器关闭（保险丝恢复），微服务恢复OK")]),a._v(" "),e("h4",{attrs:{id:"异常比例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#异常比例"}},[a._v("#")]),a._v(" 异常比例")]),a._v(" "),e("p",[a._v("异常比例 ("),e("code",[a._v("DEGRADE_GRADE_EXCEPTION_RATIO")]),a._v(")：当资源的每秒请求量 >= N（可配置），并且每秒异常总数占通过量的比值超过阈值（"),e("code",[a._v("DegradeRule")]),a._v(" 中的 "),e("code",[a._v("count")]),a._v("）之后，资源进入降级状态，即在接下的时间窗口（"),e("code",[a._v("DegradeRule")]),a._v(" 中的 "),e("code",[a._v("timeWindow")]),a._v("，以 s 为单位）之内，对这个方法的调用都会自动地返回。异常比率的阈值范围是 "),e("code",[a._v("[0.0, 1.0]")]),a._v("，代表 0% - 100%。")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416104157714.png",alt:"image-20200416104157714"}})]),a._v(" "),e("p",[a._v("单独访问一次，必然来一次报错一次，开启jmeter后，直接高并发发送请求，多次调用达到我们的配置条件了，断路器开启（保险丝跳闸），微服务不可用，不在报错，而是服务降级了")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416104919798.png",alt:"image-20200416104919798"}})]),a._v(" "),e("p",[a._v("设置3秒内，如果请求百分50出错，那么就会熔断")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416104908479.png",alt:"image-20200416104908479"}})]),a._v(" "),e("p",[a._v("我们用jmeter每秒发送10次请求，3秒后，再次调用  "),e("code",[a._v("localhost:8401/testD")]),a._v(" 出现服务降级")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416104858019.png",alt:"image-20200416104858019"}})]),a._v(" "),e("h4",{attrs:{id:"异常数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#异常数"}},[a._v("#")]),a._v(" 异常数")]),a._v(" "),e("p",[a._v("异常数 ("),e("code",[a._v("DEGRADE_GRADE_EXCEPTION_COUNT")]),a._v(")：当资源近 1 分钟的异常数目超过阈值之后会进行熔断。注意由于统计时间窗口是分钟级别的，若 "),e("code",[a._v("timeWindow")]),a._v(" 小于 60s，则结束熔断状态后仍可能再进入熔断状态")]),a._v(" "),e("p",[a._v("时间窗口一定要大于等于60秒")]),a._v(" "),e("p",[a._v("异常数是按分钟来统计的")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416105132256.png",alt:"image-20200416105132256"}})]),a._v(" "),e("p",[a._v("下面设置是，一分钟内出现5次，则熔断")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416105535535.png",alt:"image-20200416105535535"}})]),a._v(" "),e("p",[a._v("首先我们再次访问 "),e("code",[a._v("http://localhost:8401/testE")]),a._v("，第一次访问绝对报错，因为除数不能为0，我们看到error窗口，但是达到5次报错后，进入熔断后的降级")]),a._v(" "),e("h2",{attrs:{id:"sentinel热点规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sentinel热点规则"}},[a._v("#")]),a._v(" Sentinel热点规则")]),a._v(" "),e("h3",{attrs:{id:"什么是热点数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#什么是热点数据"}},[a._v("#")]),a._v(" 什么是热点数据")]),a._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/alibaba/Sentinel/wiki/%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81",target:"_blank",rel:"noopener noreferrer"}},[a._v("Github文档传送门"),e("OutboundLink")],1)]),a._v(" "),e("p",[a._v("何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：")]),a._v(" "),e("ul",[e("li",[a._v("商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制")]),a._v(" "),e("li",[a._v("用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制")])]),a._v(" "),e("p",[a._v("热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416121306501.png",alt:"image-20200416121306501"}})]),a._v(" "),e("p",[a._v("Sentinel 利用 LRU 策略统计最近最常访问的热点参数，结合令牌桶算法来进行参数级别的流控。热点参数限流支持集群模式。")]),a._v(" "),e("h3",{attrs:{id:"兜底的方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#兜底的方法"}},[a._v("#")]),a._v(" 兜底的方法")]),a._v(" "),e("p",[a._v("分为系统默认的和客户自定义的，两种，之前的case中，限流出现问题了，都用sentinel系统默认的提示：Blocked By Sentinel，我们能不能自定义，类似于hystrix，某个方法出现问题了，就找到对应的兜底降级方法。")]),a._v(" "),e("p",[a._v("从 "),e("code",[a._v("@HystrixCommand")]),a._v(" 到 "),e("code",[a._v("@SentinelResource")])]),a._v(" "),e("h3",{attrs:{id:"配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[a._v("#")]),a._v(" 配置")]),a._v(" "),e("p",[a._v("@SentinelResource的value，就是我们的资源名，也就是对哪个方法配置热点规则")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('    @GetMapping("/testHotKey")\n    @SentinelResource(value = "testHotKey",blockHandler = "deal_testHotKey")\n    public String testHotKey(@RequestParam(value = "p1",required = false) String p1,\n                             @RequestParam(value = "p2",required = false) String p2)\n    {\n        //int age = 10/0;\n        return "------testHotKey";\n    }\n    \n    // 和上面的参数一样，不错需要加入 BlockException\n    public String deal_testHotKey (String p1, String p2, BlockException exception)\n    {\n        return "------deal_testHotKey,o(╥﹏╥)o";  //  兜底的方法\n    }\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br"),e("span",{staticClass:"line-number"},[a._v("14")]),e("br")])]),e("p",[a._v("我们对参数0，设置热点key进行限流")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416122406091.png",alt:"image-20200416122406091"}})]),a._v(" "),e("p",[a._v("配置完成后")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416122450886.png",alt:"image-20200416122450886"}})]),a._v(" "),e("p",[a._v("当我们不断的请求时候，也就是以第一个参数为目标，请求接口，我们会发现多次请求后")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("http://localhost:8401/testHotKey?p1=a\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("就会出现以下的兜底错误")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("------deal_testHotKey,o(╥﹏╥)o\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("这是因为我们针对第一个参数进行了限制，当我们QPS超过1的时候，就会触发兜底的错误")]),a._v(" "),e("p",[a._v("假设我们请求的接口是："),e("code",[a._v("http://localhost:8401/testHotKey?p2=a")]),a._v(" ，我们会发现他就没有进行限流")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416123605410.png",alt:"image-20200416123605410"}})]),a._v(" "),e("h3",{attrs:{id:"参数例外项"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参数例外项"}},[a._v("#")]),a._v(" 参数例外项")]),a._v(" "),e("p",[a._v("上述案例演示了第一个参数p1，当QPS超过1秒1次点击狗，马上被限流")]),a._v(" "),e("ul",[e("li",[a._v("普通：超过一秒1个后，达到阈值1后马上被限流")]),a._v(" "),e("li",[a._v("我们期望p1参数当它达到某个特殊值时，它的限流值和平时不一样")]),a._v(" "),e("li",[a._v("特例：假设当p1的值等于5时，它的阈值可以达到200")]),a._v(" "),e("li",[a._v("一句话说：当key为特殊值的时候，不被限制")])]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416123922325.png",alt:"image-20200416123922325"}})]),a._v(" "),e("p",[a._v("平时的时候，参数1的QPS是1，超过的时候被限流，但是有特殊值，比如5，那么它的阈值就是200")]),a._v(" "),e("p",[a._v("我们通过 "),e("code",[a._v("http://localhost:8401/testHotKey?p1=5")]),a._v(" 一直刷新，发现不会触发兜底的方法，这就是参数例外项")]),a._v(" "),e("p",[a._v("热点参数的注意点，参数必须是基本类型或者String")]),a._v(" "),e("h3",{attrs:{id:"结语"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#结语"}},[a._v("#")]),a._v(" 结语")]),a._v(" "),e("p",[e("code",[a._v("@SentinelResource")]),a._v(" 处理的是Sentinel控制台配置的违规情况，有blockHandler方法配置的兜底处理")]),a._v(" "),e("p",[a._v("RuntimeException，如  int a = 10/0 ; 这个是java运行时抛出的异常，RuntimeException，@RentinelResource不管")]),a._v(" "),e("p",[a._v("也就是说："),e("code",[a._v("@SentinelResource")]),a._v(" 主管配置出错，运行出错不管。")]),a._v(" "),e("p",[a._v("如果想要有配置出错，和运行出错的话，那么可以设置 fallback")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('    @GetMapping("/testHotKey")\n    @SentinelResource(value = "testHotKey",blockHandler = "deal_testHotKey", fallback = "fallBack")\n    public String testHotKey(@RequestParam(value = "p1",required = false) String p1,\n                             @RequestParam(value = "p2",required = false) String p2)\n    {\n        //int age = 10/0;\n        return "------testHotKey";\n    }\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br")])]),e("h2",{attrs:{id:"sentinel系统配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sentinel系统配置"}},[a._v("#")]),a._v(" Sentinel系统配置")]),a._v(" "),e("p",[a._v("Sentinel 系统自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。")]),a._v(" "),e("p",[a._v("系统保护规则是从应用级别的入口流量进行控制，从单台机器的 load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。")]),a._v(" "),e("p",[a._v("系统保护规则是应用整体维度的，而不是资源维度的，并且"),e("strong",[a._v("仅对入口流量生效")]),a._v("。入口流量指的是进入应用的流量（"),e("code",[a._v("EntryType.IN")]),a._v("），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。")]),a._v(" "),e("p",[a._v("系统规则支持以下的模式：")]),a._v(" "),e("ul",[e("li",[e("strong",[a._v("Load 自适应")]),a._v("（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 "),e("code",[a._v("maxQps * minRt")]),a._v(" 估算得出。设定参考值一般是 "),e("code",[a._v("CPU cores * 2.5")]),a._v("。")]),a._v(" "),e("li",[e("strong",[a._v("CPU usage")]),a._v("（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。")]),a._v(" "),e("li",[e("strong",[a._v("平均 RT")]),a._v("：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。")]),a._v(" "),e("li",[e("strong",[a._v("并发线程数")]),a._v("：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。")]),a._v(" "),e("li",[e("strong",[a._v("入口 QPS")]),a._v("：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。")])]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416144836658.png",alt:"image-20200416144836658"}})]),a._v(" "),e("p",[a._v("这样相当于设置了全局的QPS过滤")]),a._v(" "),e("h2",{attrs:{id:"sentinelresource注解"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sentinelresource注解"}},[a._v("#")]),a._v(" @SentinelResource注解")]),a._v(" "),e("ul",[e("li",[a._v("按资源名称限流 + 后续处理")]),a._v(" "),e("li",[a._v("按URL地址限流 + 后续处理")])]),a._v(" "),e("h3",{attrs:{id:"问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[a._v("#")]),a._v(" 问题")]),a._v(" "),e("ul",[e("li",[a._v("系统默认的，没有体现我们自己的业务要求")]),a._v(" "),e("li",[a._v("依照现有条件，我们自定义的处理方法又和业务代码耦合在一块，不直观")]),a._v(" "),e("li",[a._v("每个业务方法都添加一个兜底方法，那代码膨胀加剧")]),a._v(" "),e("li",[a._v("全局统一的处理方法没有体现")]),a._v(" "),e("li",[a._v("关闭8401，发现流控规则已经消失，说明这个是没有持久化")])]),a._v(" "),e("h3",{attrs:{id:"客户自定义限流处理逻辑"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#客户自定义限流处理逻辑"}},[a._v("#")]),a._v(" 客户自定义限流处理逻辑")]),a._v(" "),e("p",[a._v("创建CustomerBlockHandler类用于自定义限流处理逻辑")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('public class CustomerBlockHandler\n{\n    public static CommonResult handlerException(BlockException exception)\n    {\n        return new CommonResult(4444,"按客戶自定义,global handlerException----1");\n    }\n    public static CommonResult handlerException2(BlockException exception)\n    {\n        return new CommonResult(4444,"按客戶自定义,global handlerException----2");\n    }\n}\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br")])]),e("p",[a._v("那么我们在使用的时候，就可以首先指定是哪个类，哪个方法")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('    @GetMapping("/rateLimit/customerBlockHandler")\n    @SentinelResource(value = "customerBlockHandler",\n            blockHandlerClass = CustomerBlockHandler.class,\n            blockHandler = "handlerException2")\n    public CommonResult customerBlockHandler()\n    {\n        return new CommonResult(200,"按客戶自定义",new Payment(2020L,"serial003"));\n    }\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br")])]),e("p",[e("img",{attrs:{src:"/images/image-20200416150947457.png",alt:"image-20200416150947457"}})]),a._v(" "),e("h3",{attrs:{id:"更多注解属性说明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#更多注解属性说明"}},[a._v("#")]),a._v(" 更多注解属性说明")]),a._v(" "),e("p",[a._v("所有的代码都要用try - catch - finally 进行处理")]),a._v(" "),e("p",[a._v("sentinel主要有三个核心API")]),a._v(" "),e("ul",[e("li",[a._v("Sphu定义资源")]),a._v(" "),e("li",[a._v("Tracer定义统计")]),a._v(" "),e("li",[a._v("ContextUtil定义了上下文")])]),a._v(" "),e("h2",{attrs:{id:"服务熔断"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#服务熔断"}},[a._v("#")]),a._v(" 服务熔断")]),a._v(" "),e("p",[a._v("sentinel整合Ribbon + openFeign + fallback")]),a._v(" "),e("p",[a._v("搭建 9003 和 9004 服务提供者")]),a._v(" "),e("h3",{attrs:{id:"不设置任何参数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#不设置任何参数"}},[a._v("#")]),a._v(" 不设置任何参数")]),a._v(" "),e("p",[a._v("然后在使用 84作为服务消费者，当我们值使用 "),e("code",[a._v("@SentinelResource")]),a._v("注解时，不添加任何参数，那么如果出错的话，是直接返回一个error页面，对前端用户非常不友好，因此我们需要配置一个兜底的方法")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('    @RequestMapping("/consumer/fallback/{id}")\n    @SentinelResource(value = "fallback") //没有配置\n    public CommonResult<Payment> fallback(@PathVariable Long id)\n    {\n        CommonResult<Payment> result = restTemplate.getForObject(SERVICE_URL + "/paymentSQL/"+id,CommonResult.class,id);\n\n        if (id == 4) {\n            throw new IllegalArgumentException ("IllegalArgumentException,非法参数异常....");\n        }else if (result.getData() == null) {\n            throw new NullPointerException ("NullPointerException,该ID没有对应记录,空指针异常");\n        }\n\n        return result;\n    }\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br"),e("span",{staticClass:"line-number"},[a._v("14")]),e("br")])]),e("h3",{attrs:{id:"设置fallback"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#设置fallback"}},[a._v("#")]),a._v(" 设置fallback")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('    @RequestMapping("/consumer/fallback/{id}")\n    @SentinelResource(value = "fallback",fallback = "handlerFallback") //fallback只负责业务异常\n    public CommonResult<Payment> fallback(@PathVariable Long id)\n    {\n        CommonResult<Payment> result = restTemplate.getForObject(SERVICE_URL + "/paymentSQL/"+id,CommonResult.class,id);\n\n        if (id == 4) {\n            throw new IllegalArgumentException ("IllegalArgumentException,非法参数异常....");\n        }else if (result.getData() == null) {\n            throw new NullPointerException ("NullPointerException,该ID没有对应记录,空指针异常");\n        }\n\n        return result;\n    }\n    \n    //本例是fallback\n    public CommonResult handlerFallback(@PathVariable  Long id,Throwable e) {\n        Payment payment = new Payment(id,"null");\n        return new CommonResult<>(444,"兜底异常handlerFallback,exception内容  "+e.getMessage(),payment);\n    }\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br"),e("span",{staticClass:"line-number"},[a._v("14")]),e("br"),e("span",{staticClass:"line-number"},[a._v("15")]),e("br"),e("span",{staticClass:"line-number"},[a._v("16")]),e("br"),e("span",{staticClass:"line-number"},[a._v("17")]),e("br"),e("span",{staticClass:"line-number"},[a._v("18")]),e("br"),e("span",{staticClass:"line-number"},[a._v("19")]),e("br"),e("span",{staticClass:"line-number"},[a._v("20")]),e("br")])]),e("p",[a._v("加入fallback后，当我们程序运行出错时，我们会有一个兜底的异常执行，但是服务限流和熔断的异常还是出现默认的")]),a._v(" "),e("h3",{attrs:{id:"设置blockhandler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#设置blockhandler"}},[a._v("#")]),a._v(" 设置blockHandler")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('    @RequestMapping("/consumer/fallback/{id}")\n    @SentinelResource(value = "fallback",blockHandler = "blockHandler" ,fallback = "handlerFallback") //blockHandler只负责sentinel控制台配置违规\n    public CommonResult<Payment> fallback(@PathVariable Long id)\n    {\n        CommonResult<Payment> result = restTemplate.getForObject(SERVICE_URL + "/paymentSQL/"+id,CommonResult.class,id);\n\n        if (id == 4) {\n            throw new IllegalArgumentException ("IllegalArgumentException,非法参数异常....");\n        }else if (result.getData() == null) {\n            throw new NullPointerException ("NullPointerException,该ID没有对应记录,空指针异常");\n        }\n\n        return result;\n    }\n    \n    //本例是blockHandler\n    public CommonResult blockHandler(@PathVariable  Long id,BlockException blockException) {\n        Payment payment = new Payment(id,"null");\n        return new CommonResult<>(445,"blockHandler-sentinel限流,无此流水: blockException  "+blockException.getMessage(),payment);\n    }\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br"),e("span",{staticClass:"line-number"},[a._v("14")]),e("br"),e("span",{staticClass:"line-number"},[a._v("15")]),e("br"),e("span",{staticClass:"line-number"},[a._v("16")]),e("br"),e("span",{staticClass:"line-number"},[a._v("17")]),e("br"),e("span",{staticClass:"line-number"},[a._v("18")]),e("br"),e("span",{staticClass:"line-number"},[a._v("19")]),e("br"),e("span",{staticClass:"line-number"},[a._v("20")]),e("br")])]),e("h3",{attrs:{id:"blockhandler和fallback一起配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#blockhandler和fallback一起配置"}},[a._v("#")]),a._v(" blockHandler和fallback一起配置")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('    @RequestMapping("/consumer/fallback/{id}")\n    @SentinelResource(value = "fallback",blockHandler = "blockHandler") //blockHandler只负责sentinel控制台配置违规\n    public CommonResult<Payment> fallback(@PathVariable Long id)\n    {\n        CommonResult<Payment> result = restTemplate.getForObject(SERVICE_URL + "/paymentSQL/"+id,CommonResult.class,id);\n\n        if (id == 4) {\n            throw new IllegalArgumentException ("IllegalArgumentException,非法参数异常....");\n        }else if (result.getData() == null) {\n            throw new NullPointerException ("NullPointerException,该ID没有对应记录,空指针异常");\n        }\n        return result;\n    }\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br")])]),e("p",[a._v("若blockHandler 和 fallback都进行了配置，则被限流降级而抛出 BlockException时，只会进入blockHandler处理逻辑")]),a._v(" "),e("h3",{attrs:{id:"异常忽略"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#异常忽略"}},[a._v("#")]),a._v(" 异常忽略")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416213834495.png",alt:"image-20200416213834495"}})]),a._v(" "),e("h2",{attrs:{id:"feign系列"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#feign系列"}},[a._v("#")]),a._v(" Feign系列")]),a._v(" "),e("h4",{attrs:{id:"引入依赖-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#引入依赖-2"}},[a._v("#")]),a._v(" 引入依赖")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("\x3c!--SpringCloud openfeign --\x3e\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-openfeign</artifactId>\n</dependency>\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br")])]),e("h4",{attrs:{id:"修改yml-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改yml-2"}},[a._v("#")]),a._v(" 修改YML")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("server:\n  port: 84\n\nspring:\n  application:\n    name: nacos-order-consumer\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n    sentinel:\n      transport:\n        #配置Sentinel dashboard地址\n        dashboard: localhost:8080\n        #默认8719端口，假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口\n        port: 8719\n\n#消费者将要去访问的微服务名称(注册成功进nacos的微服务提供者)\nservice-url:\n  nacos-user-service: http://nacos-payment-provider\n\n# 激活Sentinel对Feign的支持\nfeign:\n  sentinel:\n    enabled: true\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br"),e("span",{staticClass:"line-number"},[a._v("14")]),e("br"),e("span",{staticClass:"line-number"},[a._v("15")]),e("br"),e("span",{staticClass:"line-number"},[a._v("16")]),e("br"),e("span",{staticClass:"line-number"},[a._v("17")]),e("br"),e("span",{staticClass:"line-number"},[a._v("18")]),e("br"),e("span",{staticClass:"line-number"},[a._v("19")]),e("br"),e("span",{staticClass:"line-number"},[a._v("20")]),e("br"),e("span",{staticClass:"line-number"},[a._v("21")]),e("br"),e("span",{staticClass:"line-number"},[a._v("22")]),e("br"),e("span",{staticClass:"line-number"},[a._v("23")]),e("br"),e("span",{staticClass:"line-number"},[a._v("24")]),e("br"),e("span",{staticClass:"line-number"},[a._v("25")]),e("br")])]),e("h4",{attrs:{id:"启动类激活feign"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启动类激活feign"}},[a._v("#")]),a._v(" 启动类激活Feign")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("@EnableDiscoveryClient\n@SpringBootApplication\n@EnableFeignClients\npublic class OrderNacosMain84\n{\n    public static void main(String[] args) {\n        SpringApplication.run(OrderNacosMain84.class, args);\n    }\n}\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br")])]),e("h4",{attrs:{id:"引入feign接口"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#引入feign接口"}},[a._v("#")]),a._v(" 引入Feign接口")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('@FeignClient(value = "nacos-payment-provider",fallback = PaymentFallbackService.class)\npublic interface PaymentService\n{\n    @GetMapping(value = "/paymentSQL/{id}")\n    public CommonResult<Payment> paymentSQL(@PathVariable("id") Long id);\n}\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br")])]),e("h4",{attrs:{id:"加入fallback兜底方法实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#加入fallback兜底方法实现"}},[a._v("#")]),a._v(" 加入fallback兜底方法实现")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('@Component\npublic class PaymentFallbackService implements PaymentService\n{\n    @Override\n    public CommonResult<Payment> paymentSQL(Long id)\n    {\n        return new CommonResult<>(44444,"服务降级返回,---PaymentFallbackService",new Payment(id,"errorSerial"));\n    }\n}\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br")])]),e("h4",{attrs:{id:"测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[a._v("#")]),a._v(" 测试")]),a._v(" "),e("p",[a._v("请求接口："),e("code",[a._v("http://localhost:84/consumer/paymentSQL/1")])]),a._v(" "),e("p",[a._v("测试84调用9003，此时故意关闭9003微服务提供者，看84消费侧自动降级")]),a._v(" "),e("p",[a._v("我们发现过了一段时间后，会触发服务降级，返回失败的方法")]),a._v(" "),e("h2",{attrs:{id:"熔断框架对比"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#熔断框架对比"}},[a._v("#")]),a._v(" 熔断框架对比")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416215711875.png",alt:"image-20200416215711875"}})]),a._v(" "),e("h2",{attrs:{id:"sentinel规则持久化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sentinel规则持久化"}},[a._v("#")]),a._v(" Sentinel规则持久化")]),a._v(" "),e("h3",{attrs:{id:"是什么-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#是什么-2"}},[a._v("#")]),a._v(" 是什么")]),a._v(" "),e("p",[a._v("一旦我们重启应用，sentinel规则将会消失，生产环境需要将规则进行持久化")]),a._v(" "),e("h3",{attrs:{id:"怎么玩"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#怎么玩"}},[a._v("#")]),a._v(" 怎么玩")]),a._v(" "),e("p",[a._v("将限流配置规则持久化进Nacos保存，只要刷新8401某个rest地址，sentinel控制台的流控规则就能看到，只要Nacos里面的配置不删除，针对8401上的流控规则持续有效")]),a._v(" "),e("h3",{attrs:{id:"解决方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解决方法"}},[a._v("#")]),a._v(" 解决方法")]),a._v(" "),e("p",[a._v("使用nacos持久化保存")]),a._v(" "),e("h4",{attrs:{id:"引入依赖-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#引入依赖-3"}},[a._v("#")]),a._v(" 引入依赖")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("\x3c!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到--\x3e\n<dependency>\n    <groupId>com.alibaba.csp</groupId>\n    <artifactId>sentinel-datasource-nacos</artifactId>\n</dependency>\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br")])]),e("h4",{attrs:{id:"修改yml-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改yml-3"}},[a._v("#")]),a._v(" 修改yml")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("server:\n  port: 8401\n\nspring:\n  application:\n    name: cloudalibaba-sentinel-service\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848 #Nacos服务注册中心地址\n    sentinel:\n      transport:\n        dashboard: localhost:8080 #配置Sentinel dashboard地址\n        port: 8719\n      datasource:\n        ds1:\n          nacos:\n            server-addr: localhost:8848\n            dataId: cloudalibaba-sentinel-service\n            groupId: DEFAULT_GROUP\n            data-type: json\n            rule-type: flow\n\nmanagement:\n  endpoints:\n    web:\n      exposure:\n        include: '*'\n\nfeign:\n  sentinel:\n    enabled: true # 激活Sentinel对Feign的支持\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br"),e("span",{staticClass:"line-number"},[a._v("14")]),e("br"),e("span",{staticClass:"line-number"},[a._v("15")]),e("br"),e("span",{staticClass:"line-number"},[a._v("16")]),e("br"),e("span",{staticClass:"line-number"},[a._v("17")]),e("br"),e("span",{staticClass:"line-number"},[a._v("18")]),e("br"),e("span",{staticClass:"line-number"},[a._v("19")]),e("br"),e("span",{staticClass:"line-number"},[a._v("20")]),e("br"),e("span",{staticClass:"line-number"},[a._v("21")]),e("br"),e("span",{staticClass:"line-number"},[a._v("22")]),e("br"),e("span",{staticClass:"line-number"},[a._v("23")]),e("br"),e("span",{staticClass:"line-number"},[a._v("24")]),e("br"),e("span",{staticClass:"line-number"},[a._v("25")]),e("br"),e("span",{staticClass:"line-number"},[a._v("26")]),e("br"),e("span",{staticClass:"line-number"},[a._v("27")]),e("br"),e("span",{staticClass:"line-number"},[a._v("28")]),e("br"),e("span",{staticClass:"line-number"},[a._v("29")]),e("br"),e("span",{staticClass:"line-number"},[a._v("30")]),e("br"),e("span",{staticClass:"line-number"},[a._v("31")]),e("br"),e("span",{staticClass:"line-number"},[a._v("32")]),e("br")])]),e("h4",{attrs:{id:"添加nacos配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#添加nacos配置"}},[a._v("#")]),a._v(" 添加nacos配置")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416222218661.png",alt:"image-20200416222218661"}})]),a._v(" "),e("p",[a._v("内容解析")]),a._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20200416222317824.png",alt:"image-20200416222317824"}})]),a._v(" "),e("ul",[e("li",[a._v("resource：资源名称")]),a._v(" "),e("li",[a._v("limitApp：来源应用")]),a._v(" "),e("li",[a._v("grade：阈值类型，0表示线程数，1表示QPS")]),a._v(" "),e("li",[a._v("count：单机阈值")]),a._v(" "),e("li",[a._v("strategy：流控模式，0表示直接，1表示关联，2表示链路")]),a._v(" "),e("li",[a._v("controlBehavior：流控效果，0表示快速失败，1表示Warm，2表示排队等待")]),a._v(" "),e("li",[a._v("clusterMode：是否集群")])]),a._v(" "),e("p",[a._v("这样启动的时候，调用一下接口，我们的限流规则就会重新出现~")])])}),[],!1,null,null,null);s.default=t.exports}}]);