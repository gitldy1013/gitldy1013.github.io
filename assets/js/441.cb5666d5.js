(window.webpackJsonp=window.webpackJsonp||[]).push([[441],{1137:function(e,s,a){"use strict";a.r(s);var t=a(5),r=Object(t.a)({},(function(){var e=this,s=e.$createElement,a=e._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"docker-私有仓库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-私有仓库"}},[e._v("#")]),e._v(" Docker 私有仓库")]),e._v(" "),a("p",[e._v("有时候使用 Docker Hub 这样的公共仓库可能不方便，用户可以创建一个本地仓库供私人使用。")]),e._v(" "),a("p",[e._v("本节介绍如何使用本地仓库。")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://docs.docker.com/registry/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("docker-registry")]),a("OutboundLink")],1),e._v(" 是官方提供的工具，可以用于构建私有的镜像仓库。本文内容基于 "),a("a",{attrs:{href:"https://github.com/docker/distribution",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("docker-registry")]),a("OutboundLink")],1),e._v(" v2.x 版本。")]),e._v(" "),a("h2",{attrs:{id:"安装运行-docker-registry"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装运行-docker-registry"}},[e._v("#")]),e._v(" 安装运行 docker-registry")]),e._v(" "),a("h3",{attrs:{id:"容器运行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#容器运行"}},[e._v("#")]),e._v(" 容器运行")]),e._v(" "),a("p",[e._v("你可以通过获取官方 "),a("code",[e._v("registry")]),e._v(" 镜像来运行。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    $ docker run -d -p 5000:5000 --restart=always --name registry registry\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("这将使用官方的 "),a("code",[e._v("registry")]),e._v(" 镜像来启动私有仓库。默认情况下，仓库会被创建在容器的 "),a("code",[e._v("/var/lib/registry")]),e._v(" 目录下。你可以通过 "),a("code",[e._v("-v")]),e._v(" 参数来将镜像文件存放在本地的指定路径。例如下面的例子将上传的镜像放到本地的 "),a("code",[e._v("/opt/data/registry")]),e._v(" 目录。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    $ docker run -d \\\n        -p 5000:5000 \\\n        -v /opt/data/registry:/var/lib/registry \\\n        registry\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("h2",{attrs:{id:"在私有仓库上传、搜索、下载镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在私有仓库上传、搜索、下载镜像"}},[e._v("#")]),e._v(" 在私有仓库上传、搜索、下载镜像")]),e._v(" "),a("p",[e._v("创建好私有仓库之后，就可以使用 "),a("code",[e._v("docker tag")]),e._v(" 来标记一个镜像，然后推送它到仓库。例如私有仓库地址为 "),a("code",[e._v("127.0.0.1:5000")]),e._v("。")]),e._v(" "),a("p",[e._v("先在本机查看已有的镜像。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    $ docker image ls\n    REPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n    ubuntu                            latest              ba5877dc9bec        6 weeks ago         192.7 MB\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("p",[e._v("使用 "),a("code",[e._v("docker tag")]),e._v(" 将 "),a("code",[e._v("ubuntu:latest")]),e._v(" 这个镜像标记为 "),a("code",[e._v("127.0.0.1:5000/ubuntu:latest")]),e._v("。")]),e._v(" "),a("p",[e._v("格式为 "),a("code",[e._v("docker tag IMAGE[:TAG] [REGISTRY_HOST[:REGISTRY_PORT]/]REPOSITORY[:TAG]")]),e._v("。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    $ docker tag ubuntu:latest 127.0.0.1:5000/ubuntu:latest\n    $ docker image ls\n    REPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n    ubuntu                            latest              ba5877dc9bec        6 weeks ago         192.7 MB\n    127.0.0.1:5000/ubuntu:latest      latest              ba5877dc9bec        6 weeks ago         192.7 MB\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("p",[e._v("使用 "),a("code",[e._v("docker push")]),e._v(" 上传标记的镜像。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    $ docker push 127.0.0.1:5000/ubuntu:latest\n    The push refers to repository [127.0.0.1:5000/ubuntu]\n    373a30c24545: Pushed\n    a9148f5200b0: Pushed\n    cdd3de0940ab: Pushed\n    fc56279bbb33: Pushed\n    b38367233d37: Pushed\n    2aebd096e0e2: Pushed\n    latest: digest: sha256:fe4277621f10b5026266932ddf760f5a756d2facd505a94d2da12f4f52f71f5a size: 1568\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br")])]),a("p",[e._v("用 "),a("code",[e._v("curl")]),e._v(" 查看仓库中的镜像。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('    $ curl 127.0.0.1:5000/v2/_catalog\n    {"repositories":["ubuntu"]}\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("这里可以看到 "),a("code",[e._v('{"repositories":["ubuntu"]}')]),e._v("，表明镜像已经被成功上传了。")]),e._v(" "),a("p",[e._v("先删除已有镜像，再尝试从私有仓库中下载这个镜像。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    $ docker image rm 127.0.0.1:5000/ubuntu:latest\n    \n    $ docker pull 127.0.0.1:5000/ubuntu:latest\n    Pulling repository 127.0.0.1:5000/ubuntu:latest\n    ba5877dc9bec: Download complete\n    511136ea3c5a: Download complete\n    9bad880da3d2: Download complete\n    25f11f5fb0cb: Download complete\n    ebc34468f71d: Download complete\n    2318d26665ef: Download complete\n    \n    $ docker image ls\n    REPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n    127.0.0.1:5000/ubuntu:latest       latest              ba5877dc9bec        6 weeks ago         192.7 MB\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br")])]),a("h2",{attrs:{id:"注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[e._v("#")]),e._v(" 注意事项")]),e._v(" "),a("p",[e._v("如果你不想使用 "),a("code",[e._v("127.0.0.1:5000")]),e._v(" 作为仓库地址，比如想让本网段的其他主机也能把镜像推送到私有仓库。你就得把例如 "),a("code",[e._v("192.168.199.100:5000")]),e._v(" 这样的内网地址作为私有仓库地址，这时你会发现无法成功推送镜像。")]),e._v(" "),a("p",[e._v("这是因为 Docker 默认不允许非 "),a("code",[e._v("HTTPS")]),e._v(" 方式推送镜像。我们可以通过 Docker 的配置选项来取消这个限制，或者查看下一节配置能够通过 "),a("code",[e._v("HTTPS")]),e._v(" 访问的私有仓库。")]),e._v(" "),a("h3",{attrs:{id:"ubuntu-14-04-debian-7-wheezy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ubuntu-14-04-debian-7-wheezy"}},[e._v("#")]),e._v(" Ubuntu 14.04, Debian 7 Wheezy")]),e._v(" "),a("p",[e._v("对于使用 "),a("code",[e._v("upstart")]),e._v(" 的系统而言，编辑 "),a("code",[e._v("/etc/default/docker")]),e._v(" 文件，在其中的 "),a("code",[e._v("DOCKER_OPTS")]),e._v(" 中增加如下内容：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('    DOCKER_OPTS="--registry-mirror=https://registry.docker-cn.com --insecure-registries=192.168.199.100:5000"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("重新启动服务。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    $ sudo service docker restart\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h3",{attrs:{id:"ubuntu-16-04-debian-8-centos-7"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ubuntu-16-04-debian-8-centos-7"}},[e._v("#")]),e._v(" Ubuntu 16.04+, Debian 8+, centos 7")]),e._v(" "),a("p",[e._v("对于使用 "),a("code",[e._v("systemd")]),e._v(" 的系统，请在 "),a("code",[e._v("/etc/docker/daemon.json")]),e._v(" 中写入如下内容（如果文件不存在请新建该文件）")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('    {\n      "registry-mirrors": [\n        "https://registry.docker-cn.com"\n      ],\n      "insecure-registries": [\n        "192.168.199.100:5000"\n      ]\n    }\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br")])]),a("blockquote",[a("p",[e._v("注意：该文件必须符合 "),a("code",[e._v("json")]),e._v(" 规范，否则 Docker 将不能启动。")])]),e._v(" "),a("h2",{attrs:{id:"其他"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他"}},[e._v("#")]),e._v(" 其他")]),e._v(" "),a("p",[e._v("对于 Docker for Windows 、 Docker for Mac 在设置中编辑 "),a("code",[e._v("daemon.json")]),e._v(" 增加和上边一样的字符串即可。")])])}),[],!1,null,null,null);s.default=r.exports}}]);