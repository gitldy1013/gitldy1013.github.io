(window.webpackJsonp=window.webpackJsonp||[]).push([[113],{809:function(e,o,n){"use strict";n.r(o);var t=n(5),i=Object(t.a)({},(function(){var e=this,o=e.$createElement,n=e._self._c||o;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h2",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[e._v("#")]),e._v(" 前言")]),e._v(" "),n("p",[e._v("今天在蘑菇博客进行登录的时候，发现一个BUG，就是在用户登录后，有登录信息，但是刷新页面后，就没有头像了，F12打开调试页面，查看token也没有了")]),e._v(" "),n("p",[e._v("开始感觉非常的怪异，以为是chrome的原因，因为token是存储在cookie中的，而且也设置了有效期为7天，不可能退出浏览器就删除了，但是在我点开一个页面的时候")]),e._v(" "),n("p",[e._v("发现cookie有出现了，而且用户也正常登录，后面经过排查发现，是因为cookie二级域名和顶级域名不共享的原因而引起的")]),e._v(" "),n("h2",{attrs:{id:"原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[e._v("#")]),e._v(" 原理")]),e._v(" "),n("p",[e._v("首先Js在设置cookie的时候，默认会存放在当前的域名下，因为我登录后，会返回www.moguit.cn的页面，同时附带token信息，那么我们的token也就值保存在了 www.moguit.cn页面，而我们通过浏览器输入www.moguit.cn其实访问的是moguit.cn的顶级域名")]),e._v(" "),n("p",[e._v("那么就会造成：二级子域名下的cookie和顶级域名不共享的。同理 a.example.com下设置cookie， 在b.example.com下也是无法正常使用的")]),e._v(" "),n("p",[e._v("要避免这样的原因，我们就需要设置cookie的domain")]),e._v(" "),n("p",[e._v("下面是关于cookie的一些配置")]),e._v(" "),n("ul",[n("li",[e._v("name    Cookie的名称，Cookie一旦创建，名称便不可更改")]),e._v(" "),n("li",[e._v("value    Cookie的值，如果值为Unicode字符，需要为字符编码。如果为二进制数据，则需要使用BASE64编码")]),e._v(" "),n("li",[e._v("maxAge    Cookie失效的时间，单位秒。如果为整数，则该Cookie在maxAge秒后失效。如果为负数，该Cookie为临时Cookie，关闭浏览器即失效，浏览器也不会以任何形式保存该Cookie。如果为0，表示删除该Cookie。默认为-1。")]),e._v(" "),n("li",[e._v("secure    该Cookie是否仅被使用安全协议传输。安全协议。安全协议有HTTPS，SSL等，在网络上传输数据之前先将数据加密。默认为false。")]),e._v(" "),n("li",[e._v("path    Cookie的使用路径。如果设置为“/sessionWeb/”，则只有contextPath为“/sessionWeb”的程序可以访问该Cookie。如果设置为“/”，则本域名下contextPath都可以访问该Cookie。注意最后一个字符必须为“/”。")]),e._v(" "),n("li",[e._v("domain    可以访问该Cookie的域名。如果设置为“.google.com”，则所有以“google.com”结尾的域名都可以访问该Cookie。注意第一个字符必须为“.”。")]),e._v(" "),n("li",[e._v("comment    该Cookie的用处说明，浏览器显示Cookie信息的时候显示该说明。")]),e._v(" "),n("li",[e._v("version    Cookie使用的版本号。0表示遵循Netscape的Cookie规范，1表示遵循W3C的RFC 2109规范")])]),e._v(" "),n("p",[e._v("我们通过domain的属性可能看到，当我们设置 .google.com的时候，那么以google.com结尾的域名都能够访问该cookie")]),e._v(" "),n("p",[e._v("那么如果我们想要让cookie进行共享的话，就必须以 .moguit.cn进行共享")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[e._v("host = location.host;\ndomainParts = host.split('.');\ndomainParts.shift();\ndomain = '.'+domainParts.join('.');\n")])])]),n("p",[e._v("我们通过这段代码，就能够截取到蘑菇博客的顶级域名了，同时我们需要加上 .")]),e._v(" "),n("p",[n("img",{attrs:{src:"http://image.moguit.cn/f004ce6dc7b24445805f193f09a02fa4",alt:""}})]),e._v(" "),n("p",[e._v("完整的CookieUtil代码为：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[e._v('/**\n * CookieUtil常用的一些工具类\n */\n\nexport function setCookie(name, value, days) {\n  // var exp = new Date();\n  // exp.setTime(exp.getTime() + days * 24 * 60 * 60 * 1000);\n  // document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString();\n\n  var domain, domainParts, date, expires, host;\n\n  if (days)\n  {\n    date = new Date();\n    date.setTime(date.getTime()+(days*24*60*60*1000));\n    expires = "; expires="+date.toGMTString();\n  }\n  else\n  {\n    expires = "";\n  }\n\n  host = location.host;\n  if (host.split(\'.\').length === 1)\n  {\n    // no "." in a domain - it\'s localhost or something similar\n    document.cookie = name+"="+value+expires+"; path=/";\n  }\n  else\n  {\n    // Remember the cookie on all subdomains.\n    //\n    // Start with trying to set cookie to the top domain.\n    // (example: if user is on foo.com, try to set\n    //  cookie to domain ".com")\n    //\n    // If the cookie will not be set, it means ".com"\n    // is a top level domain and we need to\n    // set the cookie to ".foo.com"\n    domainParts = host.split(\'.\');\n    domainParts.shift();\n    domain = \'.\'+domainParts.join(\'.\');\n\n    document.cookie = name+"="+value+expires+"; path=/; domain="+domain;\n\n    // check if cookie was successfuly set to the given domain\n    // (otherwise it was a Top-Level Domain)\n    if (getCookie(name) == null || getCookie(name) != value)\n    {\n      // append "." to current domain\n      domain = \'.\'+host;\n      document.cookie = name+"="+value+expires+"; path=/; domain="+domain;\n    }\n  }\n}\n\nexport function getCookie(name) {\n  var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)")\n  if (arr = document.cookie.match(reg))\n    return unescape(arr[2])\n  else\n    return null\n}\n\nexport function delCookie(name) {\n  var exp = new Date();\n  exp.setTime(exp.getTime() - 1);\n  var cval = getCookie(name);\n  if (cval != null)\n    document.cookie = name + "=" + cval + ";expires=" + exp.toGMTString();\n}\n')])])])])}),[],!1,null,null,null);o.default=i.exports}}]);