(window.webpackJsonp=window.webpackJsonp||[]).push([[1022],{1718:function(n,s,a){"use strict";a.r(s);var e=a(5),r=Object(e.a)({},(function(){var n=this,s=n.$createElement,a=n._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h1",{attrs:{id:"基于-jdbc-存储令牌"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基于-jdbc-存储令牌"}},[n._v("#")]),n._v(" 基于 JDBC 存储令牌")]),n._v(" "),a("h2",{attrs:{id:"概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[n._v("#")]),n._v(" 概述")]),n._v(" "),a("p",[n._v("本章节 "),a("strong",[n._v("基于 JDBC 存储令牌")]),n._v(' 的模式用于演示最基本的操作，帮助大家快速理解 oAuth2 认证服务器中 "认证"、"授权"、"访问令牌” 的基本概念')]),n._v(" "),a("p",[a("strong",[n._v("操作流程")])]),n._v(" "),a("p",[a("img",{attrs:{src:"/img/201904030001.png",alt:""}})]),n._v(" "),a("ul",[a("li",[n._v("初始化 oAuth2 相关表")]),n._v(" "),a("li",[n._v("在数据库中配置客户端")]),n._v(" "),a("li",[n._v("配置认证服务器\n"),a("ul",[a("li",[n._v("配置数据源："),a("code",[n._v("DataSource")])]),n._v(" "),a("li",[n._v("配置令牌存储方式："),a("code",[n._v("TokenStore")]),n._v(" -> "),a("code",[n._v("JdbcTokenStore")])]),n._v(" "),a("li",[n._v("配置客户端读取方式："),a("code",[n._v("ClientDetailsService")]),n._v(" -> "),a("code",[n._v("JdbcClientDetailsService")])]),n._v(" "),a("li",[n._v("配置服务端点信息："),a("code",[n._v("AuthorizationServerEndpointsConfigurer")]),n._v(" "),a("ul",[a("li",[a("code",[n._v("tokenStore")]),n._v("：设置令牌存储方式")])])]),n._v(" "),a("li",[n._v("配置客户端信息："),a("code",[n._v("ClientDetailsServiceConfigurer")]),n._v(" "),a("ul",[a("li",[a("code",[n._v("withClientDetails")]),n._v("：设置客户端配置读取方式")])])])])]),n._v(" "),a("li",[n._v("配置 Web 安全\n"),a("ul",[a("li",[n._v("配置密码加密方式："),a("code",[n._v("BCryptPasswordEncoder")])]),n._v(" "),a("li",[n._v("配置认证信息："),a("code",[n._v("AuthenticationManagerBuilder")])])])]),n._v(" "),a("li",[n._v("通过 GET 请求访问认证服务器获取授权码\n"),a("ul",[a("li",[n._v("端点："),a("code",[n._v("/oauth/authorize")])])])]),n._v(" "),a("li",[n._v("通过 POST 请求利用授权码访问认证服务器获取令牌\n"),a("ul",[a("li",[n._v("端点："),a("code",[n._v("/oauth/token")])])])])]),n._v(" "),a("p",[a("strong",[n._v("附：默认的端点 URL")])]),n._v(" "),a("ul",[a("li",[a("code",[n._v("/oauth/authorize")]),n._v("：授权端点")]),n._v(" "),a("li",[a("code",[n._v("/oauth/token")]),n._v("：令牌端点")]),n._v(" "),a("li",[a("code",[n._v("/oauth/confirm_access")]),n._v("：用户确认授权提交端点")]),n._v(" "),a("li",[a("code",[n._v("/oauth/error")]),n._v("：授权服务错误信息端点")]),n._v(" "),a("li",[a("code",[n._v("/oauth/check_token")]),n._v("：用于资源服务访问的令牌解析端点")]),n._v(" "),a("li",[a("code",[n._v("/oauth/token_key")]),n._v("：提供公有密匙的端点，如果你使用 JWT 令牌的话")])]),n._v(" "),a("h2",{attrs:{id:"初始化-oauth2-相关表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初始化-oauth2-相关表"}},[n._v("#")]),n._v(" 初始化 oAuth2 相关表")]),n._v(" "),a("p",[n._v("使用官方提供的建表脚本初始化 oAuth2 相关表，地址如下：")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/test/resources/schema.sql\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("p",[n._v("由于我们使用的是 MySQL 数据库，默认建表语句中主键为 "),a("code",[n._v("VARCHAR(256)")]),n._v("，这超过了最大的主键长度，请手动修改为 "),a("code",[n._v("128")]),n._v("，并用 "),a("code",[n._v("BLOB")]),n._v(" 替换语句中的 "),a("code",[n._v("LONGVARBINARY")]),n._v(" 类型，修改后的建表脚本如下：")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    CREATE TABLE `clientdetails` (\n      `appId` varchar(128) NOT NULL,\n      `resourceIds` varchar(256) DEFAULT NULL,\n      `appSecret` varchar(256) DEFAULT NULL,\n      `scope` varchar(256) DEFAULT NULL,\n      `grantTypes` varchar(256) DEFAULT NULL,\n      `redirectUrl` varchar(256) DEFAULT NULL,\n      `authorities` varchar(256) DEFAULT NULL,\n      `access_token_validity` int(11) DEFAULT NULL,\n      `refresh_token_validity` int(11) DEFAULT NULL,\n      `additionalInformation` varchar(4096) DEFAULT NULL,\n      `autoApproveScopes` varchar(256) DEFAULT NULL,\n      PRIMARY KEY (`appId`)\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n    \n    CREATE TABLE `oauth_access_token` (\n      `token_id` varchar(256) DEFAULT NULL,\n      `token` blob,\n      `authentication_id` varchar(128) NOT NULL,\n      `user_name` varchar(256) DEFAULT NULL,\n      `client_id` varchar(256) DEFAULT NULL,\n      `authentication` blob,\n      `refresh_token` varchar(256) DEFAULT NULL,\n      PRIMARY KEY (`authentication_id`)\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n    \n    CREATE TABLE `oauth_approvals` (\n      `userId` varchar(256) DEFAULT NULL,\n      `clientId` varchar(256) DEFAULT NULL,\n      `scope` varchar(256) DEFAULT NULL,\n      `status` varchar(10) DEFAULT NULL,\n      `expiresAt` timestamp NULL DEFAULT NULL,\n      `lastModifiedAt` timestamp NULL DEFAULT NULL\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n    \n    CREATE TABLE `oauth_client_details` (\n      `client_id` varchar(128) NOT NULL,\n      `resource_ids` varchar(256) DEFAULT NULL,\n      `client_secret` varchar(256) DEFAULT NULL,\n      `scope` varchar(256) DEFAULT NULL,\n      `authorized_grant_types` varchar(256) DEFAULT NULL,\n      `web_server_redirect_uri` varchar(256) DEFAULT NULL,\n      `authorities` varchar(256) DEFAULT NULL,\n      `access_token_validity` int(11) DEFAULT NULL,\n      `refresh_token_validity` int(11) DEFAULT NULL,\n      `additional_information` varchar(4096) DEFAULT NULL,\n      `autoapprove` varchar(256) DEFAULT NULL,\n      PRIMARY KEY (`client_id`)\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n    \n    CREATE TABLE `oauth_client_token` (\n      `token_id` varchar(256) DEFAULT NULL,\n      `token` blob,\n      `authentication_id` varchar(128) NOT NULL,\n      `user_name` varchar(256) DEFAULT NULL,\n      `client_id` varchar(256) DEFAULT NULL,\n      PRIMARY KEY (`authentication_id`)\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n    \n    CREATE TABLE `oauth_code` (\n      `code` varchar(256) DEFAULT NULL,\n      `authentication` blob\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n    \n    CREATE TABLE `oauth_refresh_token` (\n      `token_id` varchar(256) DEFAULT NULL,\n      `token` blob,\n      `authentication` blob\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br")])]),a("h2",{attrs:{id:"在数据库中配置客户端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在数据库中配置客户端"}},[n._v("#")]),n._v(" 在数据库中配置客户端")]),n._v(" "),a("p",[n._v("在表 "),a("code",[n._v("oauth_client_details")]),n._v(" 中增加一条客户端配置记录，需要设置的字段如下：")]),n._v(" "),a("ul",[a("li",[a("code",[n._v("client_id")]),n._v("：客户端标识")]),n._v(" "),a("li",[a("code",[n._v("client_secret")]),n._v("：客户端安全码，"),a("strong",[n._v("此处不能是明文，需要加密")])]),n._v(" "),a("li",[a("code",[n._v("scope")]),n._v("：客户端授权范围")]),n._v(" "),a("li",[a("code",[n._v("authorized_grant_types")]),n._v("：客户端授权类型")]),n._v(" "),a("li",[a("code",[n._v("web_server_redirect_uri")]),n._v("：服务器回调地址")])]),n._v(" "),a("p",[n._v("使用 "),a("code",[n._v("BCryptPasswordEncoder")]),n._v(" 为客户端安全码加密，代码如下：")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('    System.out.println(new BCryptPasswordEncoder().encode("secret"));\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("p",[n._v("数据库配置客户端效果图如下：")]),n._v(" "),a("p",[a("img",{attrs:{src:"/img/20190403150110.png",alt:""}})]),n._v(" "),a("h2",{attrs:{id:"pom"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pom"}},[n._v("#")]),n._v(" POM")]),n._v(" "),a("p",[n._v("由于使用了 JDBC 存储，我们需要增加相关依赖，数据库连接池部分弃用 "),a("code",[n._v("Druid")]),n._v(" 改为 "),a("code",[n._v("HikariCP")]),n._v(" （"),a("strong",[n._v("号称全球最快连接池")]),n._v("）")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    <dependency>\n        <groupId>com.zaxxer</groupId>\n        <artifactId>HikariCP</artifactId>\n        <version>${hikaricp.version}</version>\n    </dependency>\n    <dependency>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-jdbc</artifactId>\n        <exclusions>\n            \x3c!-- 排除 tomcat-jdbc 以使用 HikariCP --\x3e\n            <exclusion>\n                <groupId>org.apache.tomcat</groupId>\n                <artifactId>tomcat-jdbc</artifactId>\n            </exclusion>\n        </exclusions>\n    </dependency>\n    <dependency>\n        <groupId>mysql</groupId>\n        <artifactId>mysql-connector-java</artifactId>\n        <version>${mysql.version}</version>\n    </dependency>\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br")])]),a("h2",{attrs:{id:"配置认证服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置认证服务器"}},[n._v("#")]),n._v(" 配置认证服务器")]),n._v(" "),a("p",[n._v("创建一个类继承 "),a("code",[n._v("AuthorizationServerConfigurerAdapter")]),n._v(" 并添加相关注解：")]),n._v(" "),a("ul",[a("li",[a("code",[n._v("@Configuration")])]),n._v(" "),a("li",[a("code",[n._v("@EnableAuthorizationServer")])])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('    package com.cmcc.oauth2.server.config;\n    \n    import org.springframework.boot.context.properties.ConfigurationProperties;\n    import org.springframework.boot.jdbc.DataSourceBuilder;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.context.annotation.Configuration;\n    import org.springframework.context.annotation.Primary;\n    import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;\n    import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;\n    import org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;\n    import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;\n    import org.springframework.security.oauth2.provider.ClientDetailsService;\n    import org.springframework.security.oauth2.provider.client.JdbcClientDetailsService;\n    import org.springframework.security.oauth2.provider.token.TokenStore;\n    import org.springframework.security.oauth2.provider.token.store.JdbcTokenStore;\n    \n    import javax.sql.DataSource;\n    \n    @Configuration\n    @EnableAuthorizationServer\n    public class AuthorizationServerConfiguration extends AuthorizationServerConfigurerAdapter {\n    \n        @Bean\n        @Primary\n        @ConfigurationProperties(prefix = "spring.datasource")\n        public DataSource dataSource() {\n            // 配置数据源（注意，我使用的是 HikariCP 连接池），以上注解是指定数据源，否则会有冲突\n            return DataSourceBuilder.create().build();\n        }\n    \n        @Bean\n        public TokenStore tokenStore() {\n            // 基于 JDBC 实现，令牌保存到数据\n            return new JdbcTokenStore(dataSource());\n        }\n    \n        @Bean\n        public ClientDetailsService jdbcClientDetails() {\n            // 基于 JDBC 实现，需要事先在数据库配置客户端信息\n            return new JdbcClientDetailsService(dataSource());\n        }\n    \n        @Override\n        public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {\n            // 设置令牌\n            endpoints.tokenStore(tokenStore());\n        }\n    \n        @Override\n        public void configure(ClientDetailsServiceConfigurer clients) throws Exception {\n            // 读取客户端配置\n            clients.withClientDetails(jdbcClientDetails());\n        }\n    }\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br")])]),a("h2",{attrs:{id:"服务器安全配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务器安全配置"}},[n._v("#")]),n._v(" 服务器安全配置")]),n._v(" "),a("p",[n._v("创建一个类继承 "),a("code",[n._v("WebSecurityConfigurerAdapter")]),n._v(" 并添加相关注解：")]),n._v(" "),a("ul",[a("li",[a("code",[n._v("@Configuration")])]),n._v(" "),a("li",[a("code",[n._v("@EnableWebSecurity")])]),n._v(" "),a("li",[a("code",[n._v("@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true, jsr250Enabled = true)")]),n._v("：全局方法拦截")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('    package com.cmcc.oauth2.server.config;\n    \n    import org.springframework.context.annotation.Bean;\n    import org.springframework.context.annotation.Configuration;\n    import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\n    import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n    import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\n    import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n    import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\n    \n    @Configuration\n    @EnableWebSecurity\n    @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true, jsr250Enabled = true)\n    public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {\n    \n        @Bean\n        public BCryptPasswordEncoder passwordEncoder() {\n            // 设置默认的加密方式\n            return new BCryptPasswordEncoder();\n        }\n    \n        @Override\n        protected void configure(AuthenticationManagerBuilder auth) throws Exception {\n    \n            auth.inMemoryAuthentication()\n                    // 在内存中创建用户并为密码加密\n                    .withUser("user").password(passwordEncoder().encode("123456")).roles("USER")\n                    .and()\n                    .withUser("admin").password(passwordEncoder().encode("123456")).roles("ADMIN");\n    \n        }\n    }\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br")])]),a("h2",{attrs:{id:"application-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#application-yml"}},[n._v("#")]),n._v(" application.yml")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    spring:\n      application:\n        name: oauth2-server\n      datasource:\n        type: com.zaxxer.hikari.HikariDataSource\n        driver-class-name: com.mysql.cj.jdbc.Driver\n        jdbc-url: jdbc:mysql://192.168.141.128:3307/oauth2?useUnicode=true&characterEncoding=utf-8&useSSL=false\n        username: root\n        password: 123456\n        hikari:\n          minimum-idle: 5\n          idle-timeout: 600000\n          maximum-pool-size: 10\n          auto-commit: true\n          pool-name: MyHikariCP\n          max-lifetime: 1800000\n          connection-timeout: 30000\n          connection-test-query: SELECT 1\n    \n    server:\n      port: 8080\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br")])]),a("h2",{attrs:{id:"访问获取授权码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#访问获取授权码"}},[n._v("#")]),n._v(" 访问获取授权码")]),n._v(" "),a("p",[n._v("打开浏览器，输入地址：")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    http://localhost:8080/oauth/authorize?client_id=client&response_type=code\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("p",[n._v("第一次访问会跳转到登录页面")]),n._v(" "),a("p",[a("img",{attrs:{src:"/img/20190401195014.png",alt:""}})]),n._v(" "),a("p",[n._v("验证成功后会询问用户是否授权客户端")]),n._v(" "),a("p",[a("img",{attrs:{src:"/img/20190401195129.png",alt:""}})]),n._v(" "),a("p",[n._v("选择授权后会跳转到我的博客，浏览器地址上还会包含一个授权码（"),a("code",[n._v("code=1JuO6V")]),n._v("），浏览器地址栏会显示如下地址：")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("    http://www.cmcc.com/?code=1JuO6V\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("p",[n._v("有了这个授权码就可以获取访问令牌了")]),n._v(" "),a("h2",{attrs:{id:"通过授权码向服务器申请令牌"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通过授权码向服务器申请令牌"}},[n._v("#")]),n._v(" 通过授权码向服务器申请令牌")]),n._v(" "),a("p",[n._v("通过 CURL 或是 Postman 请求")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('    curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d \'grant_type=authorization_code&code=1JuO6V\' "http://client:secret@localhost:8080/oauth/token"\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/img/20190402232952.png",alt:""}})]),n._v(" "),a("p",[n._v("得到响应结果如下：")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('    {\n        "access_token": "016d8d4a-dd6e-4493-b590-5f072923c413",\n        "token_type": "bearer",\n        "expires_in": 43199,\n        "scope": "app"\n    }\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br")])]),a("p",[n._v("操作成功后数据库 "),a("code",[n._v("oauth_access_token")]),n._v(" 表中会增加一笔记录，效果图如下：")]),n._v(" "),a("p",[a("img",{attrs:{src:"/img/20190403150529.png",alt:""}})])])}),[],!1,null,null,null);s.default=r.exports}}]);