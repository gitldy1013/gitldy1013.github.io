(window.webpackJsonp=window.webpackJsonp||[]).push([[568],{1265:function(n,t,s){"use strict";s.r(t);var a=s(5),e=Object(a.a)({},(function(){var n=this,t=n.$createElement,s=n._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[s("h1",{attrs:{id:"在-go-http包的server中-每一个请求在都有一个对应的-goroutine-去处理。请求处理函数通常会启动额外的-goroutine-用来访问后端服务-比如数据库和rpc服务。用来处理一个请求的-goroutine-通常需要访问一些与请求特定的数据-比如终端用户的身份认证信息、验证相关的token、请求的截止时间。-当一个请求被取消或超时时-所有用来处理该请求的-goroutine-都应该迅速退出-然后系统才能释放这些-goroutine-占用的资源。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在-go-http包的server中-每一个请求在都有一个对应的-goroutine-去处理。请求处理函数通常会启动额外的-goroutine-用来访问后端服务-比如数据库和rpc服务。用来处理一个请求的-goroutine-通常需要访问一些与请求特定的数据-比如终端用户的身份认证信息、验证相关的token、请求的截止时间。-当一个请求被取消或超时时-所有用来处理该请求的-goroutine-都应该迅速退出-然后系统才能释放这些-goroutine-占用的资源。"}},[n._v("#")]),n._v(" 在 Go http包的Server中，每一个请求在都有一个对应的 goroutine 去处理。请求处理函数通常会启动额外的 goroutine 用来访问后端服务，比如数据库和RPC服务。用来处理一个请求的 goroutine 通常需要访问一些与请求特定的数据，比如终端用户的身份认证信息、验证相关的token、请求的截止时间。 当一个请求被取消或超时时，所有用来处理该请求的 goroutine 都应该迅速退出，然后系统才能释放这些 goroutine 占用的资源。")]),n._v(" "),s("h2",{attrs:{id:"为什么需要context"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#为什么需要context"}},[n._v("#")]),n._v(" 为什么需要Context")]),n._v(" "),s("h3",{attrs:{id:"基本示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本示例"}},[n._v("#")]),n._v(" 基本示例")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('    package main\n    \n    import (\n    \t"fmt"\n    \t"sync"\n    \n    \t"time"\n    )\n    \n    var wg sync.WaitGroup\n    \n    // 初始的例子\n    \n    func worker() {\n    \tfor {\n    \t\tfmt.Println("worker")\n    \t\ttime.Sleep(time.Second)\n    \t}\n    \t// 如何接收外部命令实现退出\n    \twg.Done()\n    }\n    \n    func main() {\n    \twg.Add(1)\n    \tgo worker()\n    \t// 如何优雅的实现结束子goroutine\n    \twg.Wait()\n    \tfmt.Println("over")\n    }\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br")])]),s("h3",{attrs:{id:"全局变量方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全局变量方式"}},[n._v("#")]),n._v(" 全局变量方式")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('    package main\n    \n    import (\n    \t"fmt"\n    \t"sync"\n    \n    \t"time"\n    )\n    \n    var wg sync.WaitGroup\n    var exit bool\n    \n    // 全局变量方式存在的问题：\n    // 1. 使用全局变量在跨包调用时不容易统一\n    // 2. 如果worker中再启动goroutine，就不太好控制了。\n    \n    func worker() {\n    \tfor {\n    \t\tfmt.Println("worker")\n    \t\ttime.Sleep(time.Second)\n    \t\tif exit {\n    \t\t\tbreak\n    \t\t}\n    \t}\n    \twg.Done()\n    }\n    \n    func main() {\n    \twg.Add(1)\n    \tgo worker()\n    \ttime.Sleep(time.Second * 3) // sleep3秒以免程序过快退出\n    \texit = true                 // 修改全局变量实现子goroutine的退出\n    \twg.Wait()\n    \tfmt.Println("over")\n    }\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br")])]),s("h3",{attrs:{id:"通道方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#通道方式"}},[n._v("#")]),n._v(" 通道方式")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('    package main\n    \n    import (\n    \t"fmt"\n    \t"sync"\n    \n    \t"time"\n    )\n    \n    var wg sync.WaitGroup\n    \n    // 管道方式存在的问题：\n    // 1. 使用全局变量在跨包调用时不容易实现规范和统一，需要维护一个共用的channel\n    \n    func worker(exitChan chan struct{}) {\n    LOOP:\n    \tfor {\n    \t\tfmt.Println("worker")\n    \t\ttime.Sleep(time.Second)\n    \t\tselect {\n    \t\tcase <-exitChan: // 等待接收上级通知\n    \t\t\tbreak LOOP\n    \t\tdefault:\n    \t\t}\n    \t}\n    \twg.Done()\n    }\n    \n    func main() {\n    \tvar exitChan = make(chan struct{})\n    \twg.Add(1)\n    \tgo worker(exitChan)\n    \ttime.Sleep(time.Second * 3) // sleep3秒以免程序过快退出\n    \texitChan <- struct{}{}      // 给子goroutine发送退出信号\n    \tclose(exitChan)\n    \twg.Wait()\n    \tfmt.Println("over")\n    }\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br")])]),s("h3",{attrs:{id:"官方版的方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#官方版的方案"}},[n._v("#")]),n._v(" 官方版的方案")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('    package main\n    \n    import (\n    \t"context"\n    \t"fmt"\n    \t"sync"\n    \n    \t"time"\n    )\n    \n    var wg sync.WaitGroup\n    \n    func worker(ctx context.Context) {\n    LOOP:\n    \tfor {\n    \t\tfmt.Println("worker")\n    \t\ttime.Sleep(time.Second)\n    \t\tselect {\n    \t\tcase <-ctx.Done(): // 等待上级通知\n    \t\t\tbreak LOOP\n    \t\tdefault:\n    \t\t}\n    \t}\n    \twg.Done()\n    }\n    \n    func main() {\n    \tctx, cancel := context.WithCancel(context.Background())\n    \twg.Add(1)\n    \tgo worker(ctx)\n    \ttime.Sleep(time.Second * 3)\n    \tcancel() // 通知子goroutine结束\n    \twg.Wait()\n    \tfmt.Println("over")\n    }\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br")])]),s("p",[n._v("当子goroutine又开启另外一个goroutine时，只需要将ctx传入即可：")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('    package main\n    \n    import (\n    \t"context"\n    \t"fmt"\n    \t"sync"\n    \n    \t"time"\n    )\n    \n    var wg sync.WaitGroup\n    \n    func worker(ctx context.Context) {\n    \tgo worker2(ctx)\n    LOOP:\n    \tfor {\n    \t\tfmt.Println("worker")\n    \t\ttime.Sleep(time.Second)\n    \t\tselect {\n    \t\tcase <-ctx.Done(): // 等待上级通知\n    \t\t\tbreak LOOP\n    \t\tdefault:\n    \t\t}\n    \t}\n    \twg.Done()\n    }\n    \n    func worker2(ctx context.Context) {\n    LOOP:\n    \tfor {\n    \t\tfmt.Println("worker2")\n    \t\ttime.Sleep(time.Second)\n    \t\tselect {\n    \t\tcase <-ctx.Done(): // 等待上级通知\n    \t\t\tbreak LOOP\n    \t\tdefault:\n    \t\t}\n    \t}\n    }\n    func main() {\n    \tctx, cancel := context.WithCancel(context.Background())\n    \twg.Add(1)\n    \tgo worker(ctx)\n    \ttime.Sleep(time.Second * 3)\n    \tcancel() // 通知子goroutine结束\n    \twg.Wait()\n    \tfmt.Println("over")\n    }\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br")])]),s("h2",{attrs:{id:"context初识"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#context初识"}},[n._v("#")]),n._v(" Context初识")]),n._v(" "),s("p",[n._v("Go1.7加入了一个新的标准库"),s("code",[n._v("context")]),n._v("，它定义了"),s("code",[n._v("Context")]),n._v("类型，专门用来简化 对于处理单个请求的多个 goroutine 之间与请求域的数据、取消信号、截止时间等相关操作，这些操作可能涉及多个 API 调用。")]),n._v(" "),s("p",[n._v("对服务器传入的请求应该创建上下文，而对服务器的传出调用应该接受上下文。它们之间的函数调用链必须传递上下文，或者可以使用"),s("code",[n._v("WithCancel")]),n._v("、"),s("code",[n._v("WithDeadline")]),n._v("、"),s("code",[n._v("WithTimeout")]),n._v("或"),s("code",[n._v("WithValue")]),n._v("创建的派生上下文。当一个上下文被取消时，它派生的所有上下文也被取消。")]),n._v(" "),s("h2",{attrs:{id:"context接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#context接口"}},[n._v("#")]),n._v(" Context接口")]),n._v(" "),s("p",[s("code",[n._v("context.Context")]),n._v("是一个接口，该接口定义了四个需要实现的方法。具体签名如下：")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("    type Context interface {\n        Deadline() (deadline time.Time, ok bool)\n        Done() <-chan struct{}\n        Err() error\n        Value(key interface{}) interface{}\n    }\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br")])]),s("p",[n._v("其中：")]),n._v(" "),s("ul",[s("li",[s("code",[n._v("Deadline")]),n._v("方法需要返回当前"),s("code",[n._v("Context")]),n._v("被取消的时间，也就是完成工作的截止时间（deadline）；")]),n._v(" "),s("li",[s("code",[n._v("Done")]),n._v("方法需要返回一个"),s("code",[n._v("Channel")]),n._v("，这个Channel会在当前工作完成或者上下文被取消之后关闭，多次调用"),s("code",[n._v("Done")]),n._v("方法会返回同一个Channel；")]),n._v(" "),s("li",[s("code",[n._v("Err")]),n._v("方法会返回当前"),s("code",[n._v("Context")]),n._v("结束的原因，它只会在"),s("code",[n._v("Done")]),n._v("返回的Channel被关闭时才会返回非空的值；\n"),s("ul",[s("li",[n._v("如果当前"),s("code",[n._v("Context")]),n._v("被取消就会返回"),s("code",[n._v("Canceled")]),n._v("错误；")]),n._v(" "),s("li",[n._v("如果当前"),s("code",[n._v("Context")]),n._v("超时就会返回"),s("code",[n._v("DeadlineExceeded")]),n._v("错误；")])])]),n._v(" "),s("li",[s("code",[n._v("Value")]),n._v("方法会从"),s("code",[n._v("Context")]),n._v("中返回键对应的值，对于同一个上下文来说，多次调用"),s("code",[n._v("Value")]),n._v(" 并传入相同的"),s("code",[n._v("Key")]),n._v("会返回相同的结果，该方法仅用于传递跨API和进程间跟请求域的数据；")])]),n._v(" "),s("h3",{attrs:{id:"background-和todo"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#background-和todo"}},[n._v("#")]),n._v(" Background()和TODO()")]),n._v(" "),s("p",[n._v("Go内置两个函数："),s("code",[n._v("Background()")]),n._v("和"),s("code",[n._v("TODO()")]),n._v("，这两个函数分别返回一个实现了"),s("code",[n._v("Context")]),n._v("接口的"),s("code",[n._v("background")]),n._v("和"),s("code",[n._v("todo")]),n._v("。我们代码中最开始都是以这两个内置的上下文对象作为最顶层的"),s("code",[n._v("partent context")]),n._v("，衍生出更多的子上下文对象。")]),n._v(" "),s("p",[s("code",[n._v("Background()")]),n._v("主要用于main函数、初始化以及测试代码中，作为Context这个树结构的最顶层的Context，也就是根Context。")]),n._v(" "),s("p",[s("code",[n._v("TODO()")]),n._v("，它目前还不知道具体的使用场景，如果我们不知道该使用什么Context的时候，可以使用这个。")]),n._v(" "),s("p",[s("code",[n._v("background")]),n._v("和"),s("code",[n._v("todo")]),n._v("本质上都是"),s("code",[n._v("emptyCtx")]),n._v("结构体类型，是一个不可取消，没有设置截止时间，没有携带任何值的Context。")]),n._v(" "),s("h2",{attrs:{id:"with系列函数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#with系列函数"}},[n._v("#")]),n._v(" With系列函数")]),n._v(" "),s("p",[n._v("此外，"),s("code",[n._v("context")]),n._v("包中还定义了四个With系列函数。")]),n._v(" "),s("h3",{attrs:{id:"withcancel"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#withcancel"}},[n._v("#")]),n._v(" WithCancel")]),n._v(" "),s("p",[s("code",[n._v("WithCancel")]),n._v("的函数签名如下：")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("    func WithCancel(parent Context) (ctx Context, cancel CancelFunc)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[s("code",[n._v("WithCancel")]),n._v("返回带有新Done通道的父节点的副本。当调用返回的cancel函数或当关闭父上下文的Done通道时，将关闭返回上下文的Done通道，无论先发生什么情况。")]),n._v(" "),s("p",[n._v("取消此上下文将释放与其关联的资源，因此代码应该在此上下文中运行的操作完成后立即调用cancel。")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("    func gen(ctx context.Context) <-chan int {\n    \t\tdst := make(chan int)\n    \t\tn := 1\n    \t\tgo func() {\n    \t\t\tfor {\n    \t\t\t\tselect {\n    \t\t\t\tcase <-ctx.Done():\n    \t\t\t\t\treturn // return结束该goroutine，防止泄露\n    \t\t\t\tcase dst <- n:\n    \t\t\t\t\tn++\n    \t\t\t\t}\n    \t\t\t}\n    \t\t}()\n    \t\treturn dst\n    \t}\n    func main() {\n    \tctx, cancel := context.WithCancel(context.Background())\n    \tdefer cancel() // 当我们取完需要的整数后调用cancel\n    \n    \tfor n := range gen(ctx) {\n    \t\tfmt.Println(n)\n    \t\tif n == 5 {\n    \t\t\tbreak\n    \t\t}\n    \t}\n    }\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br")])]),s("p",[n._v("上面的示例代码中，"),s("code",[n._v("gen")]),n._v("函数在单独的goroutine中生成整数并将它们发送到返回的通道。 gen的调用者在使用生成的整数之后需要取消上下文，以免"),s("code",[n._v("gen")]),n._v("启动的内部goroutine发生泄漏。")]),n._v(" "),s("h3",{attrs:{id:"withdeadline"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#withdeadline"}},[n._v("#")]),n._v(" WithDeadline")]),n._v(" "),s("p",[s("code",[n._v("WithDeadline")]),n._v("的函数签名如下：")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("    func WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("返回父上下文的副本，并将deadline调整为不迟于d。如果父上下文的deadline已经早于d，则WithDeadline(parent, d)在语义上等同于父上下文。当截止日过期时，当调用返回的cancel函数时，或者当父上下文的Done通道关闭时，返回上下文的Done通道将被关闭，以最先发生的情况为准。")]),n._v(" "),s("p",[n._v("取消此上下文将释放与其关联的资源，因此代码应该在此上下文中运行的操作完成后立即调用cancel。")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('    func main() {\n    \td := time.Now().Add(50 * time.Millisecond)\n    \tctx, cancel := context.WithDeadline(context.Background(), d)\n    \n    \t// 尽管ctx会过期，但在任何情况下调用它的cancel函数都是很好的实践。\n    \t// 如果不这样做，可能会使上下文及其父类存活的时间超过必要的时间。\n    \tdefer cancel()\n    \n    \tselect {\n    \tcase <-time.After(1 * time.Second):\n    \t\tfmt.Println("overslept")\n    \tcase <-ctx.Done():\n    \t\tfmt.Println(ctx.Err())\n    \t}\n    }\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br")])]),s("p",[n._v("上面的代码中，定义了一个50毫秒之后过期的deadline，然后我们调用"),s("code",[n._v("context.WithDeadline(context.Background(), d)")]),n._v("得到一个上下文（ctx）和一个取消函数（cancel），然后使用一个select让主程序陷入等待：等待1秒后打印"),s("code",[n._v("overslept")]),n._v("退出或者等待ctx过期后退出。 因为ctx50秒后就过期，所以"),s("code",[n._v("ctx.Done()")]),n._v("会先接收到值，上面的代码会打印ctx.Err()取消原因。")]),n._v(" "),s("h3",{attrs:{id:"withtimeout"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#withtimeout"}},[n._v("#")]),n._v(" WithTimeout")]),n._v(" "),s("p",[s("code",[n._v("WithTimeout")]),n._v("的函数签名如下：")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("    func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[s("code",[n._v("WithTimeout")]),n._v("返回"),s("code",[n._v("WithDeadline(parent, time.Now().Add(timeout))")]),n._v("。")]),n._v(" "),s("p",[n._v("取消此上下文将释放与其相关的资源，因此代码应该在此上下文中运行的操作完成后立即调用cancel，通常用于数据库或者网络连接的超时控制。具体示例如下：")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('    package main\n    \n    import (\n    \t"context"\n    \t"fmt"\n    \t"sync"\n    \n    \t"time"\n    )\n    \n    // context.WithTimeout\n    \n    var wg sync.WaitGroup\n    \n    func worker(ctx context.Context) {\n    LOOP:\n    \tfor {\n    \t\tfmt.Println("db connecting ...")\n    \t\ttime.Sleep(time.Millisecond * 10) // 假设正常连接数据库耗时10毫秒\n    \t\tselect {\n    \t\tcase <-ctx.Done(): // 50毫秒后自动调用\n    \t\t\tbreak LOOP\n    \t\tdefault:\n    \t\t}\n    \t}\n    \tfmt.Println("worker done!")\n    \twg.Done()\n    }\n    \n    func main() {\n    \t// 设置一个50毫秒的超时\n    \tctx, cancel := context.WithTimeout(context.Background(), time.Millisecond*50)\n    \twg.Add(1)\n    \tgo worker(ctx)\n    \ttime.Sleep(time.Second * 5)\n    \tcancel() // 通知子goroutine结束\n    \twg.Wait()\n    \tfmt.Println("over")\n    }\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br")])]),s("h3",{attrs:{id:"withvalue"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#withvalue"}},[n._v("#")]),n._v(" WithValue")]),n._v(" "),s("p",[s("code",[n._v("WithValue")]),n._v("函数能够将请求作用域的数据与 Context 对象建立关系。声明如下：")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("    func WithValue(parent Context, key, val interface{}) Context\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[s("code",[n._v("WithValue")]),n._v("返回父节点的副本，其中与key关联的值为val。")]),n._v(" "),s("p",[n._v("仅对API和进程间传递请求域的数据使用上下文值，而不是使用它来传递可选参数给函数。")]),n._v(" "),s("p",[n._v("所提供的键必须是可比较的，并且不应该是"),s("code",[n._v("string")]),n._v("类型或任何其他内置类型，以避免使用上下文在包之间发生冲突。"),s("code",[n._v("WithValue")]),n._v("的用户应该为键定义自己的类型。为了避免在分配给interface{}时进行分配，上下文键通常具有具体类型"),s("code",[n._v("struct{}")]),n._v("。或者，导出的上下文关键变量的静态类型应该是指针或接口。")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('    package main\n    \n    import (\n    \t"context"\n    \t"fmt"\n    \t"sync"\n    \n    \t"time"\n    )\n    \n    // context.WithValue\n    \n    type TraceCode string\n    \n    var wg sync.WaitGroup\n    \n    func worker(ctx context.Context) {\n    \tkey := TraceCode("TRACE_CODE")\n    \ttraceCode, ok := ctx.Value(key).(string) // 在子goroutine中获取trace code\n    \tif !ok {\n    \t\tfmt.Println("invalid trace code")\n    \t}\n    LOOP:\n    \tfor {\n    \t\tfmt.Printf("worker, trace code:%s\\n", traceCode)\n    \t\ttime.Sleep(time.Millisecond * 10) // 假设正常连接数据库耗时10毫秒\n    \t\tselect {\n    \t\tcase <-ctx.Done(): // 50毫秒后自动调用\n    \t\t\tbreak LOOP\n    \t\tdefault:\n    \t\t}\n    \t}\n    \tfmt.Println("worker done!")\n    \twg.Done()\n    }\n    \n    func main() {\n    \t// 设置一个50毫秒的超时\n    \tctx, cancel := context.WithTimeout(context.Background(), time.Millisecond*50)\n    \t// 在系统的入口中设置trace code传递给后续启动的goroutine实现日志数据聚合\n    \tctx = context.WithValue(ctx, TraceCode("TRACE_CODE"), "12512312234")\n    \twg.Add(1)\n    \tgo worker(ctx)\n    \ttime.Sleep(time.Second * 5)\n    \tcancel() // 通知子goroutine结束\n    \twg.Wait()\n    \tfmt.Println("over")\n    }\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br")])]),s("h2",{attrs:{id:"使用context的注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用context的注意事项"}},[n._v("#")]),n._v(" 使用Context的注意事项")]),n._v(" "),s("ul",[s("li",[n._v("推荐以参数的方式显示传递Context")]),n._v(" "),s("li",[n._v("以Context作为参数的函数方法，应该把Context作为第一个参数。")]),n._v(" "),s("li",[n._v("给一个函数方法传递Context的时候，不要传递nil，如果不知道传递什么，就使用context.TODO()")]),n._v(" "),s("li",[n._v("Context的Value相关方法应该传递请求域的必要数据，不应该用于传递可选参数")]),n._v(" "),s("li",[n._v("Context是线程安全的，可以放心的在多个goroutine中传递")])]),n._v(" "),s("h2",{attrs:{id:"客户端超时取消示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#客户端超时取消示例"}},[n._v("#")]),n._v(" 客户端超时取消示例")]),n._v(" "),s("p",[n._v("调用服务端API时如何在客户端实现超时控制？")]),n._v(" "),s("h3",{attrs:{id:"server端"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#server端"}},[n._v("#")]),n._v(" server端")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('    // context_timeout/server/main.go\n    package main\n    \n    import (\n    \t"fmt"\n    \t"math/rand"\n    \t"net/http"\n    \n    \t"time"\n    )\n    \n    // server端，随机出现慢响应\n    \n    func indexHandler(w http.ResponseWriter, r *http.Request) {\n    \tnumber := rand.Intn(2)\n    \tif number == 0 {\n    \t\ttime.Sleep(time.Second * 10) // 耗时10秒的慢响应\n    \t\tfmt.Fprintf(w, "slow response")\n    \t\treturn\n    \t}\n    \tfmt.Fprint(w, "quick response")\n    }\n    \n    func main() {\n    \thttp.HandleFunc("/", indexHandler)\n    \terr := http.ListenAndServe(":8000", nil)\n    \tif err != nil {\n    \t\tpanic(err)\n    \t}\n    }\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br")])]),s("h3",{attrs:{id:"client端"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#client端"}},[n._v("#")]),n._v(" client端")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('    // context_timeout/client/main.go\n    package main\n    \n    import (\n    \t"context"\n    \t"fmt"\n    \t"io/ioutil"\n    \t"net/http"\n    \t"sync"\n    \t"time"\n    )\n    \n    // 客户端\n    \n    type respData struct {\n    \tresp *http.Response\n    \terr  error\n    }\n    \n    func doCall(ctx context.Context) {\n    \ttransport := http.Transport{\n    \t   // 请求频繁可定义全局的client对象并启用长链接\n    \t   // 请求不频繁使用短链接\n    \t   DisableKeepAlives: true, \t}\n    \tclient := http.Client{\n    \t\tTransport: &transport,\n    \t}\n    \n    \trespChan := make(chan *respData, 1)\n    \treq, err := http.NewRequest("GET", "http://127.0.0.1:8000/", nil)\n    \tif err != nil {\n    \t\tfmt.Printf("new requestg failed, err:%v\\n", err)\n    \t\treturn\n    \t}\n    \treq = req.WithContext(ctx) // 使用带超时的ctx创建一个新的client request\n    \tvar wg sync.WaitGroup\n    \twg.Add(1)\n    \tdefer wg.Wait()\n    \tgo func() {\n    \t\tresp, err := client.Do(req)\n    \t\tfmt.Printf("client.do resp:%v, err:%v\\n", resp, err)\n    \t\trd := &respData{\n    \t\t\tresp: resp,\n    \t\t\terr:  err,\n    \t\t}\n    \t\trespChan <- rd\n    \t\twg.Done()\n    \t}()\n    \n    \tselect {\n    \tcase <-ctx.Done():\n    \t\t//transport.CancelRequest(req)\n    \t\tfmt.Println("call api timeout")\n    \tcase result := <-respChan:\n    \t\tfmt.Println("call server api success")\n    \t\tif result.err != nil {\n    \t\t\tfmt.Printf("call server api failed, err:%v\\n", result.err)\n    \t\t\treturn\n    \t\t}\n    \t\tdefer result.resp.Body.Close()\n    \t\tdata, _ := ioutil.ReadAll(result.resp.Body)\n    \t\tfmt.Printf("resp:%v\\n", string(data))\n    \t}\n    }\n    \n    func main() {\n    \t// 定义一个100毫秒的超时\n    \tctx, cancel := context.WithTimeout(context.Background(), time.Millisecond*100)\n    \tdefer cancel() // 调用cancel释放子goroutine资源\n    \tdoCall(ctx)\n    }\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br"),s("span",{staticClass:"line-number"},[n._v("51")]),s("br"),s("span",{staticClass:"line-number"},[n._v("52")]),s("br"),s("span",{staticClass:"line-number"},[n._v("53")]),s("br"),s("span",{staticClass:"line-number"},[n._v("54")]),s("br"),s("span",{staticClass:"line-number"},[n._v("55")]),s("br"),s("span",{staticClass:"line-number"},[n._v("56")]),s("br"),s("span",{staticClass:"line-number"},[n._v("57")]),s("br"),s("span",{staticClass:"line-number"},[n._v("58")]),s("br"),s("span",{staticClass:"line-number"},[n._v("59")]),s("br"),s("span",{staticClass:"line-number"},[n._v("60")]),s("br"),s("span",{staticClass:"line-number"},[n._v("61")]),s("br"),s("span",{staticClass:"line-number"},[n._v("62")]),s("br"),s("span",{staticClass:"line-number"},[n._v("63")]),s("br"),s("span",{staticClass:"line-number"},[n._v("64")]),s("br"),s("span",{staticClass:"line-number"},[n._v("65")]),s("br"),s("span",{staticClass:"line-number"},[n._v("66")]),s("br"),s("span",{staticClass:"line-number"},[n._v("67")]),s("br"),s("span",{staticClass:"line-number"},[n._v("68")]),s("br"),s("span",{staticClass:"line-number"},[n._v("69")]),s("br"),s("span",{staticClass:"line-number"},[n._v("70")]),s("br"),s("span",{staticClass:"line-number"},[n._v("71")]),s("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);