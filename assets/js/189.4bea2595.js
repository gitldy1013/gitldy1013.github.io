(window.webpackJsonp=window.webpackJsonp||[]).push([[189],{886:function(s,a,n){"use strict";n.r(a);var t=n(5),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"配置sentinel规则持久化到nacos中"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置sentinel规则持久化到nacos中"}},[s._v("#")]),s._v(" 配置Sentinel规则持久化到Nacos中")]),s._v(" "),n("h2",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),n("p",[s._v("Sentinel如果没有配置持久化的话，默认是将规则存储在内存中的，如果服务重启那么定义的规则也会没有，需要我们再次手动创建规则。这样其实对我们来说是非常麻烦的一件事，因此这里重点说说Sentinel规则持久化到Nacos中，每次启动服务，只需要从Nacos拉取规则，加载到Sentinel中即可")]),s._v(" "),n("h2",{attrs:{id:"安装依赖"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装依赖"}},[s._v("#")]),s._v(" 安装依赖")]),s._v(" "),n("p",[s._v("如果要使用Sentinel持久化到Nacos，首先需要在项目文件中导入pom依赖")]),s._v(" "),n("div",{staticClass:"language-xml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-xml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!--sentinel持久化到nacos--\x3e")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("com.alibaba.csp"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("sentinel-datasource-nacos"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h2",{attrs:{id:"修改yml文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改yml文件"}},[s._v("#")]),s._v(" 修改yml文件")]),s._v(" "),n("p",[s._v("然后我们找到原来配置sentinel的配置文件，添加datasouce相关")]),s._v(" "),n("div",{staticClass:"language-shell script line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("server:\n  port: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8603")]),s._v("\n\nspring:\n  application:\n    name: mogu-web\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n        namespace: dev\n      config:\n        server-addr: localhost:8848\n        file-extension: yaml\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定分组")]),s._v("\n        group: dev\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定命名空间")]),s._v("\n        namespace: dev\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置Sentinel流控")]),s._v("\n    sentinel:\n      transport:\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#配置Sentinel dashboard地址")]),s._v("\n        dashboard: localhost:8070\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#默认8719端口,如果被占用会向上扫描。")]),s._v("\n        port: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8719")]),s._v("\n\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel持久化到nacos")]),s._v("\n      datasource:\n        flow:\n          nacos:\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nacos连接地址")]),s._v("\n            server-addr: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${spring.cloud.nacos.discovery.server-addr}")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nacos中的配置名称")]),s._v("\n            data-id: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${spring.application.name}")]),s._v("-flow-rules\n            group-id: DEFAULT_GROUP\n            data-type: json\n            rule-type: flow\n        degrade:\n          nacos:\n            server-addr: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${spring.cloud.nacos.discovery.server-addr}")]),s._v("\n            data-id: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${spring.application.name}")]),s._v("-degrade-rules\n            group-id: DEFAULT_GROUP\n            data-type: json\n            rule-type: degrade\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br")])]),n("p",[s._v("在上面我们分别配置了sentinel的流控规则和降级规则")]),s._v(" "),n("h2",{attrs:{id:"创建配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建配置文件"}},[s._v("#")]),s._v(" 创建配置文件")]),s._v(" "),n("p",[s._v("然后我们需要到Nacos中创建配置文件")]),s._v(" "),n("ul",[n("li",[s._v("mogu-web-flow-rules：流量规则")]),s._v(" "),n("li",[s._v("mogu-web-degrade-rules：降级规则")])]),s._v(" "),n("p",[s._v("因为我们没有指定对应的namespace，也就是命名空间，所以我们就默认在public下创建，这样在dev 或者 prod下都可以进行使用")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20201002112029866.png",alt:"image-20201002112029866"}})]),s._v(" "),n("h3",{attrs:{id:"mogu-web-flow-rules"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mogu-web-flow-rules"}},[s._v("#")]),s._v(" mogu-web-flow-rules")]),s._v(" "),n("p",[s._v("首先创建流量规则，主要用于接口的流量控制")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20201002111931443.png",alt:"image-20201002111931443"}})]),s._v(" "),n("p",[s._v("规则如下所示：")]),s._v(" "),n("div",{staticClass:"language-shell script line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clusterMode"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" false,\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"controlBehavior"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"count"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grade"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"limitApp"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resource"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/index/getBlogByLevel"')]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"strategy"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("字段含义：【所有属性来⾃源码FlowRule类】")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("resource")]),s._v("：资源名称")]),s._v(" "),n("li",[n("strong",[s._v("limitApp")]),s._v("：来源应⽤")]),s._v(" "),n("li",[n("strong",[s._v("grade")]),s._v("：阈值类型 0 线程数 1 QPS")]),s._v(" "),n("li",[n("strong",[s._v("count")]),s._v("：单机阈值")]),s._v(" "),n("li",[n("strong",[s._v("strategy")]),s._v("：流控模式， 0 直接 1 关联 2 链路")]),s._v(" "),n("li",[n("strong",[s._v("controlBehavior")]),s._v("：流控效果， 0 快速失败 1 Warm Up 2 排队等待")]),s._v(" "),n("li",[n("strong",[s._v("clusterMode")]),s._v("： true/false 是否集群")])]),s._v(" "),n("h3",{attrs:{id:"mogu-web-degrade-rules"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mogu-web-degrade-rules"}},[s._v("#")]),s._v(" mogu-web-degrade-rules")]),s._v(" "),n("p",[s._v("首先创建降级规则，主要用于接口的请求出错时，快速返回")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20201002111905809.png",alt:"image-20201002111905809"}})]),s._v(" "),n("p",[s._v("规则如下所示：")]),s._v(" "),n("div",{staticClass:"language-shell script line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"count"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grade"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resource"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/index/getBlogByLevel"')]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"timeWindow"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("字段含义：【所有属性来⾃源码DegradeRule类】")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("resource")]),s._v("：资源名称")]),s._v(" "),n("li",[n("strong",[s._v("grade")]),s._v("：降级策略 0 RT 1 异常⽐例 2 异常数")]),s._v(" "),n("li",[n("strong",[s._v("count")]),s._v("：阈值")]),s._v(" "),n("li",[n("strong",[s._v("timeWindow")]),s._v("：时间窗")])]),s._v(" "),n("h2",{attrs:{id:"测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),n("p",[s._v("创建完成后，我们启动项目测试，因为我们添加的是mogu-web的流控规则，所以我们只需要访问主页即可")]),s._v(" "),n("div",{staticClass:"language-shell script line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输入首页地址")]),s._v("\nhttp://localhost:9527\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("然后发现成功跳转出500页面，说明我们的流控规则已经生效")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20201002112307192.png",alt:"image-20201002112307192"}})]),s._v(" "),n("p",[s._v("然后到我们的sentinel图形化页面")]),s._v(" "),n("div",{staticClass:"language-shell script line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("http://localhost:8070\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("输入默认账号和密码：sentinel  sentinel")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20201002112409723.png",alt:"image-20201002112409723"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20201002112435951.png",alt:"image-20201002112435951"}})]),s._v(" "),n("p",[s._v("能够发现已经有一条流控规则和降级规则了~，到这里为止已经成功将规则持久化到nacos中了，更多的规则，我们只需要修改对应的配置文件即可")])])}),[],!1,null,null,null);a.default=e.exports}}]);