(window.webpackJsonp=window.webpackJsonp||[]).push([[1023],{1719:function(s,n,a){"use strict";a.r(n);var e=a(5),r=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"基于-rbac-的自定义认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基于-rbac-的自定义认证"}},[s._v("#")]),s._v(" 基于 RBAC 的自定义认证")]),s._v(" "),a("h2",{attrs:{id:"概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),a("p",[s._v("在实际开发中，我们的用户信息都是存在数据库里的，本章节基于 "),a("RouterLink",{attrs:{to:"/zh/spring-security-oauth2/RBAC-基于角色的权限控制.html"}},[s._v("RBAC 模型")]),s._v(" 将用户的认证信息与数据库对接，实现真正的用户认证与授权")],1),s._v(" "),a("p",[a("strong",[s._v("操作流程")])]),s._v(" "),a("p",[s._v("继续 "),a("RouterLink",{attrs:{to:"/zh/spring-security-oauth2/基于-JDBC-存储令牌.html"}},[s._v("基于 JDBC 存储令牌")]),s._v(" 章节的代码开发")],1),s._v(" "),a("ul",[a("li",[s._v("初始化 RBAC 相关表")]),s._v(" "),a("li",[s._v("在数据库中配置“用户”、“角色”、“权限”相关信息")]),s._v(" "),a("li",[s._v("数据库操作使用 "),a("code",[s._v("tk.mybatis")]),s._v(" 框架，故需要增加相关依赖")]),s._v(" "),a("li",[s._v("配置 Web 安全\n"),a("ul",[a("li",[s._v("配置使用自定义认证与授权")])])]),s._v(" "),a("li",[s._v("通过 GET 请求访问认证服务器获取授权码\n"),a("ul",[a("li",[s._v("端点："),a("code",[s._v("/oauth/authorize")])])])]),s._v(" "),a("li",[s._v("通过 POST 请求利用授权码访问认证服务器获取令牌\n"),a("ul",[a("li",[s._v("端点："),a("code",[s._v("/oauth/token")])])])])]),s._v(" "),a("p",[a("strong",[s._v("附：默认的端点 URL")])]),s._v(" "),a("ul",[a("li",[a("code",[s._v("/oauth/authorize")]),s._v("：授权端点")]),s._v(" "),a("li",[a("code",[s._v("/oauth/token")]),s._v("：令牌端点")]),s._v(" "),a("li",[a("code",[s._v("/oauth/confirm_access")]),s._v("：用户确认授权提交端点")]),s._v(" "),a("li",[a("code",[s._v("/oauth/error")]),s._v("：授权服务错误信息端点")]),s._v(" "),a("li",[a("code",[s._v("/oauth/check_token")]),s._v("：用于资源服务访问的令牌解析端点")]),s._v(" "),a("li",[a("code",[s._v("/oauth/token_key")]),s._v("：提供公有密匙的端点，如果你使用 JWT 令牌的话")])]),s._v(" "),a("h2",{attrs:{id:"初始化-rbac-相关表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初始化-rbac-相关表"}},[s._v("#")]),s._v(" 初始化 RBAC 相关表")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    CREATE TABLE `tb_permission` (\n      `id` bigint(20) NOT NULL AUTO_INCREMENT,\n      `parent_id` bigint(20) DEFAULT NULL COMMENT '父权限',\n      `name` varchar(64) NOT NULL COMMENT '权限名称',\n      `enname` varchar(64) NOT NULL COMMENT '权限英文名称',\n      `url` varchar(255) NOT NULL COMMENT '授权路径',\n      `description` varchar(200) DEFAULT NULL COMMENT '备注',\n      `created` datetime NOT NULL,\n      `updated` datetime NOT NULL,\n      PRIMARY KEY (`id`)\n    ) ENGINE=InnoDB AUTO_INCREMENT=44 DEFAULT CHARSET=utf8 COMMENT='权限表';\n    insert  into `tb_permission`(`id`,`parent_id`,`name`,`enname`,`url`,`description`,`created`,`updated`) values \n    (37,0,'系统管理','System','/',NULL,'2019-04-04 23:22:54','2019-04-04 23:22:56'),\n    (38,37,'用户管理','SystemUser','/users/',NULL,'2019-04-04 23:25:31','2019-04-04 23:25:33'),\n    (39,38,'查看用户','SystemUserView','',NULL,'2019-04-04 15:30:30','2019-04-04 15:30:43'),\n    (40,38,'新增用户','SystemUserInsert','',NULL,'2019-04-04 15:30:31','2019-04-04 15:30:44'),\n    (41,38,'编辑用户','SystemUserUpdate','',NULL,'2019-04-04 15:30:32','2019-04-04 15:30:45'),\n    (42,38,'删除用户','SystemUserDelete','',NULL,'2019-04-04 15:30:48','2019-04-04 15:30:45');\n    \n    CREATE TABLE `tb_role` (\n      `id` bigint(20) NOT NULL AUTO_INCREMENT,\n      `parent_id` bigint(20) DEFAULT NULL COMMENT '父角色',\n      `name` varchar(64) NOT NULL COMMENT '角色名称',\n      `enname` varchar(64) NOT NULL COMMENT '角色英文名称',\n      `description` varchar(200) DEFAULT NULL COMMENT '备注',\n      `created` datetime NOT NULL,\n      `updated` datetime NOT NULL,\n      PRIMARY KEY (`id`)\n    ) ENGINE=InnoDB AUTO_INCREMENT=38 DEFAULT CHARSET=utf8 COMMENT='角色表';\n    insert  into `tb_role`(`id`,`parent_id`,`name`,`enname`,`description`,`created`,`updated`) values \n    (37,0,'超级管理员','admin',NULL,'2019-04-04 23:22:03','2019-04-04 23:22:05');\n    \n    CREATE TABLE `tb_role_permission` (\n      `id` bigint(20) NOT NULL AUTO_INCREMENT,\n      `role_id` bigint(20) NOT NULL COMMENT '角色 ID',\n      `permission_id` bigint(20) NOT NULL COMMENT '权限 ID',\n      PRIMARY KEY (`id`)\n    ) ENGINE=InnoDB AUTO_INCREMENT=43 DEFAULT CHARSET=utf8 COMMENT='角色权限表';\n    insert  into `tb_role_permission`(`id`,`role_id`,`permission_id`) values \n    (37,37,37),\n    (38,37,38),\n    (39,37,39),\n    (40,37,40),\n    (41,37,41),\n    (42,37,42);\n    \n    CREATE TABLE `tb_user` (\n      `id` bigint(20) NOT NULL AUTO_INCREMENT,\n      `username` varchar(50) NOT NULL COMMENT '用户名',\n      `password` varchar(64) NOT NULL COMMENT '密码，加密存储',\n      `phone` varchar(20) DEFAULT NULL COMMENT '注册手机号',\n      `email` varchar(50) DEFAULT NULL COMMENT '注册邮箱',\n      `created` datetime NOT NULL,\n      `updated` datetime NOT NULL,\n      PRIMARY KEY (`id`),\n      UNIQUE KEY `username` (`username`) USING BTREE,\n      UNIQUE KEY `phone` (`phone`) USING BTREE,\n      UNIQUE KEY `email` (`email`) USING BTREE\n    ) ENGINE=InnoDB AUTO_INCREMENT=38 DEFAULT CHARSET=utf8 COMMENT='用户表';\n    insert  into `tb_user`(`id`,`username`,`password`,`phone`,`email`,`created`,`updated`) values \n    (37,'admin','$2a$10$9ZhDOBp.sRKat4l14ygu/.LscxrMUcDAfeVOEPiYwbcRkoB09gCmi','15888888888','136913633167@163.com','2019-04-04 23:21:27','2019-04-04 23:21:29');\n    \n    CREATE TABLE `tb_user_role` (\n      `id` bigint(20) NOT NULL AUTO_INCREMENT,\n      `user_id` bigint(20) NOT NULL COMMENT '用户 ID',\n      `role_id` bigint(20) NOT NULL COMMENT '角色 ID',\n      PRIMARY KEY (`id`)\n    ) ENGINE=InnoDB AUTO_INCREMENT=38 DEFAULT CHARSET=utf8 COMMENT='用户角色表';\n    insert  into `tb_user_role`(`id`,`user_id`,`role_id`) values \n    (37,37,37);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br")])]),a("p",[s._v("由于使用了 "),a("code",[s._v("BCryptPasswordEncoder")]),s._v(" 的加密方式，故用户密码需要加密，代码如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    System.out.println(new BCryptPasswordEncoder().encode("123456"));\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"pom"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pom"}},[s._v("#")]),s._v(" POM")]),s._v(" "),a("p",[s._v("数据库操作采用 "),a("code",[s._v("tk.mybatis")]),s._v(" 框架，需增加相关依赖")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    <dependency>\n        <groupId>tk.mybatis</groupId>\n        <artifactId>mapper-spring-boot-starter</artifactId>\n    </dependency>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"关键步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关键步骤"}},[s._v("#")]),s._v(" 关键步骤")]),s._v(" "),a("p",[s._v("由于本次增加了 MyBatis 相关操作，代码增加较多，可以参考我 "),a("a",{attrs:{href:"https://github.com/topsale/spring-boot-samples/tree/master/spring-security-oauth2",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[s._v("GitHub")]),a("OutboundLink")],1),s._v(" 上的源码，下面仅列出关键步骤及代码")]),s._v(" "),a("h3",{attrs:{id:"获取用户信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#获取用户信息"}},[s._v("#")]),s._v(" 获取用户信息")]),s._v(" "),a("p",[s._v("目的是为了实现自定义认证授权时可以通过数据库查询用户信息，Spring Security oAuth2 要求使用 "),a("code",[s._v("username")]),s._v(" 的方式查询，提供相关用户信息后，认证工作由框架自行完成")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    package com.cmcc.oauth2.server.service.impl;\n    \n    import com.cmcc.oauth2.server.domain.TbUser;\n    import com.cmcc.oauth2.server.mapper.TbUserMapper;\n    import com.cmcc.oauth2.server.service.TbUserService;\n    import org.springframework.stereotype.Service;\n    import tk.mybatis.mapper.entity.Example;\n    \n    import javax.annotation.Resource;\n    \n    @Service\n    public class TbUserServiceImpl implements TbUserService {\n    \n        @Resource\n        private TbUserMapper tbUserMapper;\n    \n        @Override\n        public TbUser getByUsername(String username) {\n            Example example = new Example(TbUser.class);\n            example.createCriteria().andEqualTo("username", username);\n            return tbUserMapper.selectOneByExample(example);\n        }\n    }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("h3",{attrs:{id:"获取用户权限信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#获取用户权限信息"}},[s._v("#")]),s._v(" "),a("a",{attrs:{href:"#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E4%BF%A1%E6%81%AF"}},[s._v("#")]),s._v(" 获取用户权限信息")]),s._v(" "),a("p",[s._v("认证成功后需要给用户授权，具体的权限已经存储在数据库里了，SQL 语句如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    SELECT\n      p.*\n    FROM\n      tb_user AS u\n      LEFT JOIN tb_user_role AS ur\n        ON u.id = ur.user_id\n      LEFT JOIN tb_role AS r\n        ON r.id = ur.role_id\n      LEFT JOIN tb_role_permission AS rp\n        ON r.id = rp.role_id\n      LEFT JOIN tb_permission AS p\n        ON p.id = rp.permission_id\n    WHERE u.id = <yourUserId>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h3",{attrs:{id:"自定义认证授权实现类"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自定义认证授权实现类"}},[s._v("#")]),s._v(" 自定义认证授权实现类")]),s._v(" "),a("p",[s._v("创建一个类，实现 "),a("code",[s._v("UserDetailsService")]),s._v(" 接口，代码如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    package com.cmcc.oauth2.server.config.service;\n    \n    import com.cmcc.oauth2.server.domain.TbPermission;\n    import com.cmcc.oauth2.server.domain.TbUser;\n    import com.cmcc.oauth2.server.service.TbPermissionService;\n    import com.cmcc.oauth2.server.service.TbUserService;\n    import org.assertj.core.util.Lists;\n    import org.springframework.beans.factory.annotation.Autowired;\n    import org.springframework.security.core.GrantedAuthority;\n    import org.springframework.security.core.authority.SimpleGrantedAuthority;\n    import org.springframework.security.core.userdetails.User;\n    import org.springframework.security.core.userdetails.UserDetails;\n    import org.springframework.security.core.userdetails.UserDetailsService;\n    import org.springframework.security.core.userdetails.UsernameNotFoundException;\n    import org.springframework.stereotype.Service;\n    \n    import java.util.List;\n    \n    /**\n     * 自定义用户认证与授权\n     * <p>\n     * Description:\n     * </p>\n     *\n     * @author cmcc\n     * @version v1.0.0\n     * @date 2019-04-04 23:57:04\n     * @see com.cmcc.oauth2.server.config\n     */\n    @Service\n    public class UserDetailsServiceImpl implements UserDetailsService {\n    \n        @Autowired\n        private TbUserService tbUserService;\n    \n        @Autowired\n        private TbPermissionService tbPermissionService;\n    \n        @Override\n        public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n            // 查询用户信息\n            TbUser tbUser = tbUserService.getByUsername(username);\n            List<GrantedAuthority> grantedAuthorities = Lists.newArrayList();\n            if (tbUser != null) {\n                // 获取用户授权\n                List<TbPermission> tbPermissions = tbPermissionService.selectByUserId(tbUser.getId());\n    \n                // 声明用户授权\n                tbPermissions.forEach(tbPermission -> {\n                    if (tbPermission != null && tbPermission.getEnname() != null) {\n                        GrantedAuthority grantedAuthority = new SimpleGrantedAuthority(tbPermission.getEnname());\n                        grantedAuthorities.add(grantedAuthority);\n                    }\n                });\n            }\n            \n            // 由框架完成认证工作\n            return new User(tbUser.getUsername(), tbUser.getPassword(), grantedAuthorities);\n        }\n    }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br")])]),a("h3",{attrs:{id:"服务器安全配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务器安全配置"}},[s._v("#")]),s._v(" 服务器安全配置")]),s._v(" "),a("p",[s._v("创建一个类继承 "),a("code",[s._v("WebSecurityConfigurerAdapter")]),s._v(" 并添加相关注解：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("@Configuration")])]),s._v(" "),a("li",[a("code",[s._v("@EnableWebSecurity")])]),s._v(" "),a("li",[a("code",[s._v("@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true, jsr250Enabled = true)")]),s._v("：全局方法拦截")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    package com.cmcc.oauth2.server.config;\n    \n    import com.cmcc.oauth2.server.config.service.UserDetailsServiceImpl;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.context.annotation.Configuration;\n    import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\n    import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n    import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\n    import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n    import org.springframework.security.core.userdetails.UserDetailsService;\n    import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\n    \n    @Configuration\n    @EnableWebSecurity\n    @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true, jsr250Enabled = true)\n    public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {\n    \n        @Bean\n        public BCryptPasswordEncoder passwordEncoder() {\n            // 设置默认的加密方式\n            return new BCryptPasswordEncoder();\n        }\n    \n        @Bean\n        @Override\n        public UserDetailsService userDetailsService() {\n            return new UserDetailsServiceImpl();\n        }\n    \n        @Override\n        protected void configure(AuthenticationManagerBuilder auth) throws Exception {\n            // 使用自定义认证与授权\n            auth.userDetailsService(userDetailsService());\n        }\n    }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br")])]),a("h2",{attrs:{id:"application"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#application"}},[s._v("#")]),s._v(" Application")]),s._v(" "),a("p",[s._v("增加了 Mapper 的包扫描配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    package com.cmcc.oauth2;\n    \n    import org.springframework.boot.SpringApplication;\n    import org.springframework.boot.autoconfigure.SpringBootApplication;\n    import tk.mybatis.spring.annotation.MapperScan;\n    \n    /**\n     * 认证服务器，用于获取 Token\n     * <p>\n     * Description:\n     * </p>\n     *\n     * @author cmcc\n     * @version v1.0.0\n     * @date 2019-04-01 16:06:45\n     * @see com.cmcc.oauth2\n     */\n    @SpringBootApplication\n    @MapperScan(basePackages = "com.cmcc.oauth2.server.mapper")\n    public class OAuth2ServerApplication {\n    \n        public static void main(String[] args) {\n            SpringApplication.run(OAuth2ServerApplication.class, args);\n        }\n    \n    }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("h2",{attrs:{id:"application-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#application-yml"}},[s._v("#")]),s._v(" application.yml")]),s._v(" "),a("p",[s._v("增加了 MyBatis 配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    spring:\n      application:\n        name: oauth2-server\n      datasource:\n        type: com.zaxxer.hikari.HikariDataSource\n        driver-class-name: com.mysql.cj.jdbc.Driver\n        jdbc-url: jdbc:mysql://192.168.141.128:3307/oauth2?useUnicode=true&characterEncoding=utf-8&useSSL=false\n        username: root\n        password: 123456\n        hikari:\n          minimum-idle: 5\n          idle-timeout: 600000\n          maximum-pool-size: 10\n          auto-commit: true\n          pool-name: MyHikariCP\n          max-lifetime: 1800000\n          connection-timeout: 30000\n          connection-test-query: SELECT 1\n    \n    server:\n      port: 8080\n    \n    mybatis:\n      type-aliases-package: com.cmcc.oauth2.server.domain\n      mapper-locations: classpath:mapper/*.xml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("h2",{attrs:{id:"访问获取授权码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#访问获取授权码"}},[s._v("#")]),s._v(" 访问获取授权码")]),s._v(" "),a("p",[s._v("打开浏览器，输入地址：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    http://localhost:8080/oauth/authorize?client_id=client&response_type=code\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("第一次访问会跳转到登录页面")]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/20190401195014.png",alt:""}})]),s._v(" "),a("p",[s._v("验证成功后会询问用户是否授权客户端")]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/20190401195129.png",alt:""}})]),s._v(" "),a("p",[s._v("选择授权后会跳转到我的博客，浏览器地址上还会包含一个授权码（"),a("code",[s._v("code=1JuO6V")]),s._v("），浏览器地址栏会显示如下地址：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    http://www.cmcc.com/?code=1JuO6V\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("有了这个授权码就可以获取访问令牌了")]),s._v(" "),a("h2",{attrs:{id:"通过授权码向服务器申请令牌"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通过授权码向服务器申请令牌"}},[s._v("#")]),s._v(" 通过授权码向服务器申请令牌")]),s._v(" "),a("p",[s._v("通过 CURL 或是 Postman 请求")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d \'grant_type=authorization_code&code=1JuO6V\' "http://client:secret@localhost:8080/oauth/token"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/img/20190402232952.png",alt:""}})]),s._v(" "),a("p",[s._v("得到响应结果如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    {\n        "access_token": "016d8d4a-dd6e-4493-b590-5f072923c413",\n        "token_type": "bearer",\n        "expires_in": 43199,\n        "scope": "app"\n    }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("操作成功后数据库 "),a("code",[s._v("oauth_access_token")]),s._v(" 表中会增加一笔记录，效果图如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/20190403150529.png",alt:""}})])])}),[],!1,null,null,null);n.default=r.exports}}]);