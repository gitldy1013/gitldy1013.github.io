(window.webpackJsonp=window.webpackJsonp||[]).push([[118],{815:function(s,a,e){"use strict";e.r(a);var t=e(5),r=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"kubernetes集群安全机制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes集群安全机制"}},[s._v("#")]),s._v(" Kubernetes集群安全机制")]),s._v(" "),e("h2",{attrs:{id:"概述"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),e("p",[s._v("当我们访问K8S集群时，需要经过三个步骤完成具体操作")]),s._v(" "),e("ul",[e("li",[s._v("认证")]),s._v(" "),e("li",[s._v("鉴权【授权】")]),s._v(" "),e("li",[s._v("准入控制")])]),s._v(" "),e("p",[s._v("进行访问的时候，都需要经过 apiserver， apiserver做统一协调，比如门卫")]),s._v(" "),e("ul",[e("li",[s._v("访问过程中，需要证书、token、或者用户名和密码")]),s._v(" "),e("li",[s._v("如果访问pod需要serviceAccount")])]),s._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20201118092356107.png",alt:"image-20201118092356107"}})]),s._v(" "),e("h3",{attrs:{id:"认证"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#认证"}},[s._v("#")]),s._v(" 认证")]),s._v(" "),e("p",[s._v("对外不暴露8080端口，只能内部访问，对外使用的端口6443")]),s._v(" "),e("p",[s._v("客户端身份认证常用方式")]),s._v(" "),e("ul",[e("li",[s._v("https证书认证，基于ca证书")]),s._v(" "),e("li",[s._v("http token认证，通过token来识别用户")]),s._v(" "),e("li",[s._v("http基本认证，用户名 + 密码认证")])]),s._v(" "),e("h3",{attrs:{id:"鉴权"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#鉴权"}},[s._v("#")]),s._v(" 鉴权")]),s._v(" "),e("p",[s._v("基于RBAC进行鉴权操作")]),s._v(" "),e("p",[s._v("基于角色访问控制")]),s._v(" "),e("h3",{attrs:{id:"准入控制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#准入控制"}},[s._v("#")]),s._v(" 准入控制")]),s._v(" "),e("p",[s._v("就是准入控制器的列表，如果列表有请求内容就通过，没有的话 就拒绝")]),s._v(" "),e("h2",{attrs:{id:"rbac介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#rbac介绍"}},[s._v("#")]),s._v(" RBAC介绍")]),s._v(" "),e("p",[s._v("基于角色的访问控制，为某个角色设置访问内容，然后用户分配该角色后，就拥有该角色的访问权限")]),s._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20201118093949893.png",alt:"image-20201118093949893"}})]),s._v(" "),e("p",[s._v("k8s中有默认的几个角色")]),s._v(" "),e("ul",[e("li",[s._v("role：特定命名空间访问权限")]),s._v(" "),e("li",[s._v("ClusterRole：所有命名空间的访问权限")])]),s._v(" "),e("p",[s._v("角色绑定")]),s._v(" "),e("ul",[e("li",[s._v("roleBinding：角色绑定到主体")]),s._v(" "),e("li",[s._v("ClusterRoleBinding：集群角色绑定到主体")])]),s._v(" "),e("p",[s._v("主体")]),s._v(" "),e("ul",[e("li",[s._v("user：用户")]),s._v(" "),e("li",[s._v("group：用户组")]),s._v(" "),e("li",[s._v("serviceAccount：服务账号")])]),s._v(" "),e("h2",{attrs:{id:"rbac实现鉴权"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#rbac实现鉴权"}},[s._v("#")]),s._v(" RBAC实现鉴权")]),s._v(" "),e("ul",[e("li",[s._v("创建命名空间")])]),s._v(" "),e("h3",{attrs:{id:"创建命名空间"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建命名空间"}},[s._v("#")]),s._v(" 创建命名空间")]),s._v(" "),e("p",[s._v("我们可以首先查看已经存在的命名空间")]),s._v(" "),e("div",{staticClass:"language-shell script line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl get namespace\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"/images/image-20201118094516426.png",alt:"image-20201118094516426"}})]),s._v(" "),e("p",[s._v("然后我们创建一个自己的命名空间  roledemo")]),s._v(" "),e("div",{staticClass:"language-shell script line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl create ns roledemo\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"命名空间创建pod"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#命名空间创建pod"}},[s._v("#")]),s._v(" 命名空间创建Pod")]),s._v(" "),e("p",[s._v("为什么要创建命名空间？因为如果不创建命名空间的话，默认是在default下")]),s._v(" "),e("div",{staticClass:"language-shell script line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl run nginx --image"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx -n roledemo\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"创建角色"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建角色"}},[s._v("#")]),s._v(" 创建角色")]),s._v(" "),e("p",[s._v("我们通过 rbac-role.yaml进行创建")]),s._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20201118094851338.png",alt:"image-20201118094851338"}})]),s._v(" "),e("p",[s._v("tip：这个角色只对pod 有 get、list权限")]),s._v(" "),e("p",[s._v("然后通过 yaml创建我们的role")]),s._v(" "),e("div",{staticClass:"language-shell script line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建")]),s._v("\nkubectl apply -f rbac-role.yaml\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看")]),s._v("\nkubectl get role -n roledemo\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("img",{attrs:{src:"/images/image-20201118095141786.png",alt:"image-20201118095141786"}})]),s._v(" "),e("h3",{attrs:{id:"创建角色绑定"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建角色绑定"}},[s._v("#")]),s._v(" 创建角色绑定")]),s._v(" "),e("p",[s._v("我们还是通过 role-rolebinding.yaml 的方式，来创建我们的角色绑定")]),s._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20201118095248052.png",alt:"image-20201118095248052"}})]),s._v(" "),e("p",[s._v("然后创建我们的角色绑定")]),s._v(" "),e("div",{staticClass:"language-shell script line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建角色绑定")]),s._v("\nkubectl apply -f rbac-rolebinding.yaml\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看角色绑定")]),s._v("\nkubectl get role, rolebinding -n roledemo\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("img",{attrs:{src:"/images/image-20201118095357067.png",alt:"image-20201118095357067"}})]),s._v(" "),e("h3",{attrs:{id:"使用证书识别身份"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用证书识别身份"}},[s._v("#")]),s._v(" 使用证书识别身份")]),s._v(" "),e("p",[s._v("我们首先得有一个 rbac-user.sh 证书脚本")]),s._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20201118095541427.png",alt:"image-20201118095541427"}})]),s._v(" "),e("p",[e("img",{attrs:{src:"/images/image-20201118095627954.png",alt:"image-20201118095627954"}})]),s._v(" "),e("p",[s._v("这里包含了很多证书文件，在TSL目录下，需要复制过来")]),s._v(" "),e("p",[s._v("通过下面命令执行我们的脚本")]),s._v(" "),e("div",{staticClass:"language-shell script line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("./rbac-user.sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("最后我们进行测试")]),s._v(" "),e("div",{staticClass:"language-shell script line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用get命令查看 pod 【有权限】")]),s._v("\nkubectl get pods -n roledemo\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用get命令查看svc 【没权限】")]),s._v("\nkubectl get svc -n roledmeo\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("img",{attrs:{src:"/images/image-20201118100051043.png",alt:"image-20201118100051043"}})])])}),[],!1,null,null,null);a.default=r.exports}}]);