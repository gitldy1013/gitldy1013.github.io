(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{718:function(s,e,a){"use strict";a.r(e);var n=a(5),t=Object(n.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("本文整理在 Ubuntu 16.04.x LTS 操作系统上容器相关部署手册")]),s._v(" "),a("p",[s._v("容器平台")]),s._v(" "),a("ul",[a("li",[s._v("Rancher")]),s._v(" "),a("li",[s._v("Kubernetes")]),s._v(" "),a("li",[s._v("Helm")]),s._v(" "),a("li",[s._v("Docker")])]),s._v(" "),a("p",[s._v("容器服务")]),s._v(" "),a("ul",[a("li",[s._v("prometheus")]),s._v(" "),a("li",[s._v("grafana")]),s._v(" "),a("li",[s._v("postgresql")])]),s._v(" "),a("h1",{attrs:{id:"_1-docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-docker"}},[s._v("#")]),s._v(" 1.Docker")]),s._v(" "),a("h2",{attrs:{id:"_1-1-apt-source"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-apt-source"}},[s._v("#")]),s._v(" 1.1.apt source")]),s._v(" "),a("p",[s._v("更换apt源大多数情况下可以加快软件下载速度。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("cp /etc/apt/sources.list /etc/apt/sources.list.bak\n\n# 阿里源\ntee > /etc/apt/sources.list << EOF\ndeb http://mirrors.aliyun.com/ubuntu/ xenial main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-proposed main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse\n#deb-src http://mirrors.aliyun.com/ubuntu/ xenial main restricted universe multiverse\n#deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted universe multiverse\n#deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted universe multiverse\n#deb-src http://mirrors.aliyun.com/ubuntu/ xenial-proposed main restricted universe multiverse\n#deb-src http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse\nEOF\n\n# 清华源\ntee > /etc/apt/sources.list << EOF\n#deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse\n#deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse\n#deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-security main restricted universe multiverse\n#deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-security main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse\n#deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse\nEOF\n\n# 中科大源\ntee > /etc/apt/sources.list << EOF\ndeb https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse\n#deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse\ndeb https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse\n#deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse\ndeb https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse\n#deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse\ndeb https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse\n#deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse\ndeb https://mirrors.ustc.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse\n#deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse\nEOF\n\n# 网易源\ntee > /etc/apt/sources.list << EOF\ndeb http://mirrors.163.com/ubuntu/ bionic main restricted universe multiverse\ndeb http://mirrors.163.com/ubuntu/ bionic-security main restricted universe multiverse\ndeb http://mirrors.163.com/ubuntu/ bionic-updates main restricted universe multiverse\ndeb http://mirrors.163.com/ubuntu/ bionic-proposed main restricted universe multiverse\ndeb http://mirrors.163.com/ubuntu/ bionic-backports main restricted universe multiverse\n#deb-src http://mirrors.163.com/ubuntu/ bionic main restricted universe multiverse\n#deb-src http://mirrors.163.com/ubuntu/ bionic-security main restricted universe multiverse\n#deb-src http://mirrors.163.com/ubuntu/ bionic-updates main restricted universe multiverse\n#deb-src http://mirrors.163.com/ubuntu/ bionic-proposed main restricted universe multiverse\n#deb-src http://mirrors.163.com/ubuntu/ bionic-backports main restricted universe multiverse\nEOF\n\napt update\n# apt upgrade\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br")])]),a("p",[s._v("备注：")]),s._v(" "),a("p",[s._v("“tee”可以替换成“cat”，有些操作系统可以用“tee”但是没有“cat”。")]),s._v(" "),a("p",[s._v("“>”表示覆写文件，“>>”表示在文件尾部添加。“tee”可以省略“>”来覆写，“cat”不能省略。")]),s._v(" "),a("p",[s._v("“deb”是指deb包目录；“deb-src”是源码目录，一般注释掉。")]),s._v(" "),a("h2",{attrs:{id:"_1-2-install-docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-install-docker"}},[s._v("#")]),s._v(" 1.2.install docker")]),s._v(" "),a("p",[s._v("官网")]),s._v(" "),a("p",[s._v("https://docs.docker.com/engine/install/ubuntu/")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('sudo apt-get install \\\n    apt-transport-https \\\n    ca-certificates \\\n    curl \\\n    gnupg-agent \\\n    software-properties-common\n\n\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\n\n\nsudo add-apt-repository \\\n   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \\\n   $(lsb_release -cs) \\\n   stable"\n\n\nsudo apt-get update\n\nsudo apt-get install docker-ce docker-ce-cli containerd.io\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("指定版本")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("apt-cache madison docker-ce\nsudo apt-get install docker-ce=<VERSION_STRING> docker-ce-cli=<VERSION_STRING> containerd.io\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"_1-3-docker-source"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-docker-source"}},[s._v("#")]),s._v(" 1.3.docker source")]),s._v(" "),a("p",[s._v("配置镜像加速器")]),s._v(" "),a("p",[s._v("https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('sudo mkdir -p /etc/docker\nsudo tee /etc/docker/daemon.json <<-\'EOF\'\n{\n  "registry-mirrors": ["https://aykfevb9.mirror.aliyuncs.com"],\n  "insecure-registries":["https://10.22.224.66"]\n}\nEOF\nsudo systemctl daemon-reload\nsudo systemctl restart docker\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h2",{attrs:{id:"_1-4-postgresql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-postgresql"}},[s._v("#")]),s._v(" 1.4.postgresql")]),s._v(" "),a("p",[s._v("docker hub")]),s._v(" "),a("p",[s._v("https://hub.docker.com/_/postgres")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("docker run -d \\\n  --name postgres \\\n  -p 5432:5432 -it -e POSTGRES_PASSWORD=password \\\n  postgres\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("备注：")]),s._v(" "),a("p",[s._v("“--rm”表示 Automatically remove the container when it exits。表示临时运行容器，和“-d”后台运行“冲突”。-“-rm”等价于当容器在前台运行，退出后执行了 docker rm -v")]),s._v(" "),a("p",[s._v("“-e”表示环境变量")]),s._v(" "),a("p",[s._v("“-i”表示以“交互模式”运行容器，让容器的标准输入保持打开")]),s._v(" "),a("p",[s._v("“-t”表示容器启动后会进入其命令行，让Docker分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("docker exec -it postgres bash\npsql -U postgres\n\npostgres=# create table test (id int primary key not null, value text not null);\nCREATE TABLE\npostgres=# insert into test values (1, 'value1');\nINSERT 0 1\npostgres=# select * from test;\n id | value\n----+--------\n  1 | value1\n(1 row)\n\n\\q\nexit\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h3",{attrs:{id:"_1-4-1-pgagent"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-1-pgagent"}},[s._v("#")]),s._v(" 1.4.1.pgagent")]),s._v(" "),a("p",[s._v("制作镜像")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mkdir /dockerfile\ntee > Dockerfile << EOF\nFROM postgres\nRUN apt-get update\nRUN apt-get install -y pgagent\nEOF\ndocker build -t pg-pgagent .\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("绑定插件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("docker run --name mypgpgagent -e POSTGRES_PASSWORD=123456 -p 5432:5432 -d pg-pgagent\n\ndocker exec -it mypgpgagent /bin/bash\npsql -U postgres\nCREATE EXTENSION pgagent;\n\\q\n/usr/bin/pgagent hostaddr=127.0.0.1 dbname=postgres user=postgres password=123456 -s ./pgagent.log\nexit\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("在pgadmin中选择远程连接要执行定时任务的host, port, dbname, user, password,...")]),s._v(" "),a("p",[s._v("测试时pgagent.log中没有写入")]),s._v(" "),a("h3",{attrs:{id:"_1-4-2-pgadmin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-2-pgadmin"}},[s._v("#")]),s._v(" 1.4.2.pgadmin")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('docker run -p 5050:80 \\\n  -e "PGADMIN_DEFAULT_EMAIL=user@domain.com" \\\n  -e "PGADMIN_DEFAULT_PASSWORD=SuperSecret" \\\n  -d dpage/pgadmin4\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"_1-5-prometheus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-prometheus"}},[s._v("#")]),s._v(" 1.5.prometheus")]),s._v(" "),a("p",[s._v("*可以在rancher中快速配置")]),s._v(" "),a("p",[s._v("“prometheus.yml”中定义了要监控的对象，以“job_name”进行分类。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vim /path/prometheus.yml\n\ndocker run  -d \\\n  --name prometheus \\\n  -p 9090:9090 \\\n  -v /path/prometheus.yml:/etc/prometheus/prometheus.yml  \\\n  prom/prometheus\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("备注：")]),s._v(" "),a("p",[s._v("“-p”表示端口映射，“:”左边的端口理解为目标端口，在这里是主机的端口；右边的端口是容器内 prometheus 程序暴露的端口。一般修改左边的端口，用以暴露服务。")]),s._v(" "),a("p",[s._v("“-v”表示挂载，“:”左边是本机路径；右边是容器内路径。")]),s._v(" "),a("p",[s._v("prometheus.yml 示例")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("scrape_configs:\n  - job_name: prometheus\n    static_configs:\n      - targets: ['10.22.224.71:9090']\n\n  - job_name: postgres_exporter\n    static_configs:\n      - targets: ['10.22.224.71:9187']\n\n  - job_name: node_exporter\n    static_configs:\n      - targets: ['10.22.224.71:9100']\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("kubernetes_sd_config")]),s._v(" "),a("p",[s._v("https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config")]),s._v(" "),a("p",[s._v("使用容器运行 prometheus 不能动态刷新 prometheus.yml")]),s._v(" "),a("p",[s._v("--web.enable-lifecycle")]),s._v(" "),a("p",[s._v("https://prometheus.io/docs/prometheus/latest/management_api/")]),s._v(" "),a("p",[s._v("https://www.cnblogs.com/wurijie/p/11795711.html")]),s._v(" "),a("p",[s._v("kill -HUP pid")]),s._v(" "),a("p",[s._v("curl -X POST http://10.22.224.71:3001/-/reload")]),s._v(" "),a("h3",{attrs:{id:"_1-5-1-postgres-exporter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-1-postgres-exporter"}},[s._v("#")]),s._v(" 1.5.1.postgres_exporter")]),s._v(" "),a("p",[s._v("官网")]),s._v(" "),a("p",[s._v("https://github.com/wrouesnel/postgres_exporter")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('docker run -d \\\n  --name postgres_exporter \\\n  -p 9187:9187 \\\n  -e DATA_SOURCE_NAME="postgresql://postgres:password@192.168.0.100:5432/postgres?sslmode=disable" \\\n  wrouesnel/postgres_exporter\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"_1-5-2-node-exporter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-2-node-exporter"}},[s._v("#")]),s._v(" 1.5.2.node_exporter")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('docker run -d \\\n  --name node_exporter \\\n  --net="host" \\  \n  -p 9100:9100 \\\n  -v "/proc:/host/proc:ro" \\\n  -v "/sys:/host/sys:ro" \\\n  -v "/:/rootfs:ro" \\\n  prom/node-exporter\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h2",{attrs:{id:"_1-6-grafana"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-grafana"}},[s._v("#")]),s._v(" 1.6.grafana")]),s._v(" "),a("p",[s._v("*可以在rancher中快速配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("docker run -d \\\n  --name=grafana \\\n  -p 3000:3000 \\\n  grafana/grafana\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("默认用户名密码 admin/admin")]),s._v(" "),a("h3",{attrs:{id:"_1-6-1-alert-dingding"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-1-alert-dingding"}},[s._v("#")]),s._v(" 1.6.1.alert - dingding")]),s._v(" "),a("p",[s._v("钉钉开发文档")]),s._v(" "),a("p",[s._v("https://ding-doc.dingtalk.com/doc#/serverapi2/qf2nxq")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("仅在pc端dingding客户端上能创建webhook\n在左上角处选择“机器人管理”--\x3e“自定义”，“安全设置”选择“自定义关键词”，即包含该关键词才能发送报警，记住最终生成的webhook\n"),a("img",{attrs:{src:"/images/1587988512682-beed08e0-a1f2-4809-bfab-98b5253610af.png",alt:"image"}}),s._v(" "),a("img",{attrs:{src:"/images/1587988610421-81bd3819-5a3d-4f14-8f80-f1c8e5b90329.png",alt:"image"}}),s._v(" "),a("img",{attrs:{src:"/images/1587988702278-175f3247-b5bd-4a40-834e-bfdfe4fba5d3.png",alt:"image"}}),s._v(" "),a("img",{attrs:{src:"/images/1587988437050-b19bcf36-2577-45eb-96d2-d88fd65507fa.png",alt:"image"}})])]),s._v(" "),a("li",[a("p",[s._v("grafana配置报警")])]),s._v(" "),a("li",[a("ol",[a("li",[s._v("配置全局的dingding报警，输入webhook")]),s._v(" "),a("li",[s._v("在具体的图表中配置报警选择已配置的dingding报警\n"),a("img",{attrs:{src:"/images/1587989954726-3f5b6a7f-15cf-434a-b526-66522eaca98b.png",alt:"image"}}),a("img",{attrs:{src:"/images/1587990143702-1cefd6df-0f83-4e68-846e-cf8e4ebdb123.png",alt:"image"}}),a("img",{attrs:{src:"/images/1587990196040-4e320a97-10e1-4362-8dcf-efbf2ef6c3ff.png",alt:"image"}}),a("img",{attrs:{src:"/images/1587991013837-715ba47b-c043-4236-906b-6d1e406a162f.png",alt:"image"}})])])])]),s._v(" "),a("h3",{attrs:{id:"_1-6-2-dashboard-template"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-2-dashboard-template"}},[s._v("#")]),s._v(" 1.6.2.dashboard template")]),s._v(" "),a("p",[s._v("https://grafana.com/grafana/dashboards?orderBy=name&direction=asc")]),s._v(" "),a("p",[s._v("https://grafana.com/grafana/dashboards/11376")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/1587985751427-8e176c22-6bf1-410e-af31-4d36f2462c44.png",alt:"image"}})]),s._v(" "),a("p",[s._v("基于docker 搭建Prometheus+Grafana")]),s._v(" "),a("p",[s._v("https://www.cnblogs.com/xiao987334176/p/9930517.html")]),s._v(" "),a("p",[s._v("Grafana + Prometheus 监控PostgreSQL")]),s._v(" "),a("p",[s._v("https://www.cnblogs.com/ilifeilong/p/10543876.html")]),s._v(" "),a("h1",{attrs:{id:"_2-rancher"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-rancher"}},[s._v("#")]),s._v(" 2.rancher")]),s._v(" "),a("p",[s._v("官网")]),s._v(" "),a("p",[s._v("https://rancher.com/docs/rancher/v2.x/en/installation/other-installation-methods/single-node-docker/")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("docker run -d --restart=unless-stopped -p 80:80 -p 443:443 rancher/rancher:stable\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("如果下载慢，可以换源")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("docker run -d --restart=unless-stopped -p 80:80 -p 443:443 registry.cn-hangzhou.aliyuncs.com/rancher/rancher:v2.4.2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在rancher中可以快速创建k8s集群，rancher会生成一段命令，把命令复制到目标节点就可以快速创建集群。")]),s._v(" "),a("h1",{attrs:{id:"_3-kubernetes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-kubernetes"}},[s._v("#")]),s._v(" 3.Kubernetes")]),s._v(" "),a("p",[s._v("本地运行 k8s https://github.com/kubernetes/community/blob/master/contributors/devel/running-locally.md")]),s._v(" "),a("h2",{attrs:{id:"_3-1-prepare-env"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-prepare-env"}},[s._v("#")]),s._v(" 3.1.prepare env")]),s._v(" "),a("p",[s._v("port")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vim /etc/ssh/sshd_config\nservice ssh restart\nsudo reboot\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("hostname")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("hostnamectl set-hostname master01\nsudo reboot\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("hosts")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("cat > /etc/hosts << EOF\n10.22.243.114 master01\n10.22.243.124 node01\n10.22.243.125 node02\nEOF\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("scp 分发")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("scp -P 5022 /etc/hosts root@node01:/etc/hosts\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("确认已经关闭 firewall, swap, selinux, iptables")]),s._v(" "),a("h2",{attrs:{id:"_3-2-docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-docker"}},[s._v("#")]),s._v(" 3.2.docker")]),s._v(" "),a("p",[s._v("见1.2")]),s._v(" "),a("h2",{attrs:{id:"_3-3-tools"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-tools"}},[s._v("#")]),s._v(" 3.3.tools")]),s._v(" "),a("p",[s._v("https://v1-16.docs.kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("apt-get update && apt-get install -y apt-transport-https curl\n\nsudo curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -\n\ncat > /etc/apt/sources.list.d/kubernetes.list <<EOF\ndeb https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main\nEOF\n\napt-get update && apt-get install -y kubelet kubeadm kubectl\n\napt-mark hold kubelet kubeadm kubectl\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h2",{attrs:{id:"_3-4-init-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-init-cluster"}},[s._v("#")]),s._v(" 3.4.init cluster")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("kubeadm init --apiserver-advertise-address 10.22.224.113 \\\n  --pod-network-cidr=10.244.0.0/16 \\\n  --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("blockquote",[a("p",[s._v("Your Kubernetes control-plane has initialized successfully!")]),s._v(" "),a("p",[s._v("To start using your cluster, you need to run the following as a regular user:")]),s._v(" "),a("p",[s._v("mkdir -p $HOME/.kube")]),s._v(" "),a("p",[s._v("sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config")]),s._v(" "),a("p",[s._v("sudo chown $(id -u)😒(id -g) $HOME/.kube/config")]),s._v(" "),a("p",[s._v("You should now deploy a pod network to the cluster.")]),s._v(" "),a("p",[s._v('Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:')]),s._v(" "),a("p",[s._v("https://kubernetes.io/docs/concepts/cluster-administration/addons/")]),s._v(" "),a("p",[s._v("Then you can join any number of worker nodes by running the following on each as root:")]),s._v(" "),a("p",[s._v("kubeadm join 10.22.224.113:6443 --token peyc01.8mgmnj6k6zntq84s \\")]),s._v(" "),a("p",[s._v("--discovery-token-ca-cert-hash sha256:ff2b928d246d5fdd8c27c152ab013df5fd665bb13f01184d8fb498f3d50fb554")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"_3-5-flannel"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-flannel"}},[s._v("#")]),s._v(" 3.5.flannel")]),s._v(" "),a("p",[s._v("https://v1-16.docs.kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/")]),s._v(" "),a("p",[s._v("https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("flannel镜像下载慢可以在一个节点下载然后分发，见4.2")]),s._v(" "),a("h2",{attrs:{id:"_3-6-join-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-join-cluster"}},[s._v("#")]),s._v(" 3.6.join cluster")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(" kubeadm join 10.22.224.113:6443 --token peyc01.8mgmnj6k6zntq84s \\\n   --discovery-token-ca-cert-hash sha256:ff2b928d246d5fdd8c27c152ab013df5fd665bb13f01184d8fb498f3d50fb554\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"_3-7-dashboard"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-dashboard"}},[s._v("#")]),s._v(" 3.7.dashboard")]),s._v(" "),a("p",[s._v("无证书dashboard火狐可以访问")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta5/aio/deploy/recommended.yaml\nkubectl patch svc -n kubernetes-dashboard kubernetes-dashboard -p \'{"spec":{"type":"NodePort"}}\'\nkubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk \'{print $1}\')\nkubectl get svc -n kubernetes-dashboard\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("有证书dashboard")]),s._v(" "),a("p",[s._v("https://github.com/kubernetes/dashboard/releases")]),s._v(" "),a("p",[s._v("https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-rc1/aio/deploy/recommended.yaml")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('mkdir keys\ncd keys\n\n# 创建空白证书\nopenssl genrsa -out ca.key 2048\nopenssl req -new -x509 -key ca.key -out ca.crt -days 3650 -subj "/C=CN/ST=HB/L=WH/O=DM/OU=YPT/CN=CA"\n\n# 创建 dashboard 证书\n(umask 077; openssl genrsa -out dashboard.key 2048)\nopenssl req -new -key dashboard.key  -out dashboard.csr -subj "/O=zhixin/CN=dashboard"\nopenssl  x509 -req -in dashboard.csr -CA ca.crt -CAkey ca.key  -CAcreateserial -out dashboard.crt -days 3650\n\n\nkubectl create namespace kubernetes-dashboard\n\nkubectl create secret generic kubernetes-dashboard-certs -n kubernetes-dashboard --from-file=dashboard.crt=./dashboard.crt  --from-file=dashboard.key=./dashboard.key\nkubectl get secret -n kubernetes-dashboard |grep dashboard\n\nkubectl create serviceaccount kubernetes-dashboard -n kubernetes-dashboard\nkubectl get sa -n kubernetes-dashboard |grep kubernetes-dashboard\n\nkubectl create clusterrolebinding kubernetes-dashboard --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:kubernetes-dashboard\n\nkubectl get secret -n kubernetes-dashboard |grep dashboard\nkubectl describe secret kubernetes-dashboard-token-tptw4 -n kubernetes-dashboard\n\nkubectl apply -f recommended.yaml\nkubectl get svc -n kubernetes-dashboard\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("p",[s._v("删除dashboard")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("kubectl delete ns kubernetes-dashboard\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"_3-8-helm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-helm"}},[s._v("#")]),s._v(" 3.8.helm")]),s._v(" "),a("p",[s._v("https://helm.sh/docs/intro/install/")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo snap install helm --classic\nhelm repo add stable https://kubernetes-charts.storage.googleapis.com/\n# helm pull stable/stolon\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"_3-9-stolon-helm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-9-stolon-helm"}},[s._v("#")]),s._v(" 3.9.stolon - helm")]),s._v(" "),a("p",[s._v("https://hub.helm.sh/charts/stable/stolon")]),s._v(" "),a("p",[s._v("在rancher中提前配置好“storageClassName”和“PV”")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('helm pull stable/stolon\n\nvim value.yaml\n#########################\nimage:\n  repository: sorintlab/stolon\n  tag: v0.16.0-pg10\n  \n​````````````````````````\n  \npersistence:\n  enabled: true\n  storageClassName: "local-storage-class"\n  accessModes:\n  - ReadWriteOnce\n  size: 50Gi \n  \n​````````````````````````  \n  \nsuperuserUsername: "stolon"\nsuperuserPassword: "admin163"\nreplicationUsername: "repluser"\nreplicationPassword: "admin163"  \n#############################\n\nhelm install -n stolon my-stolon ./stolon\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("备注：")]),s._v(" "),a("p",[s._v("stolon的“--dry-run”可以“simulate an install”生成yml文件")]),s._v(" "),a("p",[s._v("helm install xxx-release-name ./stolon --dry-run")]),s._v(" "),a("p",[s._v("appendix")]),s._v(" "),a("p",[s._v("手动生成“StorageClass”和“PersistentVolume”")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("---\nkind: StorageClass\napiVersion: storage.k8s.io/v1\nmetadata:\n  name: local-storage\nprovisioner: kubernetes.io/no-provisioner\nvolumeBindingMode: WaitForFirstConsumer\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: stolonpv1\nspec:\n  capacity:\n    storage: 10Gi\n  accessModes:\n    - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Retain\n  storageClassName: sc\n  local:\n    path: /stolon\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - node01\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("p",[s._v("*通过helm安装不需要手动同步？？？？？？？？？？？？？？？")]),s._v(" "),a("p",[s._v("待定，需要测试一下")]),s._v(" "),a("p",[s._v("*如果按照stolon的示例，仅使用yml文件部署，需要初始化stolon，否则数据库不会同步")]),s._v(" "),a("p",[s._v("https://github.com/sorintlab/stolon/tree/master/examples/kubernetes")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("kubectl exec -it release-name-stolon-keeper-0 -- /bin/bash\nstolonctl  --cluster-name=release-name-stolon --store-backend=kubernetes --kube-resource-kind=configmap init\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("“--cluster-name”要去configmap里看一下，要对应上")]),s._v(" "),a("p",[s._v("stolon init 之后，pg的默认user，dbname和密码都重置了，重置为helm install时的配置，")]),s._v(" "),a("p",[s._v("数据的数据？")]),s._v(" "),a("p",[s._v("手动改掉pg的密码之后，stolon不能识别了！怎么办？")]),s._v(" "),a("h2",{attrs:{id:"_3-10-manage-k8s"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-10-manage-k8s"}},[s._v("#")]),s._v(" 3.10 manage k8s")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("windows")])]),s._v(" "),a("li",[a("p",[s._v("ubuntu")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -\n\ncat > /etc/apt/sources.list.d/kubernetes.list <<EOF\ndeb https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main\nEOF\n\napt-get update && apt-get install -y kubectl\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h1",{attrs:{id:"_4-command"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-command"}},[s._v("#")]),s._v(" 4.command")]),s._v(" "),a("h2",{attrs:{id:"_4-1-linux"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-linux"}},[s._v("#")]),s._v(" 4.1.linux")]),s._v(" "),a("p",[s._v("查看端口使用")]),s._v(" "),a("p",[s._v("netstat -ntpa")]),s._v(" "),a("p",[s._v("netstat -ntpl")]),s._v(" "),a("p",[s._v("高性能模式")]),s._v(" "),a("p",[s._v("apt-get install cpufrequtils")]),s._v(" "),a("p",[s._v("cpufreq-info")]),s._v(" "),a("p",[s._v("cpufreq-set -g performance")]),s._v(" "),a("p",[s._v("apt-get install sysfsutils")]),s._v(" "),a("p",[s._v("echo  -e 'devices/system/cpu/cpu0/cpufreq/scaling_governor = performance' /etc/sysfs.conf")]),s._v(" "),a("p",[s._v("修改端口")]),s._v(" "),a("p",[s._v("vim /etc/ssh/sshd_config")]),s._v(" "),a("p",[s._v("service ssh restart")]),s._v(" "),a("h2",{attrs:{id:"_4-2-docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-docker"}},[s._v("#")]),s._v(" 4.2.docker")]),s._v(" "),a("p",[s._v("docker 运维笔记")]),s._v(" "),a("p",[s._v("https://www.cnblogs.com/kevingrace/p/5715326.html")]),s._v(" "),a("p",[s._v("进入容器")]),s._v(" "),a("p",[s._v("docker exec -it [ID] /bin/bash")]),s._v(" "),a("p",[s._v("查看容器完整 command")]),s._v(" "),a("p",[s._v("docker ps -a --no-trunc")]),s._v(" "),a("p",[s._v("停止删除所有容器")]),s._v(" "),a("p",[s._v("docker stop $(docker ps -aq)")]),s._v(" "),a("p",[s._v("docker rm $(docker ps -aq)")]),s._v(" "),a("p",[s._v("批量删除镜像")]),s._v(" "),a("p",[s._v("docker image rm $(docker image ls -a -q)")]),s._v(" "),a("p",[s._v("docker rmi $(docker image ls -a -q)")]),s._v(" "),a("p",[s._v("导出导入镜像")]),s._v(" "),a("p",[s._v("docker save -o flannel.tar quay.io/coreos/flannel:v0.11.0-amd64")]),s._v(" "),a("p",[s._v("docker load < flannel.tar")]),s._v(" "),a("p",[s._v("修改容器为一直启动")]),s._v(" "),a("p",[s._v("docker container update --restart=always 容器名字")]),s._v(" "),a("h2",{attrs:{id:"_4-3-kubernetes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-kubernetes"}},[s._v("#")]),s._v(" 4.3.kubernetes")]),s._v(" "),a("p",[s._v("kubectl scale --current-replicas=2 --replicas=3 statefulset/ironman-stolon-keeper -n njupt-stolon")]),s._v(" "),a("p",[s._v("kubectl scale --current-replicas=2 --replicas=3 -n njupt-stolon deployment ironman-stolon-proxy")]),s._v(" "),a("p",[s._v('kubectl patch svc -n njupt-stolon ironman-stolon-proxy -p \'{"spec":{"type":"NodePort"}}\'')]),s._v(" "),a("p",[s._v("or https://www.jianshu.com/p/75af95641c91")]),s._v(" "),a("p",[s._v("kubectl expose deployment [xxxxxxxx] --type=NodePort")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/1591921126800-ab6f34cf-78ec-40ce-a88f-9d6d2040b395.png",alt:"image.png"}})]),s._v(" "),a("p",[s._v("pv状态转换")]),s._v(" "),a("p",[s._v("kubectl edit pv pgv3")]),s._v(" "),a("p",[s._v("删去spec.clainRef")]),s._v(" "),a("p",[s._v("released--\x3eavailable")]),s._v(" "),a("h1",{attrs:{id:"stolon"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#stolon"}},[s._v("#")]),s._v(" stolon")])])}),[],!1,null,null,null);e.default=t.exports}}]);