(window.webpackJsonp=window.webpackJsonp||[]).push([[281],{977:function(a,s,n){"use strict";n.r(s);var t=n(5),e=Object(t.a)({},(function(){var a=this,s=a.$createElement,n=a._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[n("h1",{attrs:{id:"死锁编码及定位分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#死锁编码及定位分析"}},[a._v("#")]),a._v(" 死锁编码及定位分析")]),a._v(" "),n("h2",{attrs:{id:"概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#概念"}},[a._v("#")]),a._v(" 概念")]),a._v(" "),n("p",[a._v("死锁是指两个或多个以上的进程在执行过程中，因争夺资源而造成一种互相等待的现象，若无外力干涉那他们都将无法推进下去。如果资源充足，进程的资源请求都能够得到满足，死锁出现的可能性就很低，否则就会因争夺有限的资源而陷入死锁。")]),a._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200318175441578.png",alt:"image-20200318175441578"}})]),a._v(" "),n("h2",{attrs:{id:"产生死锁的原因"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#产生死锁的原因"}},[a._v("#")]),a._v(" 产生死锁的原因")]),a._v(" "),n("ul",[n("li",[a._v("系统资源不足")]),a._v(" "),n("li",[a._v("进程运行推进的顺序不对")]),a._v(" "),n("li",[a._v("资源分配不当")])]),a._v(" "),n("h2",{attrs:{id:"死锁产生的四个必要条件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#死锁产生的四个必要条件"}},[a._v("#")]),a._v(" 死锁产生的四个必要条件")]),a._v(" "),n("ul",[n("li",[a._v("互斥\n"),n("ul",[n("li",[a._v("解决方法：把互斥的共享资源封装成可同时访问")])])]),a._v(" "),n("li",[a._v("占有且等待\n"),n("ul",[n("li",[a._v("解决方法：进程请求资源时，要求它不占有任何其它资源，也就是它必须一次性申请到所有的资源，这种方式会导致资源效率低。")])])]),a._v(" "),n("li",[a._v("非抢占式\n"),n("ul",[n("li",[a._v("解决方法：如果进程不能立即分配资源，要求它不占有任何其他资源，也就是只能够同时获得所有需要资源时，才执行分配操作")])])]),a._v(" "),n("li",[a._v("循环等待\n"),n("ul",[n("li",[a._v("解决方法：对资源进行排序，要求进程按顺序请求资源。")])])])]),a._v(" "),n("h2",{attrs:{id:"死锁代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#死锁代码"}},[a._v("#")]),a._v(" 死锁代码")]),a._v(" "),n("p",[a._v("我们创建了一个资源类，然后让两个线程分别持有自己的锁，同时在尝试获取别人的，就会出现死锁现象")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v('/**\n * 死锁小Demo\n * 死锁是指两个或多个以上的进程在执行过程中，\n * 因争夺资源而造成一种互相等待的现象，\n * 若无外力干涉那他们都将无法推进下去\n * @author: 陌溪\n * @create: 2020-03-18-17:58\n */\n\nimport java.util.concurrent.TimeUnit;\n\n/**\n * 资源类\n */\nclass HoldLockThread implements Runnable{\n\n    private String lockA;\n    private String lockB;\n\n    // 持有自己的锁，还想得到别人的锁\n\n    public HoldLockThread(String lockA, String lockB) {\n        this.lockA = lockA;\n        this.lockB = lockB;\n    }\n\n\n    @Override\n    public void run() {\n        synchronized (lockA) {\n            System.out.println(Thread.currentThread().getName() + "\\t 自己持有" + lockA + "\\t 尝试获取：" + lockB);\n\n            try {\n                TimeUnit.SECONDS.sleep(2);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n\n            synchronized (lockB) {\n                System.out.println(Thread.currentThread().getName() + "\\t 自己持有" + lockB + "\\t 尝试获取：" + lockA);\n            }\n        }\n    }\n}\npublic class DeadLockDemo {\n    public static void main(String[] args) {\n        String lockA = "lockA";\n        String lockB = "lockB";\n\n        new Thread(new HoldLockThread(lockA, lockB), "t1").start();\n\n        new Thread(new HoldLockThread(lockB, lockA), "t2").start();\n    }\n}\n')])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br"),n("span",{staticClass:"line-number"},[a._v("7")]),n("br"),n("span",{staticClass:"line-number"},[a._v("8")]),n("br"),n("span",{staticClass:"line-number"},[a._v("9")]),n("br"),n("span",{staticClass:"line-number"},[a._v("10")]),n("br"),n("span",{staticClass:"line-number"},[a._v("11")]),n("br"),n("span",{staticClass:"line-number"},[a._v("12")]),n("br"),n("span",{staticClass:"line-number"},[a._v("13")]),n("br"),n("span",{staticClass:"line-number"},[a._v("14")]),n("br"),n("span",{staticClass:"line-number"},[a._v("15")]),n("br"),n("span",{staticClass:"line-number"},[a._v("16")]),n("br"),n("span",{staticClass:"line-number"},[a._v("17")]),n("br"),n("span",{staticClass:"line-number"},[a._v("18")]),n("br"),n("span",{staticClass:"line-number"},[a._v("19")]),n("br"),n("span",{staticClass:"line-number"},[a._v("20")]),n("br"),n("span",{staticClass:"line-number"},[a._v("21")]),n("br"),n("span",{staticClass:"line-number"},[a._v("22")]),n("br"),n("span",{staticClass:"line-number"},[a._v("23")]),n("br"),n("span",{staticClass:"line-number"},[a._v("24")]),n("br"),n("span",{staticClass:"line-number"},[a._v("25")]),n("br"),n("span",{staticClass:"line-number"},[a._v("26")]),n("br"),n("span",{staticClass:"line-number"},[a._v("27")]),n("br"),n("span",{staticClass:"line-number"},[a._v("28")]),n("br"),n("span",{staticClass:"line-number"},[a._v("29")]),n("br"),n("span",{staticClass:"line-number"},[a._v("30")]),n("br"),n("span",{staticClass:"line-number"},[a._v("31")]),n("br"),n("span",{staticClass:"line-number"},[a._v("32")]),n("br"),n("span",{staticClass:"line-number"},[a._v("33")]),n("br"),n("span",{staticClass:"line-number"},[a._v("34")]),n("br"),n("span",{staticClass:"line-number"},[a._v("35")]),n("br"),n("span",{staticClass:"line-number"},[a._v("36")]),n("br"),n("span",{staticClass:"line-number"},[a._v("37")]),n("br"),n("span",{staticClass:"line-number"},[a._v("38")]),n("br"),n("span",{staticClass:"line-number"},[a._v("39")]),n("br"),n("span",{staticClass:"line-number"},[a._v("40")]),n("br"),n("span",{staticClass:"line-number"},[a._v("41")]),n("br"),n("span",{staticClass:"line-number"},[a._v("42")]),n("br"),n("span",{staticClass:"line-number"},[a._v("43")]),n("br"),n("span",{staticClass:"line-number"},[a._v("44")]),n("br"),n("span",{staticClass:"line-number"},[a._v("45")]),n("br"),n("span",{staticClass:"line-number"},[a._v("46")]),n("br"),n("span",{staticClass:"line-number"},[a._v("47")]),n("br"),n("span",{staticClass:"line-number"},[a._v("48")]),n("br"),n("span",{staticClass:"line-number"},[a._v("49")]),n("br"),n("span",{staticClass:"line-number"},[a._v("50")]),n("br"),n("span",{staticClass:"line-number"},[a._v("51")]),n("br"),n("span",{staticClass:"line-number"},[a._v("52")]),n("br"),n("span",{staticClass:"line-number"},[a._v("53")]),n("br"),n("span",{staticClass:"line-number"},[a._v("54")]),n("br")])]),n("p",[a._v("运行结果，main线程无法结束")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v("t1\t 自己持有lockA\t 尝试获取：lockB\nt2\t 自己持有lockB\t 尝试获取：lockA\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br")])]),n("h2",{attrs:{id:"如何排查死锁"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何排查死锁"}},[a._v("#")]),a._v(" 如何排查死锁")]),a._v(" "),n("p",[a._v("当我们出现死锁的时候，首先需要使用jps命令查看运行的程序")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v("jps -l\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br")])]),n("p",[a._v("我们能看到DeadLockDemo这个类，一直在运行")]),a._v(" "),n("p",[n("img",{attrs:{src:"/images/image-20200318181504703.png",alt:"image-20200318181504703"}})]),a._v(" "),n("p",[a._v("在使用jstack查看堆栈信息")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v("jstack  7560   # 后面参数是 jps输出的该类的pid\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br")])]),n("p",[a._v("得到的结果")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v('Found one Java-level deadlock:\n=============================\n"t2":\n  waiting to lock monitor 0x000000001cfc0de8 (object 0x000000076b696e80, a java.lang.String),\n  which is held by "t1"\n"t1":\n  waiting to lock monitor 0x000000001cfc3728 (object 0x000000076b696eb8, a java.lang.String),\n  which is held by "t2"\n\nJava stack information for the threads listed above:\n===================================================\n"t2":\n        at com.moxi.interview.study.Lock.HoldLockThread.run(DeadLockDemo.java:42)\n        - waiting to lock <0x000000076b696e80> (a java.lang.String)\n        - locked <0x000000076b696eb8> (a java.lang.String)\n        at java.lang.Thread.run(Thread.java:745)\n"t1":\n        at com.moxi.interview.study.Lock.HoldLockThread.run(DeadLockDemo.java:42)\n        - waiting to lock <0x000000076b696eb8> (a java.lang.String)\n        - locked <0x000000076b696e80> (a java.lang.String)\n        at java.lang.Thread.run(Thread.java:745)\n\nFound 1 deadlock.\n')])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br"),n("span",{staticClass:"line-number"},[a._v("7")]),n("br"),n("span",{staticClass:"line-number"},[a._v("8")]),n("br"),n("span",{staticClass:"line-number"},[a._v("9")]),n("br"),n("span",{staticClass:"line-number"},[a._v("10")]),n("br"),n("span",{staticClass:"line-number"},[a._v("11")]),n("br"),n("span",{staticClass:"line-number"},[a._v("12")]),n("br"),n("span",{staticClass:"line-number"},[a._v("13")]),n("br"),n("span",{staticClass:"line-number"},[a._v("14")]),n("br"),n("span",{staticClass:"line-number"},[a._v("15")]),n("br"),n("span",{staticClass:"line-number"},[a._v("16")]),n("br"),n("span",{staticClass:"line-number"},[a._v("17")]),n("br"),n("span",{staticClass:"line-number"},[a._v("18")]),n("br"),n("span",{staticClass:"line-number"},[a._v("19")]),n("br"),n("span",{staticClass:"line-number"},[a._v("20")]),n("br"),n("span",{staticClass:"line-number"},[a._v("21")]),n("br"),n("span",{staticClass:"line-number"},[a._v("22")]),n("br"),n("span",{staticClass:"line-number"},[a._v("23")]),n("br")])]),n("p",[a._v("通过查看最后一行，我们看到  Found 1 deadlock，即存在一个死锁")])])}),[],!1,null,null,null);s.default=e.exports}}]);